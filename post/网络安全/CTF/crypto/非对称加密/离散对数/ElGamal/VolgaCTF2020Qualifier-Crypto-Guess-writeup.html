<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="">
<meta name="description"
    content="VolgaCTF2020Qualifier Crypto Guess writeup 上周末玩了下VolgaCTF 2020 Qualifier(https://ctftime.org/event/933), 只做了几道密码题，因为其他题都没有思路T_T 。整体感觉俄罗斯人的脑洞很大，数学功底很好。其中有一道ElGamal相关的密码题，虽然没感觉在现实中有什么实际用途，但是学到了一些重要的性质。
我的解法比较简单，但是好像是非预期解。赛后，在这篇wp里发现了一个更完美的解法：标准解法的wp(https://www.josephsurin.me/posts/2020-03-30-volgactf-2020-qualifier-writeups#guess) 。我会在第三节记录下我的解法，在第四节简单翻译下标准解法。
一、题目信息  Guess
Try to guess all encrypted bits and get your reward!
server.py(https://q.2020.volgactf.ru/files/541eeaf9fdf2d86fbe87def09be7e560/server.py)
nc guess.q.2020.volgactf.ru 7777
Your team has solved this task on Mar 28 at 21:20 UTC.
179 other teams have managed to do the same.
This task has been rated by 73 teams. The average rating is 3.99 (5.00 max).
 server.py如下：
#!/usr/bin/python # -*- coding: utf-8 -*- from __future__ import print_function from Crypto." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/CTF/crypto/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86/%E7%A6%BB%E6%95%A3%E5%AF%B9%E6%95%B0/ElGamal/VolgaCTF2020Qualifier-Crypto-Guess-writeup.html" />


<title>
    
    VolgaCTF2020Qualifier Crypto Guess writeup :: welcome to st0n3&#39;s blog 
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.de959d61dd13c2cd41136acd491ffb0749779e1afe37b1fed6d5cba0b7e1938d.css">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#252627"><meta itemprop="name" content="VolgaCTF2020Qualifier Crypto Guess writeup">
<meta itemprop="description" content="VolgaCTF2020Qualifier Crypto Guess writeup 上周末玩了下VolgaCTF 2020 Qualifier(https://ctftime.org/event/933), 只做了几道密码题，因为其他题都没有思路T_T 。整体感觉俄罗斯人的脑洞很大，数学功底很好。其中有一道ElGamal相关的密码题，虽然没感觉在现实中有什么实际用途，但是学到了一些重要的性质。
我的解法比较简单，但是好像是非预期解。赛后，在这篇wp里发现了一个更完美的解法：标准解法的wp(https://www.josephsurin.me/posts/2020-03-30-volgactf-2020-qualifier-writeups#guess) 。我会在第三节记录下我的解法，在第四节简单翻译下标准解法。
一、题目信息  Guess
Try to guess all encrypted bits and get your reward!
server.py(https://q.2020.volgactf.ru/files/541eeaf9fdf2d86fbe87def09be7e560/server.py)
nc guess.q.2020.volgactf.ru 7777
Your team has solved this task on Mar 28 at 21:20 UTC.
179 other teams have managed to do the same.
This task has been rated by 73 teams. The average rating is 3.99 (5.00 max).
 server.py如下：
#!/usr/bin/python # -*- coding: utf-8 -*- from __future__ import print_function from Crypto.">
<meta itemprop="datePublished" content="2020-04-01T05:53:00+00:00" />
<meta itemprop="dateModified" content="2020-04-01T05:53:00+00:00" />
<meta itemprop="wordCount" content="927">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="VolgaCTF2020Qualifier Crypto Guess writeup"/>
<meta name="twitter:description" content="VolgaCTF2020Qualifier Crypto Guess writeup 上周末玩了下VolgaCTF 2020 Qualifier(https://ctftime.org/event/933), 只做了几道密码题，因为其他题都没有思路T_T 。整体感觉俄罗斯人的脑洞很大，数学功底很好。其中有一道ElGamal相关的密码题，虽然没感觉在现实中有什么实际用途，但是学到了一些重要的性质。
我的解法比较简单，但是好像是非预期解。赛后，在这篇wp里发现了一个更完美的解法：标准解法的wp(https://www.josephsurin.me/posts/2020-03-30-volgactf-2020-qualifier-writeups#guess) 。我会在第三节记录下我的解法，在第四节简单翻译下标准解法。
一、题目信息  Guess
Try to guess all encrypted bits and get your reward!
server.py(https://q.2020.volgactf.ru/files/541eeaf9fdf2d86fbe87def09be7e560/server.py)
nc guess.q.2020.volgactf.ru 7777
Your team has solved this task on Mar 28 at 21:20 UTC.
179 other teams have managed to do the same.
This task has been rated by 73 teams. The average rating is 3.99 (5.00 max).
 server.py如下：
#!/usr/bin/python # -*- coding: utf-8 -*- from __future__ import print_function from Crypto."/>




<meta property="article:published_time" content="2020-04-01 05:53:00 &#43;0000 UTC" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/st0n3</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/aboutme.html">About</a></li><li><a href="/post.html">Blog</a></li><li><a href="/hackerbot">Hackerbot</a></li><li><a href="/skill_tree/">SkillTree</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/CTF/crypto/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86/%E7%A6%BB%E6%95%A3%E5%AF%B9%E6%95%B0/ElGamal/VolgaCTF2020Qualifier-Crypto-Guess-writeup.html">VolgaCTF2020Qualifier Crypto Guess writeup</a></h2>

            

            <div class="post-content">
                <h1 id="volgactf2020qualifier-crypto-guess-writeup">VolgaCTF2020Qualifier Crypto Guess writeup</h1>
<p>上周末玩了下<a href="https://ctftime.org/event/933">VolgaCTF 2020 Qualifier(https://ctftime.org/event/933)</a>, 只做了几道密码题，因为其他题都没有思路T_T 。整体感觉俄罗斯人的脑洞很大，数学功底很好。其中有一道ElGamal相关的密码题，虽然没感觉在现实中有什么实际用途，但是学到了一些重要的性质。</p>
<p>我的解法比较简单，但是好像是非预期解。赛后，在这篇wp里发现了一个更完美的解法：<a href="https://www.josephsurin.me/posts/2020-03-30-volgactf-2020-qualifier-writeups#guess">标准解法的wp(https://www.josephsurin.me/posts/2020-03-30-volgactf-2020-qualifier-writeups#guess)</a> 。我会在第三节记录下我的解法，在第四节简单翻译下标准解法。</p>
<h2 id="一题目信息">一、题目信息</h2>
<blockquote>
<p>Guess</p>
<p>Try to guess all encrypted bits and get your reward!</p>
<p><a href="https://q.2020.volgactf.ru/files/541eeaf9fdf2d86fbe87def09be7e560/server.py">server.py(https://q.2020.volgactf.ru/files/541eeaf9fdf2d86fbe87def09be7e560/server.py)</a></p>
<p>nc guess.q.2020.volgactf.ru 7777</p>
<p>Your team has solved this task on Mar 28 at 21:20 UTC.</p>
<p>179 other teams have managed to do the same.</p>
<p>This task has been rated by 73 teams. The average rating is 3.99 (5.00 max).</p>
</blockquote>
<p>server.py如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#!/usr/bin/python</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>
<span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> print_function
<span style="color:#f92672">from</span> Crypto.PublicKey <span style="color:#f92672">import</span> ElGamal
<span style="color:#f92672">from</span> Crypto <span style="color:#f92672">import</span> Random
<span style="color:#f92672">from</span> flag_file <span style="color:#f92672">import</span> flag
<span style="color:#f92672">import</span> Crypto.Random.random
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> sys


<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Communication utils
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_message</span>():
    <span style="color:#66d9ef">return</span> sys<span style="color:#f92672">.</span>stdin<span style="color:#f92672">.</span>readline()


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_message</span>(message):
    sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;{0}</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(message))
    sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>flush()


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">eprint</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
    <span style="color:#66d9ef">print</span>(<span style="color:#f92672">*</span>args, file<span style="color:#f92672">=</span>sys<span style="color:#f92672">.</span>stderr, <span style="color:#f92672">**</span>kwargs)


<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Algebra
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">kronecker</span>(x, p):
    q <span style="color:#f92672">=</span> (p <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
    <span style="color:#66d9ef">return</span> pow(x, q, p)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">findQNR</span>(p):
    r <span style="color:#f92672">=</span> Crypto<span style="color:#f92672">.</span>Random<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randrange(<span style="color:#ae81ff">2</span>, p <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">while</span> kronecker(r, p) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
        r <span style="color:#f92672">=</span> Crypto<span style="color:#f92672">.</span>Random<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randrange(<span style="color:#ae81ff">2</span>, p<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">return</span> r


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">findQR</span>(p):
    r <span style="color:#f92672">=</span> Crypto<span style="color:#f92672">.</span>Random<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randrange(<span style="color:#ae81ff">2</span>, p <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) 
    <span style="color:#66d9ef">return</span> pow(r, <span style="color:#ae81ff">2</span>, p)


<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Main
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">while</span> True:
            key <span style="color:#f92672">=</span> ElGamal<span style="color:#f92672">.</span>generate(<span style="color:#ae81ff">512</span>, Random<span style="color:#f92672">.</span>new()<span style="color:#f92672">.</span>read)
            runs <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
            successful_tries <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

            send_message(<span style="color:#e6db74">&#39;(y, p) = ({0}, {1})&#39;</span><span style="color:#f92672">.</span>format(key<span style="color:#f92672">.</span>y, key<span style="color:#f92672">.</span>p))

            <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> xrange(runs):
                plaintexts <span style="color:#f92672">=</span> dict()
                plaintexts[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> findQNR(key<span style="color:#f92672">.</span>p)
                plaintexts[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> findQR(key<span style="color:#f92672">.</span>p)

                challenge_bit <span style="color:#f92672">=</span> Crypto<span style="color:#f92672">.</span>Random<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randrange(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>)
                eprint(<span style="color:#e6db74">&#39;[{0}][INFO] Bit {1} was generated.&#39;</span><span style="color:#f92672">.</span>format(time<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">. %H:%M:%S&#34;</span>), challenge_bit))
                r <span style="color:#f92672">=</span> Crypto<span style="color:#f92672">.</span>Random<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randrange(<span style="color:#ae81ff">1</span>,key<span style="color:#f92672">.</span>p<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) 
                challenge <span style="color:#f92672">=</span> key<span style="color:#f92672">.</span>encrypt(plaintexts[challenge_bit], r)

                <span style="color:#75715e"># Send challenge</span>
                send_message(challenge)

                <span style="color:#75715e"># Receive challenge_bit</span>
                received_bit <span style="color:#f92672">=</span> read_message()
                eprint(<span style="color:#e6db74">&#39;[{0}][INFO] Bit {1} was received.&#39;</span><span style="color:#f92672">.</span>format(time<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">. %H:%M:%S&#34;</span>), received_bit))
                <span style="color:#66d9ef">if</span> int(received_bit) <span style="color:#f92672">==</span> challenge_bit:
                    successful_tries <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
                    eprint(successful_tries)
                    
            <span style="color:#66d9ef">if</span> successful_tries <span style="color:#f92672">==</span> runs:
                send_message(flag)

    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> ex:
        send_message(<span style="color:#e6db74">&#39;Something must have gone very, very wrong...&#39;</span>)
        eprint(<span style="color:#e6db74">&#39;[{0}][ERROR] {1}&#39;</span><span style="color:#f92672">.</span>format(time<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">. %H:%M:%S&#34;</span>), ex))

    <span style="color:#66d9ef">finally</span>:
        <span style="color:#66d9ef">pass</span>
</code></pre></div><p>这个题目执行了1000次ElGamal加密算法，告知了我们ElGamal密码体制中的y, p, 及每次加密的结果y1, y2。每次加密时使用两种明文，第一种是根据findQNR函数生成，第二种是根据findQR函数生成。选手如果可以正确猜测每次使用的是哪一种明文，则可以获得flag。</p>
<h2 id="二elgamal">二、ElGamal</h2>
<ul>
<li>
<p>CTF wiki描述的很清楚了, <a href="https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/discrete-log/elgamal-zh/">ctfwiki(https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/discrete-log/elgamal-zh/)</a></p>
</li>
<li>
<p>不过可能会有一些背景知识忘记了，我在b站突击补习了一下。</p>
<ul>
<li><a href="https://www.bilibili.com/video/BV1BW411n7gw?p=56">离散数学（全）-北京大学(https://www.bilibili.com/video/BV1BW411n7gw?p=56)</a></li>
<li><a href="https://www.bilibili.com/video/BV1MW411t7gZ?p=19">【国家级精品课】&mdash;-密码学（ 解放军信息工程大学）: https://www.bilibili.com/video/BV1MW411t7gZ?p=19</a></li>
</ul>
</li>
</ul>
<p>在ElGamal密码体制中，$g^k \equiv y \bmod p$, 其中私钥为 {k}，公钥为 {p,g,y} 。</p>
<h2 id="三我的解法-基于欧拉定理或称费马小定理及cryptopublickeyelgamal的特性">三、我的解法: 基于欧拉定理(或称费马小定理)及Crypto.PublicKey.ElGamal的特性</h2>
<p>我们先用数学语言描述一下我们要解决的问题：</p>
<p>已知y, p, y1, y2及以下关系
$$
\begin{align}
&amp; y \equiv g^k \bmod p <br>
\newline &amp; y1 \equiv g^r \bmod p
\newline &amp; y2 \equiv my^r \bmod p
\end{align}
$$</p>
<p>其中m有两种生成方式</p>
<ol>
<li>findQNR: 生成一个随机数r1, 如果生成了一个随机数r1满足$r_1^{\frac{p-1}{2}}\neq 1 \bmod p$ ，则可以取r1: $m_1=r_1$</li>
<li>findQR: 生成一个随机数r2, $m_2=r_2^2$</li>
</ol>
<p>我们需要根据已知信息，判断出来m是哪种生成方式。</p>
<p>其实我不理解为什么两个函数名，一个叫findQNR, 一个叫findQR。但是我发现了一个性质</p>
<p>$$
\begin{align}
&amp; m_1 ^ {\frac{p-1}{2}}\neq 1 \bmod p
\newline &amp; m_2 ^ {\frac{p-1}{2}}\equiv (r_2^2)^{\frac{p-1}{2}} \equiv r_2^{p-1} \equiv r_2^{\phi(p)}  \equiv 1   \bmod p \tag{1}
\end{align}
$$</p>
<p>根据<a href="https://baike.baidu.com/item/%E6%AC%A7%E6%8B%89%E5%AE%9A%E7%90%86">欧拉定理(https://baike.baidu.com/item/%E6%AC%A7%E6%8B%89%E5%AE%9A%E7%90%86)</a>，(1)式是一直成立的。</p>
<p>所以我们可以<strong>尝试</strong>将这个性质推广到y2上。</p>
<p>对 m1:
$$
\begin{align}
&amp; y_2 ^ {\frac{p-1}{2}} \equiv (m_1y^r )^ {\frac{p-1}{2}} \equiv (m_1)^ {\frac{p-1}{2}} (y^r) ^ {\frac{p-1}{2}} \equiv 1 \bmod p \tag{2} <br>
\newline &amp; \iff
\newline &amp; ay^{r\frac{p-1}{2}} \equiv ag^{kr\frac{p-1}{2}}  \equiv 1 \bmod p (a=m_1^{\frac{p-1}{2}}\bmod, a \neq 1)
\newline &amp; \iff
\newline &amp; g^{kr\frac{p-1}{2}}  \equiv a^{-1} \bmod p
\end{align}
$$</p>
<p>因为p是一个很大的素数，所以由$Z_p^*$的生成元g的$kr\frac{p-1}{2}$次方，与a关于p的逆 同模，即使计算1000次，也是小概率事件的。所以我们可以大胆假设(2)式成立的概率是非常低的。</p>
<p>对 m2:
$$
\begin{align}
&amp; y_2 ^ {\frac{p-1}{2}} \equiv (m_2y^r )^ {\frac{p-1}{2}} \equiv (m_2)^ {\frac{p-1}{2}} (y^r) ^ {\frac{p-1}{2}} \equiv 1 \bmod p
\newline &amp; \iff
\newline &amp; (y^r) ^ {\frac{p-1}{2}} \equiv 1 \bmod p  \tag{3}
\end{align}
$$</p>
<p>在查看python的Crypto.PublicKey.ElGamal库时，我发现ElGamal的p选取规则是p=2q+1, 其中q是一个大素数。（这是为了防止p-1完全由小素数因子构成，受到另一种攻击）</p>
<p>这个特性给我们的计算带来了一些便利。我们可以基于这个特性，继续推理(3)式
$$
\begin{align}
&amp; (3)式 \iff (y^r) ^ q \equiv g^{rqk} \equiv 1 \bmod p  \tag{4} \iff k或r是偶数，或g是某数的平方
\end{align}
$$</p>
<p>因为g和k在1000次循环中都是固定的，而且k的生成方式是完全随机的， 因此可以认为大约有50%的概率(4)式成立</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">obj<span style="color:#f92672">.</span>x<span style="color:#f92672">=</span>number<span style="color:#f92672">.</span>getRandomRange(<span style="color:#ae81ff">2</span>, obj<span style="color:#f92672">.</span>p<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, randfunc)
</code></pre></div><p>至此我们获得了一种方法，有50%的概率可以区分明文是使用哪种方式生成的。</p>
<p>即如果k是偶数，则接下来的1000次计算中，$y_2^{\frac{p-1}{2}} \equiv 1 \bmod p$成立意味着明文由findQR生成，反之，明文由findQNR函数生成。</p>
<p>代码如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">solve</span>():
    pattern_y_p <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">&#34;\(y, p\) = \(([0-9]+), ([0-9]+)\)&#34;</span>)
    pattern_y1_y2 <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">&#34;\(([0-9]+)L, ([0-9]+)L\)&#34;</span>)

    r <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;guess.q.2020.volgactf.ru&#34;</span>, <span style="color:#ae81ff">7777</span>)
    <span style="color:#75715e"># r = process([&#34;python&#34;, &#34;server.py&#34;])</span>
    match <span style="color:#f92672">=</span> pattern_y_p<span style="color:#f92672">.</span>search(r<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>strip())
    y, p <span style="color:#f92672">=</span> int(match<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">1</span>)), int(match<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">2</span>))
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1000</span>):
        <span style="color:#66d9ef">print</span>(i)
        recv <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>recvline()
        <span style="color:#75715e"># print(recv)</span>
        match <span style="color:#f92672">=</span> pattern_y1_y2<span style="color:#f92672">.</span>search(recv<span style="color:#f92672">.</span>strip())
        y1, y2 <span style="color:#f92672">=</span> int(match<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">1</span>)), int(match<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">2</span>))
        <span style="color:#66d9ef">if</span> pow(y2, (p <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, p) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
            r<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#34;1&#34;</span>)
        <span style="color:#66d9ef">else</span>:
            r<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#34;0&#34;</span>)

    <span style="color:#66d9ef">print</span>(r<span style="color:#f92672">.</span>recvline())
    <span style="color:#66d9ef">print</span>(r<span style="color:#f92672">.</span>recvline())
    <span style="color:#66d9ef">print</span>(r<span style="color:#f92672">.</span>recvline())
</code></pre></div><p>总结这种方法，想起来比较简单，缺点是</p>
<ol>
<li>只有50%的概率成立</li>
<li>完全没有利用y1</li>
</ol>
<h2 id="四准确解法-基于欧拉判别法eulers-criterion或二次剩余特性">四、准确解法: 基于欧拉判别法(Euler&rsquo;s Criterion)或二次剩余特性</h2>
<p>这一节基本是这篇文章的翻译：<a href="https://www.josephsurin.me/posts/2020-03-30-volgactf-2020-qualifier-writeups#guess">标准解法的wp(https://www.josephsurin.me/posts/2020-03-30-volgactf-2020-qualifier-writeups#guess)</a></p>
<p>吃了没文化的亏，作者认识到findQNR函数中使用了<a href="https://zh.wikipedia.org/wiki/%E6%AC%A7%E6%8B%89%E5%87%86%E5%88%99">欧拉判别法(https://zh.wikipedia.org/wiki/%E6%AC%A7%E6%8B%89%E5%87%86%E5%88%99)</a>, 来寻找一个随机数，使这个随机数是模p的二次剩余。</p>
<p><a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E6%AC%A1%E5%89%A9%E4%BD%99">二次剩余(https://zh.wikipedia.org/wiki/%E4%BA%8C%E6%AC%A1%E5%89%A9%E4%BD%99)</a>是指X的平方除以p得到的余数。</p>
<p>当存在某个${\displaystyle X}，{\displaystyle X^{2}\equiv d{\pmod {p}}}$ 成立时，称“ d是模p的二次剩余”</p>
<p>当对任意 ${\displaystyle X}， {\displaystyle X^{2}\equiv d{\pmod {p}}}$ 不成立时，称“d是模 p的二次非剩余”</p>
<p>欧拉判别法描述了这样一个性质, 若p是奇质数且p不能整除d，则：</p>
<p>d是模p的二次剩余当且仅当：
$$
{\displaystyle d^{\frac {p-1}{2}}\equiv 1{\pmod {p}}}
$$
d是模p的非二次剩余当且仅当：
$$
{\displaystyle d^{\frac {p-1}{2}}\equiv -1{\pmod {p}}}
$$</p>
<p>因此在这个题目中，findQNR函数是寻找一个模p的二次非剩余m1， 而findQR是生成一个模p的二次剩余m2。</p>
<p>我们可以根据二次剩余的性质来解这个题：
已知y, p, y1, y2及以下关系
$$
\begin{align}
&amp; y \equiv g^k \bmod p <br>
\newline &amp; y1 \equiv g^r \bmod p
\newline &amp; y2 \equiv my^r \bmod p
\end{align}
$$</p>
<ul>
<li>如果y是二次剩余，则y2是否是二次剩余 等价于 m是否是二次剩余</li>
<li>如果y不是二次剩余， 因为$y^r\equiv(g^k)^r\equiv(g^r)^k\equiv y_1^k \bmod p$， 所以
<ul>
<li>如果y1是二次剩余，则y2是否是二次剩余 等价于 m是否是二次剩余</li>
<li>如果y1是二次非剩余，则y2是否是二次剩余 等价于 m是否是二次非剩余</li>
</ul>
</li>
</ul>
<p>amazing!</p>
<p>作者的代码如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> remote

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ec</span>(x, p):
    q <span style="color:#f92672">=</span> (p <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
    <span style="color:#66d9ef">return</span> pow(x, q, p)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">qr</span>(x, p):
    <span style="color:#66d9ef">return</span> ec(x, p) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>

conn <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;guess.q.2020.volgactf.ru&#39;</span>, <span style="color:#ae81ff">7777</span>)

y, p <span style="color:#f92672">=</span> map(int, conn<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;= (&#39;</span>)[<span style="color:#ae81ff">1</span>][:<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;, &#39;</span>))

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1000</span>):
    c1, c2 <span style="color:#f92672">=</span> eval(conn<span style="color:#f92672">.</span>recvline())

    b <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> qr(y, p):
        <span style="color:#66d9ef">if</span> qr(c2, p):
            b <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span>
        <span style="color:#66d9ef">else</span>:
            b <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">if</span> qr(c1, p):
            <span style="color:#66d9ef">if</span> qr(c2, p):
                b <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span>
            <span style="color:#66d9ef">else</span>:
                b <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span>
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">if</span> qr(c2, p):
                b <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span>
            <span style="color:#66d9ef">else</span>:
                b <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span>
    conn<span style="color:#f92672">.</span>sendline(b)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;challenge&#39;</span>, i)
<span style="color:#66d9ef">print</span>(conn<span style="color:#f92672">.</span>recvline())
</code></pre></div><h2 id="五扩展">五、扩展</h2>
<h3 id="1-基于cryptopublickeyelgamal库的优化">1. 基于Crypto.PublicKey.ElGamal库的优化</h3>
<p>在写本文时，我发现了一个新的性质。</p>
<p>翻阅Crypto.PublicKey.ElGamal源码，我发现g就是关于p的二次剩余</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">obj<span style="color:#f92672">.</span>g <span style="color:#f92672">=</span> pow(number<span style="color:#f92672">.</span>getRandomRange(<span style="color:#ae81ff">2</span>, obj<span style="color:#f92672">.</span>p, randfunc), <span style="color:#ae81ff">2</span>, obj<span style="color:#f92672">.</span>p)
</code></pre></div><p>这个发现无论是对我的解法，还是第二种解法，都有很大帮助。</p>
<ul>
<li>对我的解法来说，会将解题失败的概率限制在$1-(1-P_r(m_1^\frac{1-p}{2}\equiv 1\bmod p))^{1000}$</li>
<li>对于二次剩余解法，会将问题直接简化成：y2是否是二次剩余 等价于 m是否是二次剩余</li>
</ul>
<p>有兴趣的读者可以继续推理下</p>
<h3 id="2-其他性质">2. 其他性质</h3>
<blockquote>
<p>Crypto.PublicKey.ElGamal库中，g可以生成一个q阶的循环群</p>
</blockquote>
<p>同样是刚刚那段代码，有一个注释称，g可以生成一个q阶的循环群</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Choose a square residue; it will generate a cyclic group of order q.</span>
obj<span style="color:#f92672">.</span>g <span style="color:#f92672">=</span> pow(number<span style="color:#f92672">.</span>getRandomRange(<span style="color:#ae81ff">2</span>, obj<span style="color:#f92672">.</span>p, randfunc), <span style="color:#ae81ff">2</span>, obj<span style="color:#f92672">.</span>p)
</code></pre></div><p>另外，该库还限制了g与p-1的一些关系。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">while</span> <span style="color:#ae81ff">1</span>:
    <span style="color:#75715e"># Choose a square residue; it will generate a cyclic group of order q.</span>
    obj<span style="color:#f92672">.</span>g <span style="color:#f92672">=</span> pow(number<span style="color:#f92672">.</span>getRandomRange(<span style="color:#ae81ff">2</span>, obj<span style="color:#f92672">.</span>p, randfunc), <span style="color:#ae81ff">2</span>, obj<span style="color:#f92672">.</span>p)

    <span style="color:#75715e"># We must avoid g=2 because of Bleichenbacher&#39;s attack described</span>
    <span style="color:#75715e"># in &#34;Generating ElGamal signatures without knowning the secret key&#34;,</span>
    <span style="color:#75715e"># 1996</span>
    <span style="color:#66d9ef">if</span> obj<span style="color:#f92672">.</span>g <span style="color:#f92672">in</span> (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>):
        <span style="color:#66d9ef">continue</span>

    <span style="color:#75715e"># Discard g if it divides p-1 because of the attack described</span>
    <span style="color:#75715e"># in Note 11.67 (iii) in HAC</span>
    <span style="color:#66d9ef">if</span> (obj<span style="color:#f92672">.</span>p <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> obj<span style="color:#f92672">.</span>g <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">continue</span>

    <span style="color:#75715e"># g^{-1} must not divide p-1 because of Khadir&#39;s attack</span>
    <span style="color:#75715e"># described in &#34;Conditions of the generator for forging ElGamal</span>
    <span style="color:#75715e"># signature&#34;, 2011</span>
    ginv <span style="color:#f92672">=</span> number<span style="color:#f92672">.</span>inverse(obj<span style="color:#f92672">.</span>g, obj<span style="color:#f92672">.</span>p)
    <span style="color:#66d9ef">if</span> (obj<span style="color:#f92672">.</span>p <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> ginv <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">continue</span>

    <span style="color:#75715e"># Found</span>
    <span style="color:#66d9ef">break</span>
</code></pre></div><p>g可以生成关于p的循环群好理解，我们可以简单证明这个循环群的阶数是q如下：</p>
<p>$$
\begin{align}
&amp; g^1 \equiv g \bmod p
\\ &amp; g^q \equiv r^{2q} \equiv 1 \bmod p
\end{align}
$$</p>
<h2 id="六参考资料">六、参考资料</h2>
<ul>
<li><a href="https://www.josephsurin.me/posts/2020-03-30-volgactf-2020-qualifier-writeups#guess">标准解法的wp(https://www.josephsurin.me/posts/2020-03-30-volgactf-2020-qualifier-writeups#guess)</a></li>
<li><a href="https://ctftime.org/event/933">VolgaCTF 2020 Qualifier(https://ctftime.org/event/933)</a></li>
<li><a href="https://www.bilibili.com/video/BV1BW411n7gw?p=56">离散数学（全）-北京大学(https://www.bilibili.com/video/BV1BW411n7gw?p=56)</a></li>
<li><a href="https://www.bilibili.com/video/BV1MW411t7gZ?p=19">【国家级精品课】&mdash;-密码学（ 解放军信息工程大学）(https://www.bilibili.com/video/BV1MW411t7gZ?p=19)</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E6%AC%A7%E6%8B%89%E5%87%86%E5%88%99">欧拉判别法(https://zh.wikipedia.org/wiki/%E6%AC%A7%E6%8B%89%E5%87%86%E5%88%99)</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E6%AC%A1%E5%89%A9%E4%BD%99">二次剩余(https://zh.wikipedia.org/wiki/%E4%BA%8C%E6%AC%A1%E5%89%A9%E4%BD%99)</a></li>
<li><a href="https://baike.baidu.com/item/%E6%AC%A7%E6%8B%89%E5%AE%9A%E7%90%86">欧拉定理(https://baike.baidu.com/item/%E6%AC%A7%E6%8B%89%E5%AE%9A%E7%90%86)</a></li>
<li><a href="https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/discrete-log/elgamal-zh/">ctfwiki(https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/discrete-log/elgamal-zh/)</a></li>
</ul>

            </div>
        </article>

        <hr />

        <div class="post-info">
  			</div>

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
            <span></span>
            <span> <a href="/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/st0n3">st0n3</a></span>
            <span>Based on <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      extensions: ["tex2jax.js"],
      
      jax: ["input/TeX", "output/CommonHTML"],
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
      },
      "HTML-CSS": { fonts: ["TeX"] },
      displayAlign: "left"
    });
  </script>

<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_CHTML"></script>


</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.4c3fb12a087ceed4a52cb5d57068a9795c7069617a01ca70f788052ad66e1791779e6c72686e1dc0ca13dc03b0203204b6566bb0dd1ee80de2b7ff4d8fe53db2.js" integrity="sha512-TD&#43;xKgh87tSlLLXVcGipeVxwaWF6Acpw94gFKtZuF5F3nmxyaG4dwMoT3AOwIDIEtlZrsN0e6A3it/9Nj&#43;U9sg=="></script>



    </body>
</html>
