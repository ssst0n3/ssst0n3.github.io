<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="">
<meta name="description"
    content="tags: container,docker,源码分析 docker 创建oci运行时配置 源码分析 1. 简介 OCI(Open Container Initiative)是一个开放的治理结构，其围绕容器格式和运行时创建了开放的行业标准。OCI于2015年6月由Docker和容器行业的其他领导者成立，目前包含两个规范：运行时规范（runtime-spec）和图像规范（image-spec）。
本文分析容器启动时，docker如何创建运行时配置(runtime-spec)。
2. 入口 这一过程发生在docker启动容器过程中，即docker container start时，前部分流程分析可以参见docker container start 源码分析。
入口位于Daemon.createSpec方法，创建符合oci标准的容器配置，后续该配置将被传递给oci。
https://github.com/moby/moby/blob/master/daemon/start.go#L153-L156
func (daemon *Daemon) containerStart(container *container.Container, checkpoint string, checkpointDir string, resetRestartManager bool) (err error) { ... spec, err := daemon.createSpec(container) if err != nil { return errdefs.System(err) } ... } https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1008
func (daemon *Daemon) createSpec(c *container.Container) (retSpec *specs.Spec, err error) { var ( opts []coci.SpecOpts s = oci.DefaultSpec() ) opts = append(opts, WithCommonOptions(daemon, c), WithCgroups(daemon, c), WithResources(c), WithSysctls(c), WithDevices(daemon, c), WithUser(c), WithRlimits(daemon, c), WithNamespaces(daemon, c), WithCapabilities(c), WithSeccomp(daemon, c), WithMounts(daemon, c), WithLibnetwork(daemon, c), WithApparmor(c), WithSelinux(c), WithOOMScore(&amp;amp;c." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/docker%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1/docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/docker-container/docker-container-start-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/docker-%E5%88%9B%E5%BB%BAoci%E8%BF%90%E8%A1%8C%E6%97%B6%E9%85%8D%E7%BD%AE-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html" />


<title>
    
    docker 创建oci运行时配置 源码分析 :: welcome to st0n3&#39;s blog 
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.de959d61dd13c2cd41136acd491ffb0749779e1afe37b1fed6d5cba0b7e1938d.css">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#252627"><meta itemprop="name" content="docker 创建oci运行时配置 源码分析">
<meta itemprop="description" content="tags: container,docker,源码分析 docker 创建oci运行时配置 源码分析 1. 简介 OCI(Open Container Initiative)是一个开放的治理结构，其围绕容器格式和运行时创建了开放的行业标准。OCI于2015年6月由Docker和容器行业的其他领导者成立，目前包含两个规范：运行时规范（runtime-spec）和图像规范（image-spec）。
本文分析容器启动时，docker如何创建运行时配置(runtime-spec)。
2. 入口 这一过程发生在docker启动容器过程中，即docker container start时，前部分流程分析可以参见docker container start 源码分析。
入口位于Daemon.createSpec方法，创建符合oci标准的容器配置，后续该配置将被传递给oci。
https://github.com/moby/moby/blob/master/daemon/start.go#L153-L156
func (daemon *Daemon) containerStart(container *container.Container, checkpoint string, checkpointDir string, resetRestartManager bool) (err error) { ... spec, err := daemon.createSpec(container) if err != nil { return errdefs.System(err) } ... } https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1008
func (daemon *Daemon) createSpec(c *container.Container) (retSpec *specs.Spec, err error) { var ( opts []coci.SpecOpts s = oci.DefaultSpec() ) opts = append(opts, WithCommonOptions(daemon, c), WithCgroups(daemon, c), WithResources(c), WithSysctls(c), WithDevices(daemon, c), WithUser(c), WithRlimits(daemon, c), WithNamespaces(daemon, c), WithCapabilities(c), WithSeccomp(daemon, c), WithMounts(daemon, c), WithLibnetwork(daemon, c), WithApparmor(c), WithSelinux(c), WithOOMScore(&amp;c.">
<meta itemprop="datePublished" content="2022-05-27T03:13:52+00:00" />
<meta itemprop="dateModified" content="2022-05-27T03:13:52+00:00" />
<meta itemprop="wordCount" content="6914">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="docker 创建oci运行时配置 源码分析"/>
<meta name="twitter:description" content="tags: container,docker,源码分析 docker 创建oci运行时配置 源码分析 1. 简介 OCI(Open Container Initiative)是一个开放的治理结构，其围绕容器格式和运行时创建了开放的行业标准。OCI于2015年6月由Docker和容器行业的其他领导者成立，目前包含两个规范：运行时规范（runtime-spec）和图像规范（image-spec）。
本文分析容器启动时，docker如何创建运行时配置(runtime-spec)。
2. 入口 这一过程发生在docker启动容器过程中，即docker container start时，前部分流程分析可以参见docker container start 源码分析。
入口位于Daemon.createSpec方法，创建符合oci标准的容器配置，后续该配置将被传递给oci。
https://github.com/moby/moby/blob/master/daemon/start.go#L153-L156
func (daemon *Daemon) containerStart(container *container.Container, checkpoint string, checkpointDir string, resetRestartManager bool) (err error) { ... spec, err := daemon.createSpec(container) if err != nil { return errdefs.System(err) } ... } https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1008
func (daemon *Daemon) createSpec(c *container.Container) (retSpec *specs.Spec, err error) { var ( opts []coci.SpecOpts s = oci.DefaultSpec() ) opts = append(opts, WithCommonOptions(daemon, c), WithCgroups(daemon, c), WithResources(c), WithSysctls(c), WithDevices(daemon, c), WithUser(c), WithRlimits(daemon, c), WithNamespaces(daemon, c), WithCapabilities(c), WithSeccomp(daemon, c), WithMounts(daemon, c), WithLibnetwork(daemon, c), WithApparmor(c), WithSelinux(c), WithOOMScore(&amp;c."/>




<meta property="article:published_time" content="2022-05-27 03:13:52 &#43;0000 UTC" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/st0n3</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/aboutme.html">About</a></li><li><a href="/post.html">Blog</a></li><li><a href="/hackerbot">Hackerbot</a></li><li><a href="/skill_tree/">SkillTree</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/docker%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1/docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/docker-container/docker-container-start-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/docker-%E5%88%9B%E5%BB%BAoci%E8%BF%90%E8%A1%8C%E6%97%B6%E9%85%8D%E7%BD%AE-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html">docker 创建oci运行时配置 源码分析</a></h2>

            

            <div class="post-content">
                <hr>
<h2 id="tags-containerdocker源码分析">tags: container,docker,源码分析</h2>
<h1 id="docker-创建oci运行时配置-源码分析">docker 创建oci运行时配置 源码分析</h1>
<h2 id="1-简介">1. 简介</h2>
<p>OCI(Open Container Initiative)是一个开放的治理结构，其围绕容器格式和运行时创建了开放的行业标准。OCI于2015年6月由Docker和容器行业的其他领导者成立，目前包含两个规范：运行时规范（runtime-spec）和图像规范（image-spec）。</p>
<p>本文分析容器启动时，docker如何创建运行时配置(runtime-spec)。</p>
<h2 id="2-入口">2. 入口</h2>
<p>这一过程发生在docker启动容器过程中，即docker container start时，前部分流程分析可以参见<a href="https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/docker%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1/docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/docker-container/docker-container-start-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html">docker container start 源码分析</a>。</p>
<p>入口位于<code>Daemon.createSpec</code>方法，创建符合oci标准的容器配置，后续该配置将被传递给oci。</p>
<p><a href="https://github.com/moby/moby/blob/master/daemon/start.go#L153-L156">https://github.com/moby/moby/blob/master/daemon/start.go#L153-L156</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">containerStart</span>(<span style="color:#a6e22e">container</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">checkpoint</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">checkpointDir</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">resetRestartManager</span> <span style="color:#66d9ef">bool</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">spec</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">createSpec</span>(<span style="color:#a6e22e">container</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errdefs</span>.<span style="color:#a6e22e">System</span>(<span style="color:#a6e22e">err</span>)
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1008">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1008</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">createSpec</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) (<span style="color:#a6e22e">retSpec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">var</span> (
        <span style="color:#a6e22e">opts</span> []<span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span>
        <span style="color:#a6e22e">s</span>    = <span style="color:#a6e22e">oci</span>.<span style="color:#a6e22e">DefaultSpec</span>()
    )
    <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>,
        <span style="color:#a6e22e">WithCommonOptions</span>(<span style="color:#a6e22e">daemon</span>, <span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithCgroups</span>(<span style="color:#a6e22e">daemon</span>, <span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithResources</span>(<span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithSysctls</span>(<span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithDevices</span>(<span style="color:#a6e22e">daemon</span>, <span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithUser</span>(<span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithRlimits</span>(<span style="color:#a6e22e">daemon</span>, <span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithNamespaces</span>(<span style="color:#a6e22e">daemon</span>, <span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithCapabilities</span>(<span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithSeccomp</span>(<span style="color:#a6e22e">daemon</span>, <span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span>, <span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithLibnetwork</span>(<span style="color:#a6e22e">daemon</span>, <span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithApparmor</span>(<span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithSelinux</span>(<span style="color:#a6e22e">c</span>),
        <span style="color:#a6e22e">WithOOMScore</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">OomScoreAdj</span>),
    )
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">NoNewPrivileges</span> {
        <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">WithNoNewPrivileges</span>)
    }

    <span style="color:#75715e">// Set the masked and readonly paths with regard to the host config options if they are set.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">MaskedPaths</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">WithMaskedPaths</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">MaskedPaths</span>))
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">ReadonlyPaths</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">WithReadonlyPaths</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">ReadonlyPaths</span>))
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">Rootless</span> {
        <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">WithRootless</span>(<span style="color:#a6e22e">daemon</span>))
    }
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">ApplyOpts</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#66d9ef">nil</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>{
        <span style="color:#a6e22e">ID</span>: <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ID</span>,
    }, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
}
</code></pre></div><h2 id="3-默认linux容器oci配置">3. 默认Linux容器oci配置</h2>
<p>在应用其他配置前，linux容器有一些默认配置。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1014">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1014</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">createSpec</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) (<span style="color:#a6e22e">retSpec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">var</span> (
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">s</span>    = <span style="color:#a6e22e">oci</span>.<span style="color:#a6e22e">DefaultSpec</span>()
    )
    <span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L16">https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L16</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultSpec</span>() <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">DefaultOSSpec</span>(<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">GOOS</span>)
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L25">https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L25</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultOSSpec</span>(<span style="color:#a6e22e">osName</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">DefaultLinuxSpec</span>()
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L39">https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L39</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultLinuxSpec</span>() <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span> {
    <span style="color:#f92672">...</span>
}
</code></pre></div><h3 id="31-capability">3.1 capability</h3>
<p>容器内限制了capability, 默认仅支持以下能力集。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L42-L48">https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L42-L48</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultLinuxSpec</span>() <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span> {
    <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>{
        <span style="color:#a6e22e">Version</span>: <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Version</span>,
        <span style="color:#a6e22e">Process</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Process</span>{
            <span style="color:#a6e22e">Capabilities</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxCapabilities</span>{
                <span style="color:#a6e22e">Bounding</span>:  <span style="color:#a6e22e">caps</span>.<span style="color:#a6e22e">DefaultCapabilities</span>(),
                <span style="color:#a6e22e">Permitted</span>: <span style="color:#a6e22e">caps</span>.<span style="color:#a6e22e">DefaultCapabilities</span>(),
                <span style="color:#a6e22e">Effective</span>: <span style="color:#a6e22e">caps</span>.<span style="color:#a6e22e">DefaultCapabilities</span>(),
            },
        },
        <span style="color:#a6e22e">Root</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Root</span>{},
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/oci/caps/defaults.go#L4">https://github.com/moby/moby/blob/v20.10.14/oci/caps/defaults.go#L4</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultCapabilities</span>() []<span style="color:#66d9ef">string</span> {
    <span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">string</span>{
        <span style="color:#e6db74">&#34;CAP_CHOWN&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_DAC_OVERRIDE&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_FSETID&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_FOWNER&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_MKNOD&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_NET_RAW&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_SETGID&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_SETUID&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_SETFCAP&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_SETPCAP&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_NET_BIND_SERVICE&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_SYS_CHROOT&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_KILL&#34;</span>,
        <span style="color:#e6db74">&#34;CAP_AUDIT_WRITE&#34;</span>,
    }
}
</code></pre></div><hr>
<h3 id="32-挂载">3.2 挂载</h3>
<p>默认需要挂载的文件系统：</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L51-L94">https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L51-L94</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultLinuxSpec</span>() <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span> = []<span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Mount</span>{
        {
            <span style="color:#a6e22e">Destination</span>: <span style="color:#e6db74">&#34;/proc&#34;</span>,
            <span style="color:#a6e22e">Type</span>:        <span style="color:#e6db74">&#34;proc&#34;</span>,
            <span style="color:#a6e22e">Source</span>:      <span style="color:#e6db74">&#34;proc&#34;</span>,
            <span style="color:#a6e22e">Options</span>:     []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;nosuid&#34;</span>, <span style="color:#e6db74">&#34;noexec&#34;</span>, <span style="color:#e6db74">&#34;nodev&#34;</span>},
        },
        {
            <span style="color:#a6e22e">Destination</span>: <span style="color:#e6db74">&#34;/dev&#34;</span>,
            <span style="color:#a6e22e">Type</span>:        <span style="color:#e6db74">&#34;tmpfs&#34;</span>,
            <span style="color:#a6e22e">Source</span>:      <span style="color:#e6db74">&#34;tmpfs&#34;</span>,
            <span style="color:#a6e22e">Options</span>:     []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;nosuid&#34;</span>, <span style="color:#e6db74">&#34;strictatime&#34;</span>, <span style="color:#e6db74">&#34;mode=755&#34;</span>, <span style="color:#e6db74">&#34;size=65536k&#34;</span>},
        },
        {
            <span style="color:#a6e22e">Destination</span>: <span style="color:#e6db74">&#34;/dev/pts&#34;</span>,
            <span style="color:#a6e22e">Type</span>:        <span style="color:#e6db74">&#34;devpts&#34;</span>,
            <span style="color:#a6e22e">Source</span>:      <span style="color:#e6db74">&#34;devpts&#34;</span>,
            <span style="color:#a6e22e">Options</span>:     []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;nosuid&#34;</span>, <span style="color:#e6db74">&#34;noexec&#34;</span>, <span style="color:#e6db74">&#34;newinstance&#34;</span>, <span style="color:#e6db74">&#34;ptmxmode=0666&#34;</span>, <span style="color:#e6db74">&#34;mode=0620&#34;</span>, <span style="color:#e6db74">&#34;gid=5&#34;</span>},
        },
        {
            <span style="color:#a6e22e">Destination</span>: <span style="color:#e6db74">&#34;/sys&#34;</span>,
            <span style="color:#a6e22e">Type</span>:        <span style="color:#e6db74">&#34;sysfs&#34;</span>,
            <span style="color:#a6e22e">Source</span>:      <span style="color:#e6db74">&#34;sysfs&#34;</span>,
            <span style="color:#a6e22e">Options</span>:     []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;nosuid&#34;</span>, <span style="color:#e6db74">&#34;noexec&#34;</span>, <span style="color:#e6db74">&#34;nodev&#34;</span>, <span style="color:#e6db74">&#34;ro&#34;</span>},
        },
        {
            <span style="color:#a6e22e">Destination</span>: <span style="color:#e6db74">&#34;/sys/fs/cgroup&#34;</span>,
            <span style="color:#a6e22e">Type</span>:        <span style="color:#e6db74">&#34;cgroup&#34;</span>,
            <span style="color:#a6e22e">Source</span>:      <span style="color:#e6db74">&#34;cgroup&#34;</span>,
            <span style="color:#a6e22e">Options</span>:     []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;ro&#34;</span>, <span style="color:#e6db74">&#34;nosuid&#34;</span>, <span style="color:#e6db74">&#34;noexec&#34;</span>, <span style="color:#e6db74">&#34;nodev&#34;</span>},
        },
        {
            <span style="color:#a6e22e">Destination</span>: <span style="color:#e6db74">&#34;/dev/mqueue&#34;</span>,
            <span style="color:#a6e22e">Type</span>:        <span style="color:#e6db74">&#34;mqueue&#34;</span>,
            <span style="color:#a6e22e">Source</span>:      <span style="color:#e6db74">&#34;mqueue&#34;</span>,
            <span style="color:#a6e22e">Options</span>:     []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;nosuid&#34;</span>, <span style="color:#e6db74">&#34;noexec&#34;</span>, <span style="color:#e6db74">&#34;nodev&#34;</span>},
        },
        {
            <span style="color:#a6e22e">Destination</span>: <span style="color:#e6db74">&#34;/dev/shm&#34;</span>,
            <span style="color:#a6e22e">Type</span>:        <span style="color:#e6db74">&#34;tmpfs&#34;</span>,
            <span style="color:#a6e22e">Source</span>:      <span style="color:#e6db74">&#34;shm&#34;</span>,
            <span style="color:#a6e22e">Options</span>:     []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;nosuid&#34;</span>, <span style="color:#e6db74">&#34;noexec&#34;</span>, <span style="color:#e6db74">&#34;nodev&#34;</span>, <span style="color:#e6db74">&#34;mode=1777&#34;</span>},
        },
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>但有一些文件可能会泄漏宿主机敏感信息，所以指定到<code>MaskedPaths</code>成员变量，后续将会把<code>/dev/null</code>或tmpfs挂载至这些路径，这样原先有敏感信息的路径将被覆盖。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L97-L108">https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L97-L108</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultLinuxSpec</span>() <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Linux</span>{
        <span style="color:#a6e22e">MaskedPaths</span>: []<span style="color:#66d9ef">string</span>{
            <span style="color:#e6db74">&#34;/proc/asound&#34;</span>,
            <span style="color:#e6db74">&#34;/proc/acpi&#34;</span>,
            <span style="color:#e6db74">&#34;/proc/kcore&#34;</span>,
            <span style="color:#e6db74">&#34;/proc/keys&#34;</span>,
            <span style="color:#e6db74">&#34;/proc/latency_stats&#34;</span>,
            <span style="color:#e6db74">&#34;/proc/timer_list&#34;</span>,
            <span style="color:#e6db74">&#34;/proc/timer_stats&#34;</span>,
            <span style="color:#e6db74">&#34;/proc/sched_debug&#34;</span>,
            <span style="color:#e6db74">&#34;/proc/scsi&#34;</span>,
            <span style="color:#e6db74">&#34;/sys/firmware&#34;</span>,
        },
        <span style="color:#f92672">...</span>
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>另有一些路径不应允许被容器内用户写入，否则可能存在安全风险。这些路径被写在<code>ReadonlyPaths</code>成员变量, 后续以只读形式重新挂载。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L109-L115">https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L109-L115</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultLinuxSpec</span>() <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Linux</span>{
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">ReadonlyPaths</span>: []<span style="color:#66d9ef">string</span>{
            <span style="color:#e6db74">&#34;/proc/bus&#34;</span>,
            <span style="color:#e6db74">&#34;/proc/fs&#34;</span>,
            <span style="color:#e6db74">&#34;/proc/irq&#34;</span>,
            <span style="color:#e6db74">&#34;/proc/sys&#34;</span>,
            <span style="color:#e6db74">&#34;/proc/sysrq-trigger&#34;</span>,
        },
        <span style="color:#f92672">...</span>
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<h3 id="33-namespace">3.3 namespace</h3>
<p>默认创建以下namespace, 后续根据容器创建时指定的配置，还可能会增加其他namespace。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L116-L122">https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L116-L122</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultLinuxSpec</span>() <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Linux</span>{
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">Namespaces</span>: []<span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxNamespace</span>{
            {<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;mount&#34;</span>},
            {<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;network&#34;</span>},
            {<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;uts&#34;</span>},
            {<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;pid&#34;</span>},
            {<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;ipc&#34;</span>},
        },
        <span style="color:#f92672">...</span>
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<h3 id="34-设备">3.4 设备</h3>
<p>docker默认没有添加设备。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L127">https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L127</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultLinuxSpec</span>() <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Linux</span>{
        <span style="color:#f92672">...</span>
        <span style="color:#75715e">// Devices implicitly contains the following devices:
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// null, zero, full, random, urandom, tty, console, and ptmx.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ptmx is a bind mount or symlink of the container&#39;s ptmx.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// See also: https://github.com/opencontainers/runtime-spec/blob/master/config-linux.md#default-devices
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">Devices</span>: []<span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxDevice</span>{},
        <span style="color:#f92672">...</span>
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><p>但runc有默认(即使oci配置中没有指定)会创建的设备null, zero, full, random, urandom, tty。</p>
<p><a href="https://github.com/opencontainers/runc/blob/v1.1.2/libcontainer/specconv/spec_linux.go#L191">https://github.com/opencontainers/runc/blob/v1.1.2/libcontainer/specconv/spec_linux.go#L191</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">AllowedDevices</span> = []<span style="color:#f92672">*</span><span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">Device</span>{
    <span style="color:#f92672">...</span>
    {
        <span style="color:#a6e22e">Path</span>:     <span style="color:#e6db74">&#34;/dev/null&#34;</span>,
        <span style="color:#a6e22e">FileMode</span>: <span style="color:#ae81ff">0</span><span style="color:#a6e22e">o666</span>,
        <span style="color:#a6e22e">Uid</span>:      <span style="color:#ae81ff">0</span>,
        <span style="color:#a6e22e">Gid</span>:      <span style="color:#ae81ff">0</span>,
        <span style="color:#a6e22e">Rule</span>: <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">Rule</span>{
            <span style="color:#a6e22e">Type</span>:        <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">CharDevice</span>,
            <span style="color:#a6e22e">Major</span>:       <span style="color:#ae81ff">1</span>,
            <span style="color:#a6e22e">Minor</span>:       <span style="color:#ae81ff">3</span>,
            <span style="color:#a6e22e">Permissions</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
            <span style="color:#a6e22e">Allow</span>:       <span style="color:#66d9ef">true</span>,
        },
    },
    {
        <span style="color:#a6e22e">Path</span>:     <span style="color:#e6db74">&#34;/dev/random&#34;</span>,
        <span style="color:#a6e22e">FileMode</span>: <span style="color:#ae81ff">0</span><span style="color:#a6e22e">o666</span>,
        <span style="color:#a6e22e">Uid</span>:      <span style="color:#ae81ff">0</span>,
        <span style="color:#a6e22e">Gid</span>:      <span style="color:#ae81ff">0</span>,
        <span style="color:#a6e22e">Rule</span>: <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">Rule</span>{
            <span style="color:#a6e22e">Type</span>:        <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">CharDevice</span>,
            <span style="color:#a6e22e">Major</span>:       <span style="color:#ae81ff">1</span>,
            <span style="color:#a6e22e">Minor</span>:       <span style="color:#ae81ff">8</span>,
            <span style="color:#a6e22e">Permissions</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
            <span style="color:#a6e22e">Allow</span>:       <span style="color:#66d9ef">true</span>,
        },
    },
    {
        <span style="color:#a6e22e">Path</span>:     <span style="color:#e6db74">&#34;/dev/full&#34;</span>,
        <span style="color:#a6e22e">FileMode</span>: <span style="color:#ae81ff">0</span><span style="color:#a6e22e">o666</span>,
        <span style="color:#a6e22e">Uid</span>:      <span style="color:#ae81ff">0</span>,
        <span style="color:#a6e22e">Gid</span>:      <span style="color:#ae81ff">0</span>,
        <span style="color:#a6e22e">Rule</span>: <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">Rule</span>{
            <span style="color:#a6e22e">Type</span>:        <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">CharDevice</span>,
            <span style="color:#a6e22e">Major</span>:       <span style="color:#ae81ff">1</span>,
            <span style="color:#a6e22e">Minor</span>:       <span style="color:#ae81ff">7</span>,
            <span style="color:#a6e22e">Permissions</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
            <span style="color:#a6e22e">Allow</span>:       <span style="color:#66d9ef">true</span>,
        },
    },
    {
        <span style="color:#a6e22e">Path</span>:     <span style="color:#e6db74">&#34;/dev/tty&#34;</span>,
        <span style="color:#a6e22e">FileMode</span>: <span style="color:#ae81ff">0</span><span style="color:#a6e22e">o666</span>,
        <span style="color:#a6e22e">Uid</span>:      <span style="color:#ae81ff">0</span>,
        <span style="color:#a6e22e">Gid</span>:      <span style="color:#ae81ff">0</span>,
        <span style="color:#a6e22e">Rule</span>: <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">Rule</span>{
            <span style="color:#a6e22e">Type</span>:        <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">CharDevice</span>,
            <span style="color:#a6e22e">Major</span>:       <span style="color:#ae81ff">5</span>,
            <span style="color:#a6e22e">Minor</span>:       <span style="color:#ae81ff">0</span>,
            <span style="color:#a6e22e">Permissions</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
            <span style="color:#a6e22e">Allow</span>:       <span style="color:#66d9ef">true</span>,
        },
    },
    {
        <span style="color:#a6e22e">Path</span>:     <span style="color:#e6db74">&#34;/dev/zero&#34;</span>,
        <span style="color:#a6e22e">FileMode</span>: <span style="color:#ae81ff">0</span><span style="color:#a6e22e">o666</span>,
        <span style="color:#a6e22e">Uid</span>:      <span style="color:#ae81ff">0</span>,
        <span style="color:#a6e22e">Gid</span>:      <span style="color:#ae81ff">0</span>,
        <span style="color:#a6e22e">Rule</span>: <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">Rule</span>{
            <span style="color:#a6e22e">Type</span>:        <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">CharDevice</span>,
            <span style="color:#a6e22e">Major</span>:       <span style="color:#ae81ff">1</span>,
            <span style="color:#a6e22e">Minor</span>:       <span style="color:#ae81ff">5</span>,
            <span style="color:#a6e22e">Permissions</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
            <span style="color:#a6e22e">Allow</span>:       <span style="color:#66d9ef">true</span>,
        },
    },
    {
        <span style="color:#a6e22e">Path</span>:     <span style="color:#e6db74">&#34;/dev/urandom&#34;</span>,
        <span style="color:#a6e22e">FileMode</span>: <span style="color:#ae81ff">0</span><span style="color:#a6e22e">o666</span>,
        <span style="color:#a6e22e">Uid</span>:      <span style="color:#ae81ff">0</span>,
        <span style="color:#a6e22e">Gid</span>:      <span style="color:#ae81ff">0</span>,
        <span style="color:#a6e22e">Rule</span>: <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">Rule</span>{
            <span style="color:#a6e22e">Type</span>:        <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">CharDevice</span>,
            <span style="color:#a6e22e">Major</span>:       <span style="color:#ae81ff">1</span>,
            <span style="color:#a6e22e">Minor</span>:       <span style="color:#ae81ff">9</span>,
            <span style="color:#a6e22e">Permissions</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
            <span style="color:#a6e22e">Allow</span>:       <span style="color:#66d9ef">true</span>,
        },
    },
    <span style="color:#f92672">...</span>
}
</code></pre></div><p>docker通过设备号，配置了各设备的cgroup访问控制策略。</p>
<p>Linux中设备与设备号的约定参见 <a href="https://www.kernel.org/doc/Documentation/admin-guide/devices.txt">Linux Kernel文档</a>。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L129-L183">https://github.com/moby/moby/blob/v20.10.14/oci/defaults.go#L129-L183</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultLinuxSpec</span>() <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span> {
    <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">Resources</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxResources</span>{
            <span style="color:#a6e22e">Devices</span>: []<span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxDeviceCgroup</span>{
                {
                    <span style="color:#a6e22e">Allow</span>:  <span style="color:#66d9ef">false</span>,
                    <span style="color:#a6e22e">Access</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
                },
                {
                    <span style="color:#a6e22e">Allow</span>:  <span style="color:#66d9ef">true</span>,
                    <span style="color:#a6e22e">Type</span>:   <span style="color:#e6db74">&#34;c&#34;</span>,
                    <span style="color:#a6e22e">Major</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">1</span>),
                    <span style="color:#a6e22e">Minor</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">5</span>),
                    <span style="color:#a6e22e">Access</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
                },
                {
                    <span style="color:#a6e22e">Allow</span>:  <span style="color:#66d9ef">true</span>,
                    <span style="color:#a6e22e">Type</span>:   <span style="color:#e6db74">&#34;c&#34;</span>,
                    <span style="color:#a6e22e">Major</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">1</span>),
                    <span style="color:#a6e22e">Minor</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">3</span>),
                    <span style="color:#a6e22e">Access</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
                },
                {
                    <span style="color:#a6e22e">Allow</span>:  <span style="color:#66d9ef">true</span>,
                    <span style="color:#a6e22e">Type</span>:   <span style="color:#e6db74">&#34;c&#34;</span>,
                    <span style="color:#a6e22e">Major</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">1</span>),
                    <span style="color:#a6e22e">Minor</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">9</span>),
                    <span style="color:#a6e22e">Access</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
                },
                {
                    <span style="color:#a6e22e">Allow</span>:  <span style="color:#66d9ef">true</span>,
                    <span style="color:#a6e22e">Type</span>:   <span style="color:#e6db74">&#34;c&#34;</span>,
                    <span style="color:#a6e22e">Major</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">1</span>),
                    <span style="color:#a6e22e">Minor</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">8</span>),
                    <span style="color:#a6e22e">Access</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
                },
                {
                    <span style="color:#a6e22e">Allow</span>:  <span style="color:#66d9ef">true</span>,
                    <span style="color:#a6e22e">Type</span>:   <span style="color:#e6db74">&#34;c&#34;</span>,
                    <span style="color:#a6e22e">Major</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">5</span>),
                    <span style="color:#a6e22e">Minor</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">0</span>),
                    <span style="color:#a6e22e">Access</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
                },
                {
                    <span style="color:#a6e22e">Allow</span>:  <span style="color:#66d9ef">true</span>,
                    <span style="color:#a6e22e">Type</span>:   <span style="color:#e6db74">&#34;c&#34;</span>,
                    <span style="color:#a6e22e">Major</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">5</span>),
                    <span style="color:#a6e22e">Minor</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">1</span>),
                    <span style="color:#a6e22e">Access</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
                },
                {
                    <span style="color:#a6e22e">Allow</span>:  <span style="color:#66d9ef">false</span>,
                    <span style="color:#a6e22e">Type</span>:   <span style="color:#e6db74">&#34;c&#34;</span>,
                    <span style="color:#a6e22e">Major</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">10</span>),
                    <span style="color:#a6e22e">Minor</span>:  <span style="color:#a6e22e">iPtr</span>(<span style="color:#ae81ff">229</span>),
                    <span style="color:#a6e22e">Access</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
                },
            },
        },
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><h2 id="4-其他各类型配置分析">4. 其他各类型配置分析</h2>
<h3 id="41-常规配置选项-withcommonoptions">4.1 常规配置选项: WithCommonOptions</h3>
<h4 id="411-创建容器进程环境变量">4.1.1 创建容器进程环境变量</h4>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L757">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L757</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithCommonOptions</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">linkedEnv</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">setupLinkedContainers</span>(<span style="color:#a6e22e">c</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Env</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">CreateDaemonEnvironment</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Tty</span>, <span style="color:#a6e22e">linkedEnv</span>)
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/container/container.go#L731">https://github.com/moby/moby/blob/v20.10.14/container/container.go#L731</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">container</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">CreateDaemonEnvironment</span>(<span style="color:#a6e22e">tty</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">linkedEnv</span> []<span style="color:#66d9ef">string</span>) []<span style="color:#66d9ef">string</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">env</span> = append(<span style="color:#a6e22e">env</span>, <span style="color:#e6db74">&#34;PATH=&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">system</span>.<span style="color:#a6e22e">DefaultPathEnv</span>(<span style="color:#a6e22e">os</span>))
    <span style="color:#a6e22e">env</span> = append(<span style="color:#a6e22e">env</span>, <span style="color:#e6db74">&#34;HOSTNAME=&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Hostname</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tty</span> {
        <span style="color:#a6e22e">env</span> = append(<span style="color:#a6e22e">env</span>, <span style="color:#e6db74">&#34;TERM=xterm&#34;</span>)
    }
    <span style="color:#a6e22e">env</span> = append(<span style="color:#a6e22e">env</span>, <span style="color:#a6e22e">linkedEnv</span><span style="color:#f92672">...</span>)
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">env</span> = <span style="color:#a6e22e">ReplaceOrAppendEnvValues</span>(<span style="color:#a6e22e">env</span>, <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Env</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">env</span>
}
</code></pre></div><h4 id="412-rootfs">4.1.2 rootfs</h4>
<p>设置oci配置的Root路径，形如<code>/var/lib/docker/overlay2/{LayerID}/merged</code>。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L721">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L721</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithCommonOptions</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Root</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Root</span>{
            <span style="color:#a6e22e">Path</span>:     <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">BaseFS</span>.<span style="color:#a6e22e">Path</span>(),
            <span style="color:#a6e22e">Readonly</span>: <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">ReadonlyRootfs</span>,
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><h4 id="413-容器进程">4.1.3 容器进程</h4>
<p>创建并设置容器进程的工作目录。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L725-L731">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L725-L731</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithCommonOptions</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SetupWorkingDirectory</span>(<span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">idMapping</span>.<span style="color:#a6e22e">RootPair</span>()); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">cwd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">WorkingDir</span>
        <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">cwd</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
            <span style="color:#a6e22e">cwd</span> = <span style="color:#e6db74">&#34;/&#34;</span>
        }
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Cwd</span> = <span style="color:#a6e22e">cwd</span>
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/container/container.go#L265">https://github.com/moby/moby/blob/v20.10.14/container/container.go#L265</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">container</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">SetupWorkingDirectory</span>(<span style="color:#a6e22e">rootIdentity</span> <span style="color:#a6e22e">idtools</span>.<span style="color:#a6e22e">Identity</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">WorkingDir</span> = <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Clean</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">WorkingDir</span>)
    <span style="color:#a6e22e">pth</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">GetResourcePath</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">WorkingDir</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">idtools</span>.<span style="color:#a6e22e">MkdirAllAndChownNew</span>(<span style="color:#a6e22e">pth</span>, <span style="color:#ae81ff">0755</span>, <span style="color:#a6e22e">rootIdentity</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">pthInfo</span>, <span style="color:#a6e22e">err2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#a6e22e">pth</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err2</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">pthInfo</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">pthInfo</span>.<span style="color:#a6e22e">IsDir</span>() {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Cannot mkdir: %s is not a directory&#34;</span>, <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">WorkingDir</span>)
        }

        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><hr>
<p><a href="https://docs.docker.com/engine/reference/run/#specify-an-init-process">docker可以通过init参数，设置容器的第一个进程</a>。如果使用了该参数，且容器使用了独立的pid namespace，则将该init命令文件bind mount到容器内，并设置容器进程的参数。</p>
<p>默认情况下，容器的init进程为<code>docker-init</code>, 则容器进程的参数为<code>docker-init -- {ENTRYPOINT}</code>， <code>docker-init</code>将被挂载至容器的<code>/sbin/docker-init</code>路径。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L732-L755">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L732-L755</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">inContainerInitPath</span> = <span style="color:#e6db74">&#34;/sbin/&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">daemonconfig</span>.<span style="color:#a6e22e">DefaultInitBinary</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithCommonOptions</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Args</span> = append([]<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Path</span>}, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Args</span><span style="color:#f92672">...</span>)
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">PidMode</span>.<span style="color:#a6e22e">IsPrivate</span>() {
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Init</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Init</span>) <span style="color:#f92672">||</span>
                (<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Init</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">Init</span>) {
                <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Args</span> = append([]<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">inContainerInitPath</span>, <span style="color:#e6db74">&#34;--&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Path</span>}, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Args</span><span style="color:#f92672">...</span>)
                <span style="color:#a6e22e">path</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">InitPath</span>
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">path</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
                    <span style="color:#a6e22e">path</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">LookPath</span>(<span style="color:#a6e22e">daemonconfig</span>.<span style="color:#a6e22e">DefaultInitBinary</span>)
                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
                    }
                }
                <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span> = append(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span>, <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Mount</span>{
                    <span style="color:#a6e22e">Destination</span>: <span style="color:#a6e22e">inContainerInitPath</span>,
                    <span style="color:#a6e22e">Type</span>:        <span style="color:#e6db74">&#34;bind&#34;</span>,
                    <span style="color:#a6e22e">Source</span>:      <span style="color:#a6e22e">path</span>,
                    <span style="color:#a6e22e">Options</span>:     []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;bind&#34;</span>, <span style="color:#e6db74">&#34;ro&#34;</span>},
                })
            }
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>容器创建时可以指定<code>--tty</code>参数，该参数被传递给<code>s.Process.Terminal</code></p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L758">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L758</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithCommonOptions</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Terminal</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Tty</span>
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<h4 id="414-hostname-domainname">4.1.4 hostname, domainname</h4>
<p>直接传递hostname到oci配置：</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L760">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L760</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithCommonOptions</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Hostname</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Hostname</span>
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>设置Domainname，<a href="https://github.com/moby/moby/commit/7417f5057568eacf835e9f8ffdf7263e75908f0a">因为oci中没有该配置项，所以通过sysctl传递</a>。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L761">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L761</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithCommonOptions</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">setLinuxDomainname</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">s</span>)
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_utils.go#L8">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_utils.go#L8</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">setLinuxDomainname</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>) {
	<span style="color:#75715e">// There isn&#39;t a field in the OCI for the NIS domainname, but luckily there
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// is a sysctl which has an identical effect to setdomainname(2) so there&#39;s
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// no explicit need for runtime support.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Sysctl</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Domainname</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Sysctl</span>[<span style="color:#e6db74">&#34;kernel.domainname&#34;</span>] = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">Domainname</span>
	}
}
</code></pre></div><hr>
<h4 id="415-非特权icmp-echo和端口监听">4.1.5 非特权<code>ICMP echo</code>和端口监听</h4>
<p>通过sysctl设置ping范围、允许普通用户监听特权端口。该功能原本通过<code>CAP_NET_RAW</code>和 <code>CAP_NET_BIND_SERVICE</code>提供，<a href="https://github.com/moby/moby/commit/dae652e2e5e47d99c8febd5bc81df0a3269beb74">引入</a>此段代码后，如果容器使用独立的network namespace, 在docker中可默认生效。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L768-L779">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L768-L779</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithCommonOptions</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">NetworkMode</span>.<span style="color:#a6e22e">IsPrivate</span>() {
            <span style="color:#75715e">// We cannot set up ping socket support in a user namespace
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">userNS</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">RemappedRoot</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">UsernsMode</span>.<span style="color:#a6e22e">IsPrivate</span>()
            <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">userNS</span> <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">RunningInUserNS</span>() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">sysctlExists</span>(<span style="color:#e6db74">&#34;net.ipv4.ping_group_range&#34;</span>) {
                <span style="color:#75715e">// allow unprivileged ICMP echo sockets without CAP_NET_RAW
</span><span style="color:#75715e"></span>                <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Sysctl</span>[<span style="color:#e6db74">&#34;net.ipv4.ping_group_range&#34;</span>] = <span style="color:#e6db74">&#34;0 2147483647&#34;</span>
            }
            <span style="color:#75715e">// allow opening any port less than 1024 without CAP_NET_BIND_SERVICE
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sysctlExists</span>(<span style="color:#e6db74">&#34;net.ipv4.ip_unprivileged_port_start&#34;</span>) {
                <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Sysctl</span>[<span style="color:#e6db74">&#34;net.ipv4.ip_unprivileged_port_start&#34;</span>] = <span style="color:#e6db74">&#34;0&#34;</span>
            }
        }

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
}
</code></pre></div><hr>
<h3 id="42-cgroups配置-withcgroups">4.2 cgroups配置: WithCgroups</h3>
<p>传递cgroup路径到oci配置。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L786">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L786</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithCgroups</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cgroupsPath</span> <span style="color:#66d9ef">string</span>
        <span style="color:#a6e22e">scopePrefix</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;docker&#34;</span>
        <span style="color:#a6e22e">parent</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;/docker&#34;</span>
        <span style="color:#a6e22e">useSystemd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">UsingSystemd</span>(<span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">useSystemd</span> {
            <span style="color:#a6e22e">parent</span> = <span style="color:#e6db74">&#34;system.slice&#34;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">Rootless</span> {
                <span style="color:#a6e22e">parent</span> = <span style="color:#e6db74">&#34;user.slice&#34;</span>
            }
        }

        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">CgroupParent</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
            <span style="color:#a6e22e">parent</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">CgroupParent</span>
        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">CgroupParent</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
            <span style="color:#a6e22e">parent</span> = <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">CgroupParent</span>
        }

        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">useSystemd</span> {
            <span style="color:#a6e22e">cgroupsPath</span> = <span style="color:#a6e22e">parent</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">scopePrefix</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ID</span>
            <span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;createSpec: cgroupsPath: %s&#34;</span>, <span style="color:#a6e22e">cgroupsPath</span>)
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">cgroupsPath</span> = <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">parent</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ID</span>)
        }
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">CgroupsPath</span> = <span style="color:#a6e22e">cgroupsPath</span>

        <span style="color:#75715e">// the rest is only needed for CPU RT controller
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">CPURealtimePeriod</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">CPURealtimeRuntime</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
        }
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">initCPURtController</span>(<span style="color:#a6e22e">mnt</span>, <span style="color:#a6e22e">parentPath</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to init CPU RT controller&#34;</span>)
        }
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
}
</code></pre></div><hr>
<h3 id="43-资源限制-withresources">4.3 资源限制: WithResources</h3>
<p>从HostConfig读取资源限制规则，传递给oci配置。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L936">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L936</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithResources</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Resources</span>
        <span style="color:#a6e22e">weightDevices</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getBlkioWeightDevices</span>(<span style="color:#a6e22e">r</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">readBpsDevice</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getBlkioThrottleDevices</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">BlkioDeviceReadBps</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">writeBpsDevice</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getBlkioThrottleDevices</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">BlkioDeviceWriteBps</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">readIOpsDevice</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getBlkioThrottleDevices</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">BlkioDeviceReadIOps</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">writeIOpsDevice</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getBlkioThrottleDevices</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">BlkioDeviceWriteIOps</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }

        <span style="color:#a6e22e">memoryRes</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getMemoryResources</span>(<span style="color:#a6e22e">r</span>)
        <span style="color:#a6e22e">cpuRes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getCPUResources</span>(<span style="color:#a6e22e">r</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">blkioWeight</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">BlkioWeight</span>

        <span style="color:#a6e22e">specResources</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxResources</span>{
            <span style="color:#a6e22e">Memory</span>: <span style="color:#a6e22e">memoryRes</span>,
            <span style="color:#a6e22e">CPU</span>:    <span style="color:#a6e22e">cpuRes</span>,
            <span style="color:#a6e22e">BlockIO</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxBlockIO</span>{
                <span style="color:#a6e22e">Weight</span>:                  <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">blkioWeight</span>,
                <span style="color:#a6e22e">WeightDevice</span>:            <span style="color:#a6e22e">weightDevices</span>,
                <span style="color:#a6e22e">ThrottleReadBpsDevice</span>:   <span style="color:#a6e22e">readBpsDevice</span>,
                <span style="color:#a6e22e">ThrottleWriteBpsDevice</span>:  <span style="color:#a6e22e">writeBpsDevice</span>,
                <span style="color:#a6e22e">ThrottleReadIOPSDevice</span>:  <span style="color:#a6e22e">readIOpsDevice</span>,
                <span style="color:#a6e22e">ThrottleWriteIOPSDevice</span>: <span style="color:#a6e22e">writeIOpsDevice</span>,
            },
            <span style="color:#a6e22e">Pids</span>: <span style="color:#a6e22e">getPidsLimit</span>(<span style="color:#a6e22e">r</span>),
        }

        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">Devices</span>) &gt; <span style="color:#ae81ff">0</span> {
            <span style="color:#a6e22e">specResources</span>.<span style="color:#a6e22e">Devices</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">Devices</span>
        }

        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span> = <span style="color:#a6e22e">specResources</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
}
</code></pre></div><hr>
<h3 id="44-withsysctls">4.4 WithSysctls</h3>
<p>前面已经设置了一些sysctl配置，<code>WithSysctls</code>函数将HostConfig中用户额外指定的sysctl配置传递给oci配置。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L991">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L991</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithSysctls</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Sysctls</span> {
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Sysctl</span>[<span style="color:#a6e22e">k</span>] = <span style="color:#a6e22e">v</span>
        }
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
}
</code></pre></div><hr>
<h3 id="45-设备withdevices">4.5 设备：WithDevices</h3>
<p>用于处理用户创建容器时指定的设备相关参数，具体包括以下参数：</p>
<ul>
<li><code>--device</code>: 添加宿主机设备到容器</li>
<li><code>--device-cgroup-rule</code>: 添加设备的cgroup规则</li>
<li><code>--gpus</code>: 向容器添加gpu设备，对应<code>HostConfig.DeviceRequests</code></li>
</ul>
<hr>
<p>如果是特权容器，且未运行在userns下，添加所有宿主机设备，且允许对所有设备的所有权限。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L873-L906">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L873-L906</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithDevices</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#75715e">// Build lists of devices allowed and created within the container.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">devs</span> []<span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxDevice</span>
        <span style="color:#a6e22e">devPermissions</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">Devices</span>

        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Privileged</span> <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">RunningInUserNS</span>() {
            <span style="color:#a6e22e">hostDevices</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">devices</span>.<span style="color:#a6e22e">HostDevices</span>()
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }
            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">hostDevices</span> {
                <span style="color:#a6e22e">devs</span> = append(<span style="color:#a6e22e">devs</span>, <span style="color:#a6e22e">oci</span>.<span style="color:#a6e22e">Device</span>(<span style="color:#a6e22e">d</span>))
            }

            <span style="color:#75715e">// adding device mappings in privileged containers
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">deviceMapping</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Devices</span> {
                <span style="color:#f92672">...</span>
                <span style="color:#75715e">// issue a warning that the device path already exists via /dev mounting in privileged mode
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">deviceMapping</span>.<span style="color:#a6e22e">PathOnHost</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">deviceMapping</span>.<span style="color:#a6e22e">PathInContainer</span> {
                    <span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">WithField</span>(<span style="color:#e6db74">&#34;container&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ID</span>).<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;path in container %s already exists in privileged mode&#34;</span>, <span style="color:#a6e22e">deviceMapping</span>.<span style="color:#a6e22e">PathInContainer</span>)
                    <span style="color:#66d9ef">continue</span>
                }
                <span style="color:#a6e22e">d</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oci</span>.<span style="color:#a6e22e">DevicesFromPath</span>(<span style="color:#a6e22e">deviceMapping</span>.<span style="color:#a6e22e">PathOnHost</span>, <span style="color:#a6e22e">deviceMapping</span>.<span style="color:#a6e22e">PathInContainer</span>, <span style="color:#e6db74">&#34;rwm&#34;</span>)
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
                }
                <span style="color:#a6e22e">devs</span> = append(<span style="color:#a6e22e">devs</span>, <span style="color:#a6e22e">d</span><span style="color:#f92672">...</span>)
            }

            <span style="color:#a6e22e">devPermissions</span> = []<span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxDeviceCgroup</span>{
                {
                    <span style="color:#a6e22e">Allow</span>:  <span style="color:#66d9ef">true</span>,
                    <span style="color:#a6e22e">Access</span>: <span style="color:#e6db74">&#34;rwm&#34;</span>,
                },
            }
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>非特权容器或userns模式，需要设置设备和cgroup权限。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L906-L921">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L906-L921</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithDevices</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Privileged</span> <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">RunningInUserNS</span>() {
            <span style="color:#f92672">...</span>
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">deviceMapping</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Devices</span> {
                <span style="color:#a6e22e">d</span>, <span style="color:#a6e22e">dPermissions</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oci</span>.<span style="color:#a6e22e">DevicesFromPath</span>(<span style="color:#a6e22e">deviceMapping</span>.<span style="color:#a6e22e">PathOnHost</span>, <span style="color:#a6e22e">deviceMapping</span>.<span style="color:#a6e22e">PathInContainer</span>, <span style="color:#a6e22e">deviceMapping</span>.<span style="color:#a6e22e">CgroupPermissions</span>)
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
                }
                <span style="color:#a6e22e">devs</span> = append(<span style="color:#a6e22e">devs</span>, <span style="color:#a6e22e">d</span><span style="color:#f92672">...</span>)
                <span style="color:#a6e22e">devPermissions</span> = append(<span style="color:#a6e22e">devPermissions</span>, <span style="color:#a6e22e">dPermissions</span><span style="color:#f92672">...</span>)
            }

            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
            <span style="color:#a6e22e">devPermissions</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">oci</span>.<span style="color:#a6e22e">AppendDevicePermissionsFromCgroupRules</span>(<span style="color:#a6e22e">devPermissions</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">DeviceCgroupRules</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>将设置好的设备及对应的cgroup规则传递至oci配置。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L923-L924">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L923-L924</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithDevices</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Devices</span> = append(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Devices</span>, <span style="color:#a6e22e">devs</span><span style="color:#f92672">...</span>)
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">Devices</span> = <span style="color:#a6e22e">devPermissions</span>
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>处理特殊设备。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L926-L931">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L926-L931</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithDevices</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">DeviceRequests</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">handleDevice</span>(<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">s</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }
        }
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
}
</code></pre></div><hr>
<p>所谓“特殊设备”， 当前实际仅支持nvidia gpu。</p>
<p><a href="https://github.com/docker/cli/blob/master/cli/command/container/opts.go#L593">https://github.com/docker/cli/blob/master/cli/command/container/opts.go#L593</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">flags</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pflag</span>.<span style="color:#a6e22e">FlagSet</span>, <span style="color:#a6e22e">copts</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containerOptions</span>, <span style="color:#a6e22e">serverOS</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">containerConfig</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">resources</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Resources</span>{
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">DeviceRequests</span>:       <span style="color:#a6e22e">copts</span>.<span style="color:#a6e22e">gpus</span>.<span style="color:#a6e22e">Value</span>(),
    }
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">hostConfig</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostConfig</span>{
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">Resources</span>:      <span style="color:#a6e22e">resources</span>,
        <span style="color:#f92672">...</span>
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>当前仅有nvidia注册成为了DeviceDriver, 所以说仅支持nvidia gpu。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/nvidia_linux.go#L32">https://github.com/moby/moby/blob/v20.10.14/daemon/nvidia_linux.go#L32</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">LookPath</span>(<span style="color:#a6e22e">nvidiaHook</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#75715e">// do not register Nvidia driver if helper binary is not present.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span>
    }
    <span style="color:#a6e22e">capset</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">capabilities</span>.<span style="color:#a6e22e">Set</span>{<span style="color:#e6db74">&#34;gpu&#34;</span>: <span style="color:#66d9ef">struct</span>{}{}, <span style="color:#e6db74">&#34;nvidia&#34;</span>: <span style="color:#66d9ef">struct</span>{}{}}
    <span style="color:#a6e22e">nvidiaDriver</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">deviceDriver</span>{
        <span style="color:#a6e22e">capset</span>:     <span style="color:#a6e22e">capset</span>,
        <span style="color:#a6e22e">updateSpec</span>: <span style="color:#a6e22e">setNvidiaGPUs</span>,
    }
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">allNvidiaCaps</span> {
        <span style="color:#a6e22e">nvidiaDriver</span>.<span style="color:#a6e22e">capset</span>[string(<span style="color:#a6e22e">c</span>)] = <span style="color:#66d9ef">struct</span>{}{}
    }
    <span style="color:#a6e22e">registerDeviceDriver</span>(<span style="color:#e6db74">&#34;nvidia&#34;</span>, <span style="color:#a6e22e">nvidiaDriver</span>)
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/devices_linux.go#L22">https://github.com/moby/moby/blob/v20.10.14/daemon/devices_linux.go#L22</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">deviceDrivers</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">deviceDriver</span>{}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">deviceDriver</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">capset</span>     <span style="color:#a6e22e">capabilities</span>.<span style="color:#a6e22e">Set</span>
    <span style="color:#a6e22e">updateSpec</span> <span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">deviceInstance</span>) <span style="color:#66d9ef">error</span>
}

<span style="color:#f92672">...</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">registerDeviceDriver</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">deviceDriver</span>) {
    <span style="color:#a6e22e">deviceDrivers</span>[<span style="color:#a6e22e">name</span>] = <span style="color:#a6e22e">d</span>
}
</code></pre></div><hr>
<p>处理特殊设备即调用设备驱动更新oci配置。这是一种后向兼容设计，目前如果用户指定了gpus参数，则nvidia driver的<code>updateSpec</code>方法会被调用。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/devices_linux.go#L34">https://github.com/moby/moby/blob/v20.10.14/daemon/devices_linux.go#L34</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">handleDevice</span>(<span style="color:#a6e22e">req</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">DeviceRequest</span>, <span style="color:#a6e22e">spec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Driver</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">dd</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">deviceDrivers</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">selected</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dd</span>.<span style="color:#a6e22e">capset</span>.<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Capabilities</span>); <span style="color:#a6e22e">selected</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dd</span>.<span style="color:#a6e22e">updateSpec</span>(<span style="color:#a6e22e">spec</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">deviceInstance</span>{<span style="color:#a6e22e">req</span>: <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">selectedCaps</span>: <span style="color:#a6e22e">selected</span>})
            }
        }
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">dd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">deviceDrivers</span>[<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Driver</span>]; <span style="color:#a6e22e">dd</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">selected</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dd</span>.<span style="color:#a6e22e">capset</span>.<span style="color:#a6e22e">Match</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Capabilities</span>); <span style="color:#a6e22e">selected</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dd</span>.<span style="color:#a6e22e">updateSpec</span>(<span style="color:#a6e22e">spec</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">deviceInstance</span>{<span style="color:#a6e22e">req</span>: <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">selectedCaps</span>: <span style="color:#a6e22e">selected</span>})
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">incompatibleDeviceRequest</span>{<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Driver</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Capabilities</span>}
}
</code></pre></div><hr>
<p>配置进程环境变量，并在runtime的Prestart阶段，将<code>nvidia-container-runtime-hook prestart</code>命令设置为Hook进程</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/nvidia_linux.go#L48">https://github.com/moby/moby/blob/v20.10.14/daemon/nvidia_linux.go#L48</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">setNvidiaGPUs</span>(<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>, <span style="color:#a6e22e">dev</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">deviceInstance</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dev</span>.<span style="color:#a6e22e">req</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Count</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">DeviceIDs</span>) &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errConflictCountDeviceIDs</span>
    }

    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">DeviceIDs</span>) &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Env</span> = append(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Env</span>, <span style="color:#e6db74">&#34;NVIDIA_VISIBLE_DEVICES=&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">DeviceIDs</span>, <span style="color:#e6db74">&#34;,&#34;</span>))
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Count</span> &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Env</span> = append(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Env</span>, <span style="color:#e6db74">&#34;NVIDIA_VISIBLE_DEVICES=&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">countToDevices</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Count</span>))
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Count</span> &lt; <span style="color:#ae81ff">0</span> {
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Env</span> = append(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Env</span>, <span style="color:#e6db74">&#34;NVIDIA_VISIBLE_DEVICES=all&#34;</span>)
    }

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">nvidiaCaps</span> []<span style="color:#66d9ef">string</span>
    <span style="color:#75715e">// req.Capabilities contains device capabilities, some but not all are NVIDIA driver capabilities.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">dev</span>.<span style="color:#a6e22e">selectedCaps</span> {
        <span style="color:#a6e22e">nvcap</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">nvidia</span>.<span style="color:#a6e22e">Capability</span>(<span style="color:#a6e22e">c</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">isNvidiaCap</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">allNvidiaCaps</span>[<span style="color:#a6e22e">nvcap</span>]; <span style="color:#a6e22e">isNvidiaCap</span> {
            <span style="color:#a6e22e">nvidiaCaps</span> = append(<span style="color:#a6e22e">nvidiaCaps</span>, <span style="color:#a6e22e">c</span>)
            <span style="color:#66d9ef">continue</span>
        }
        <span style="color:#75715e">// TODO: nvidia.WithRequiredCUDAVersion
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// for now we let the prestart hook verify cuda versions but errors are not pretty.
</span><span style="color:#75715e"></span>    }

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">nvidiaCaps</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Env</span> = append(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Env</span>, <span style="color:#e6db74">&#34;NVIDIA_DRIVER_CAPABILITIES=&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">nvidiaCaps</span>, <span style="color:#e6db74">&#34;,&#34;</span>))
    }

    <span style="color:#a6e22e">path</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">LookPath</span>(<span style="color:#a6e22e">nvidiaHook</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Hooks</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Hooks</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Hooks</span>{}
    }
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Hooks</span>.<span style="color:#a6e22e">Prestart</span> = append(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Hooks</span>.<span style="color:#a6e22e">Prestart</span>, <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Hook</span>{
        <span style="color:#a6e22e">Path</span>: <span style="color:#a6e22e">path</span>,
        <span style="color:#a6e22e">Args</span>: []<span style="color:#66d9ef">string</span>{
            <span style="color:#a6e22e">nvidiaHook</span>,
            <span style="color:#e6db74">&#34;prestart&#34;</span>,
        },
        <span style="color:#a6e22e">Env</span>: <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Environ</span>(),
    })

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><hr>
<h3 id="46-进程运行用户-withuser">4.6 进程运行用户: WithUser</h3>
<p>根据用户指定的用户，从容器的<code>/etc/passwd</code>,<code>/etc/group</code>文件中读取对应的信息,传递至oci配置。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1003">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1003</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithUser</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">User</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">getUser</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">User</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L182">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L182</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getUser</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">username</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">User</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">usr</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">User</span>
    <span style="color:#a6e22e">passwdPath</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">resourcePath</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">GetPasswdPath</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">usr</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">groupPath</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">resourcePath</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">GetGroupPath</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">usr</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">execUser</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">GetExecUserPath</span>(<span style="color:#a6e22e">username</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">passwdPath</span>, <span style="color:#a6e22e">groupPath</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">usr</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">usr</span>.<span style="color:#a6e22e">UID</span> = uint32(<span style="color:#a6e22e">execUser</span>.<span style="color:#a6e22e">Uid</span>)
    <span style="color:#a6e22e">usr</span>.<span style="color:#a6e22e">GID</span> = uint32(<span style="color:#a6e22e">execUser</span>.<span style="color:#a6e22e">Gid</span>)

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">addGroups</span> []<span style="color:#66d9ef">int</span>
    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">GroupAdd</span>) &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#a6e22e">addGroups</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">GetAdditionalGroupsPath</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">GroupAdd</span>, <span style="color:#a6e22e">groupPath</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">usr</span>, <span style="color:#a6e22e">err</span>
        }
    }
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">g</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> append(<span style="color:#a6e22e">execUser</span>.<span style="color:#a6e22e">Sgids</span>, <span style="color:#a6e22e">addGroups</span><span style="color:#f92672">...</span>) {
        <span style="color:#a6e22e">usr</span>.<span style="color:#a6e22e">AdditionalGids</span> = append(<span style="color:#a6e22e">usr</span>.<span style="color:#a6e22e">AdditionalGids</span>, uint32(<span style="color:#a6e22e">g</span>))
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">usr</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><hr>
<h3 id="47-withrlimits">4.7 WithRlimits</h3>
<p>合并容器和dockerd的rlimits配置，传递之oci配置。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L42">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L42</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithRlimits</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rlimits</span> []<span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">POSIXRlimit</span>

        <span style="color:#75715e">// We want to leave the original HostConfig alone so make a copy here
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">hostConfig</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>
        <span style="color:#75715e">// Merge with the daemon defaults
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">mergeUlimits</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">hostConfig</span>)
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ul</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">hostConfig</span>.<span style="color:#a6e22e">Ulimits</span> {
            <span style="color:#a6e22e">rlimits</span> = append(<span style="color:#a6e22e">rlimits</span>, <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">POSIXRlimit</span>{
                <span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;RLIMIT_&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">ToUpper</span>(<span style="color:#a6e22e">ul</span>.<span style="color:#a6e22e">Name</span>),
                <span style="color:#a6e22e">Soft</span>: uint64(<span style="color:#a6e22e">ul</span>.<span style="color:#a6e22e">Soft</span>),
                <span style="color:#a6e22e">Hard</span>: uint64(<span style="color:#a6e22e">ul</span>.<span style="color:#a6e22e">Hard</span>),
            })
        }

        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Rlimits</span> = <span style="color:#a6e22e">rlimits</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
}
</code></pre></div><hr>
<h3 id="48-withnamespaces">4.8 WithNamespaces</h3>
<p>在<code>DefaultLinuxSpec()</code>函数中，已经设置了默认的namespace。在<code>WithNamespaces()</code>函数中将根据用户配置进行调整。</p>
<hr>
<p>设置oci配置中user namespace配置：</p>
<p><a href="https://github.com/moby/moby/blob/master/daemon/oci_linux.go#L230-L239">https://github.com/moby/moby/blob/master/daemon/oci_linux.go#L230-L239</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithNamespaces</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#a6e22e">userNS</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
        <span style="color:#75715e">// user
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">UsernsMode</span>.<span style="color:#a6e22e">IsPrivate</span>() {
            <span style="color:#a6e22e">uidMap</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">idMapping</span>.<span style="color:#a6e22e">UIDs</span>()
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">uidMap</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#a6e22e">userNS</span> = <span style="color:#66d9ef">true</span>
                <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxNamespace</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;user&#34;</span>}
                <span style="color:#a6e22e">setNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">ns</span>)
                <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">UIDMappings</span> = <span style="color:#a6e22e">specMapping</span>(<span style="color:#a6e22e">uidMap</span>)
                <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">GIDMappings</span> = <span style="color:#a6e22e">specMapping</span>(<span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">idMapping</span>.<span style="color:#a6e22e">GIDs</span>())
            }
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<ul>
<li>如果使用其他容器的network namespace, 将pid namespace的路径设置为该容器进程的ipc ns路径</li>
<li>如果使用宿主机的network namespace, 将network namespace的路径设置为<code>/var/run/docker/netns/default</code></li>
</ul>
<p><a href="https://github.com/moby/moby/blob/master/daemon/oci_linux.go#L241-L260">https://github.com/moby/moby/blob/master/daemon/oci_linux.go#L241-L260</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithNamespaces</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#75715e">// network
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">NetworkDisabled</span> {
            <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxNamespace</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;network&#34;</span>}
            <span style="color:#a6e22e">parts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">SplitN</span>(string(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">NetworkMode</span>), <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#ae81ff">2</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">parts</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;container&#34;</span> {
                <span style="color:#a6e22e">nc</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">getNetworkedContainer</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ID</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">NetworkMode</span>.<span style="color:#a6e22e">ConnectedContainer</span>())
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
                }
                <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">Path</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;/proc/%d/ns/net&#34;</span>, <span style="color:#a6e22e">nc</span>.<span style="color:#a6e22e">State</span>.<span style="color:#a6e22e">GetPID</span>())
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">userNS</span> {
                    <span style="color:#75715e">// to share a net namespace, they must also share a user namespace
</span><span style="color:#75715e"></span>                    <span style="color:#a6e22e">nsUser</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxNamespace</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;user&#34;</span>}
                    <span style="color:#a6e22e">nsUser</span>.<span style="color:#a6e22e">Path</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;/proc/%d/ns/user&#34;</span>, <span style="color:#a6e22e">nc</span>.<span style="color:#a6e22e">State</span>.<span style="color:#a6e22e">GetPID</span>())
                    <span style="color:#a6e22e">setNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">nsUser</span>)
                }
            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">NetworkMode</span>.<span style="color:#a6e22e">IsHost</span>() {
                <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">Path</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">NetworkSettings</span>.<span style="color:#a6e22e">SandboxKey</span>
            }
            <span style="color:#a6e22e">setNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">ns</span>)
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<ul>
<li>如果使用其他容器的ipc namespace， 将pid namespace的路径设置为该容器进程的ipc ns路径</li>
<li>如果使用素主机的ipc namespace，则从oci配置中移除ipc namespace</li>
<li>如果使用独立的ipc namespace，则将ipc namespace的Path变量置空</li>
</ul>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L260-L287">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L260-L287</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithNamespaces</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#75715e">// ipc
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">ipcMode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">IpcMode</span>
        <span style="color:#66d9ef">switch</span> {
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">IsContainer</span>():
            <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxNamespace</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;ipc&#34;</span>}
            <span style="color:#a6e22e">ic</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">getIpcContainer</span>(<span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">Container</span>())
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }
            <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">Path</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;/proc/%d/ns/ipc&#34;</span>, <span style="color:#a6e22e">ic</span>.<span style="color:#a6e22e">State</span>.<span style="color:#a6e22e">GetPID</span>())
            <span style="color:#a6e22e">setNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">ns</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">userNS</span> {
                <span style="color:#75715e">// to share an IPC namespace, they must also share a user namespace
</span><span style="color:#75715e"></span>                <span style="color:#a6e22e">nsUser</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxNamespace</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;user&#34;</span>}
                <span style="color:#a6e22e">nsUser</span>.<span style="color:#a6e22e">Path</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;/proc/%d/ns/user&#34;</span>, <span style="color:#a6e22e">ic</span>.<span style="color:#a6e22e">State</span>.<span style="color:#a6e22e">GetPID</span>())
                <span style="color:#a6e22e">setNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">nsUser</span>)
            }
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">IsHost</span>():
            <span style="color:#a6e22e">oci</span>.<span style="color:#a6e22e">RemoveNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;ipc&#34;</span>)
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">IsEmpty</span>():
            <span style="color:#75715e">// A container was created by an older version of the daemon.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// The default behavior used to be what is now called &#34;shareable&#34;.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">fallthrough</span>
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">IsPrivate</span>(), <span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">IsShareable</span>(), <span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">IsNone</span>():
            <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxNamespace</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;ipc&#34;</span>}
            <span style="color:#a6e22e">setNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">ns</span>)
        <span style="color:#66d9ef">default</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Invalid IPC mode: %v&#34;</span>, <span style="color:#a6e22e">ipcMode</span>)
        }
    }
}
</code></pre></div><hr>
<ul>
<li>如果使用其他容器的pid namespace, 将pid namespace的路径设置为该容器进程pid ns路径</li>
<li>如果使用宿主机的pid namespace, 则从oci配置中移除pid namespace</li>
<li>如果使用独立的pid namespace，则将pid namespace的<code>Path</code>变量置空</li>
</ul>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L290-L313">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L290-L313</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithNamespaces</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>        
        <span style="color:#75715e">// pid
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">PidMode</span>.<span style="color:#a6e22e">IsContainer</span>() {
            <span style="color:#a6e22e">pc</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">getPidContainer</span>(<span style="color:#a6e22e">c</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }
            <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxNamespace</span>{
                <span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;pid&#34;</span>,
                <span style="color:#a6e22e">Path</span>: <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;/proc/%d/ns/pid&#34;</span>, <span style="color:#a6e22e">pc</span>.<span style="color:#a6e22e">State</span>.<span style="color:#a6e22e">GetPID</span>()),
            }
            <span style="color:#a6e22e">setNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">ns</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">userNS</span> {
                <span style="color:#75715e">// to share a PID namespace, they must also share a user namespace
</span><span style="color:#75715e"></span>                <span style="color:#a6e22e">nsUser</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxNamespace</span>{
                    <span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;user&#34;</span>,
                    <span style="color:#a6e22e">Path</span>: <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;/proc/%d/ns/user&#34;</span>, <span style="color:#a6e22e">pc</span>.<span style="color:#a6e22e">State</span>.<span style="color:#a6e22e">GetPID</span>()),
                }
                <span style="color:#a6e22e">setNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">nsUser</span>)
            }
        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">PidMode</span>.<span style="color:#a6e22e">IsHost</span>() {
            <span style="color:#a6e22e">oci</span>.<span style="color:#a6e22e">RemoveNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;pid&#34;</span>)
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxNamespace</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;pid&#34;</span>}
            <span style="color:#a6e22e">setNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">ns</span>)
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>如果使用宿主机的UTS namespace，则从之前<code>DefaultLinuxSpec()</code>函数配置的namespace中移除uts namespace。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L315-L318">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L315-L318</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithNamespaces</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#75715e">// uts
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">UTSMode</span>.<span style="color:#a6e22e">IsHost</span>() {
            <span style="color:#a6e22e">oci</span>.<span style="color:#a6e22e">RemoveNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;uts&#34;</span>)
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Hostname</span> = <span style="color:#e6db74">&#34;&#34;</span>
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>设置cgroup namespace。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L321-L330">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L321-L330</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithNamespaces</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#75715e">// cgroup
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">CgroupnsMode</span>.<span style="color:#a6e22e">IsEmpty</span>() {
            <span style="color:#a6e22e">cgroupNsMode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">CgroupnsMode</span>
            <span style="color:#f92672">...</span>
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cgroupNsMode</span>.<span style="color:#a6e22e">IsPrivate</span>() {
                <span style="color:#a6e22e">nsCgroup</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxNamespace</span>{<span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;cgroup&#34;</span>}
                <span style="color:#a6e22e">setNamespace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">nsCgroup</span>)
            }
        }

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
}
</code></pre></div><hr>
<p>默认情况使用宿主机的cgroup namespace：</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/api/server/router/container/container_routes.go#L497-L502">https://github.com/moby/moby/blob/v20.10.14/api/server/router/container/container_routes.go#L497-L502</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containerRouter</span>) <span style="color:#a6e22e">postContainersCreate</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">vars</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">hostConfig</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">versions</span>.<span style="color:#a6e22e">LessThan</span>(<span style="color:#a6e22e">version</span>, <span style="color:#e6db74">&#34;1.41&#34;</span>) <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">cgroup2</span> {
        <span style="color:#75715e">// Older clients expect the default to be &#34;host&#34; on cgroup v1 hosts
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">hostConfig</span>.<span style="color:#a6e22e">CgroupnsMode</span>.<span style="color:#a6e22e">IsEmpty</span>() {
            <span style="color:#a6e22e">hostConfig</span>.<span style="color:#a6e22e">CgroupnsMode</span> = <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">CgroupnsMode</span>(<span style="color:#e6db74">&#34;host&#34;</span>)
        }
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>cgroup v2默认使用独立的cgroup namespace。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">adaptContainerSettings</span>(<span style="color:#a6e22e">hostConfig</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containertypes</span>.<span style="color:#a6e22e">HostConfig</span>, <span style="color:#a6e22e">adjustCPUShares</span> <span style="color:#66d9ef">bool</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">hostConfig</span>.<span style="color:#a6e22e">CgroupnsMode</span>.<span style="color:#a6e22e">IsEmpty</span>() {
        <span style="color:#75715e">// for cgroup v2: unshare cgroupns even for privileged containers
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// https://github.com/containers/libpod/pull/4374#issuecomment-549776387
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">hostConfig</span>.<span style="color:#a6e22e">Privileged</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">cgroups</span>.<span style="color:#a6e22e">Mode</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">cgroups</span>.<span style="color:#a6e22e">Unified</span> {
            <span style="color:#a6e22e">hostConfig</span>.<span style="color:#a6e22e">CgroupnsMode</span> = <span style="color:#a6e22e">containertypes</span>.<span style="color:#a6e22e">CgroupnsMode</span>(<span style="color:#e6db74">&#34;host&#34;</span>)
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;host&#34;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cgroups</span>.<span style="color:#a6e22e">Mode</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">cgroups</span>.<span style="color:#a6e22e">Unified</span> {
                <span style="color:#a6e22e">m</span> = <span style="color:#e6db74">&#34;private&#34;</span>
            }
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#a6e22e">m</span> = <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">CgroupNamespaceMode</span>
            }
            <span style="color:#a6e22e">hostConfig</span>.<span style="color:#a6e22e">CgroupnsMode</span> = <span style="color:#a6e22e">containertypes</span>.<span style="color:#a6e22e">CgroupnsMode</span>(<span style="color:#a6e22e">m</span>)
        }
    }
    <span style="color:#f92672">...</span>
}

</code></pre></div><hr>
<h3 id="49-withcapabilities">4.9 WithCapabilities</h3>
<p>整合用户的设置和默认capabilities, 更新oci配置。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L159">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L159</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithCapabilities</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#a6e22e">capabilities</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">caps</span>.<span style="color:#a6e22e">TweakCapabilities</span>(
            <span style="color:#a6e22e">caps</span>.<span style="color:#a6e22e">DefaultCapabilities</span>(),
            <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">CapAdd</span>,
            <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">CapDrop</span>,
            <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Privileged</span>,
        )
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">oci</span>.<span style="color:#a6e22e">SetCapabilities</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">capabilities</span>)
    }
}
</code></pre></div><hr>
<p>如果容器进程不是0, 仅设置Bounding，其他属性置空。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/oci/oci.go#L21">https://github.com/moby/moby/blob/v20.10.14/oci/oci.go#L21</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SetCapabilities</span>(<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>, <span style="color:#a6e22e">caplist</span> []<span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// setUser has already been executed here
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">UID</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Capabilities</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxCapabilities</span>{
            <span style="color:#a6e22e">Effective</span>: <span style="color:#a6e22e">caplist</span>,
            <span style="color:#a6e22e">Bounding</span>:  <span style="color:#a6e22e">caplist</span>,
            <span style="color:#a6e22e">Permitted</span>: <span style="color:#a6e22e">caplist</span>,
        }
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// Do not set Effective and Permitted capabilities for non-root users,
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// to match what execve does.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Capabilities</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxCapabilities</span>{
            <span style="color:#a6e22e">Bounding</span>: <span style="color:#a6e22e">caplist</span>,
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><hr>
<h3 id="410-将docker-seccomp规则转换成oci格式withseccomp">4.10 将docker seccomp规则转换成oci格式：WithSeccomp</h3>
<p>docker将seccomp规则与capability进行了结合，大大方便了seccomp的使用，在<code>WithSeccomp</code>函数中，将其转换成为了oci配置的格式。</p>
<hr>
<p>用户将seccomp配置为unconfined，或容器为特权容器，或内核不支持seccomp时，不设置oci的seccomp配置。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/seccomp_linux.go#L21-L34">https://github.com/moby/moby/blob/v20.10.14/daemon/seccomp_linux.go#L21-L34</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithSeccomp</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SeccompProfile</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;unconfined&#34;</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Privileged</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
        }
        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">seccompEnabled</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SeccompProfile</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;seccomp is not enabled in your kernel, cannot run a custom seccomp profile&#34;</span>)
            }
            <span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">Warn</span>(<span style="color:#e6db74">&#34;seccomp is not enabled in your kernel, running container without default profile&#34;</span>)
            <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SeccompProfile</span> = <span style="color:#e6db74">&#34;unconfined&#34;</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>依次以用户指定配置、daemon配置、默认规则顺序判断加载何种seccomp规则。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/seccomp_linux.go#L35-L44">https://github.com/moby/moby/blob/v20.10.14/daemon/seccomp_linux.go#L35-L44</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithSeccomp</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
        <span style="color:#66d9ef">switch</span> {
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SeccompProfile</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span>:
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Seccomp</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">seccomp</span>.<span style="color:#a6e22e">LoadProfile</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SeccompProfile</span>, <span style="color:#a6e22e">s</span>)
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">seccompProfile</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>:
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Seccomp</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">seccomp</span>.<span style="color:#a6e22e">LoadProfile</span>(string(<span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">seccompProfile</span>), <span style="color:#a6e22e">s</span>)
        <span style="color:#66d9ef">default</span>:
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Seccomp</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">seccomp</span>.<span style="color:#a6e22e">GetDefaultProfile</span>(<span style="color:#a6e22e">s</span>)
        }
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
}
</code></pre></div><hr>
<p>加载seccomp规则，并将其转换为oci格式。</p>
<p><a href="https://github.com/moby/moby/blob/master/profiles/seccomp/seccomp_linux.go#L20">https://github.com/moby/moby/blob/master/profiles/seccomp/seccomp_linux.go#L20</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">LoadProfile</span>(<span style="color:#a6e22e">body</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">rs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxSeccomp</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">config</span> <span style="color:#a6e22e">Seccomp</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>([]byte(<span style="color:#a6e22e">body</span>), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">config</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Decoding seccomp profile failed: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">setupSeccomp</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">config</span>, <span style="color:#a6e22e">rs</span>)
}
</code></pre></div><hr>
<p>设置对系统调用的默认行为，docker的seccomp默认规则中，该值为<code>SCMP_ACT_ERRNO</code>， 作用是导致Permission Denied错误。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/profiles/seccomp/seccomp_linux.go#L109">https://github.com/moby/moby/blob/v20.10.14/profiles/seccomp/seccomp_linux.go#L109</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">setupSeccomp</span>(<span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Seccomp</span>, <span style="color:#a6e22e">rs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxSeccomp</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">newConfig</span>.<span style="color:#a6e22e">DefaultAction</span> = <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">DefaultAction</span>
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>这项配置在runc中用来传递给C的<code>seccomp_init</code>函数。</p>
<p><a href="https://github.com/opencontainers/runc/blob/v1.0.3/libcontainer/seccomp/seccomp_linux.go#L44">https://github.com/opencontainers/runc/blob/v1.0.3/libcontainer/seccomp/seccomp_linux.go#L44</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">InitSeccomp</span>(<span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">configs</span>.<span style="color:#a6e22e">Seccomp</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">filter</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">libseccomp</span>.<span style="color:#a6e22e">NewFilter</span>(<span style="color:#a6e22e">defaultAction</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/opencontainers/runc/blob/v1.0.3/vendor/github.com/seccomp/libseccomp-golang/seccomp.go#L512">https://github.com/opencontainers/runc/blob/v1.0.3/vendor/github.com/seccomp/libseccomp-golang/seccomp.go#L512</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewFilter</span>(<span style="color:#a6e22e">defaultAction</span> <span style="color:#a6e22e">ScmpAction</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ScmpFilter</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">fPtr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">seccomp_init</span>(<span style="color:#a6e22e">defaultAction</span>.<span style="color:#a6e22e">toNative</span>())
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>docker的seccomp配置中，每条规则结构如下。其中includes, excludes参数定义了过滤规则。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/profiles/seccomp/seccomp.go#L44">https://github.com/moby/moby/blob/v20.10.14/profiles/seccomp/seccomp.go#L44</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Syscall</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">Name</span>     <span style="color:#66d9ef">string</span>                   <span style="color:#e6db74">`json:&#34;name,omitempty&#34;`</span>
    <span style="color:#a6e22e">Names</span>    []<span style="color:#66d9ef">string</span>                 <span style="color:#e6db74">`json:&#34;names,omitempty&#34;`</span>
    <span style="color:#a6e22e">Action</span>   <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxSeccompAction</span> <span style="color:#e6db74">`json:&#34;action&#34;`</span>
    <span style="color:#a6e22e">ErrnoRet</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">uint</span>                    <span style="color:#e6db74">`json:&#34;errnoRet,omitempty&#34;`</span>
    <span style="color:#a6e22e">Args</span>     []<span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxSeccompArg</span> <span style="color:#e6db74">`json:&#34;args&#34;`</span>
    <span style="color:#a6e22e">Comment</span>  <span style="color:#66d9ef">string</span>                   <span style="color:#e6db74">`json:&#34;comment&#34;`</span>
    <span style="color:#a6e22e">Includes</span> <span style="color:#a6e22e">Filter</span>                   <span style="color:#e6db74">`json:&#34;includes&#34;`</span>
    <span style="color:#a6e22e">Excludes</span> <span style="color:#a6e22e">Filter</span>                   <span style="color:#e6db74">`json:&#34;excludes&#34;`</span>
}
</code></pre></div><hr>
<p>如果容器的capability中包含存在于Excludes变量中的任一capability, 或者docker软件编译时的架构存在于Excludes变量中的arches列表，或容器运行时的kernel版本高于或等于Excludes变量中的MinKernel参数，则跳过该条seccomp规则，则跳过该条seccomp规则；</p>
<p>如果docker软件编译时的架构不存在于Includes变量中的Arches列表中，或容器运行时的capability中不包含存在于Includes变量中的任一capability，或容器运行时的kernel版本低于Includes变量中的MinKernel参数，则跳过该条seccomp规则。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/profiles/seccomp/seccomp_linux.go#L113-L151">https://github.com/moby/moby/blob/v20.10.14/profiles/seccomp/seccomp_linux.go#L113-L151</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">setupSeccomp</span>(<span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Seccomp</span>, <span style="color:#a6e22e">rs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxSeccomp</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">Loop</span>:
    <span style="color:#75715e">// Loop through all syscall blocks and convert them to libcontainer format after filtering them
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">call</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Syscalls</span> {
        <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Excludes</span>.<span style="color:#a6e22e">Arches</span>) &gt; <span style="color:#ae81ff">0</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">inSlice</span>(<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Excludes</span>.<span style="color:#a6e22e">Arches</span>, <span style="color:#a6e22e">arch</span>) {
                <span style="color:#66d9ef">continue</span> <span style="color:#a6e22e">Loop</span>
            }
        }
        <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Excludes</span>.<span style="color:#a6e22e">Caps</span>) &gt; <span style="color:#ae81ff">0</span> {
            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Excludes</span>.<span style="color:#a6e22e">Caps</span> {
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">inSlice</span>(<span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Capabilities</span>.<span style="color:#a6e22e">Bounding</span>, <span style="color:#a6e22e">c</span>) {
                    <span style="color:#66d9ef">continue</span> <span style="color:#a6e22e">Loop</span>
                }
            }
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Excludes</span>.<span style="color:#a6e22e">MinKernel</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kernelGreaterEqualThan</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Excludes</span>.<span style="color:#a6e22e">MinKernel</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
                <span style="color:#66d9ef">continue</span> <span style="color:#a6e22e">Loop</span>
            }
        }
        <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Includes</span>.<span style="color:#a6e22e">Arches</span>) &gt; <span style="color:#ae81ff">0</span> {
            <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">inSlice</span>(<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Includes</span>.<span style="color:#a6e22e">Arches</span>, <span style="color:#a6e22e">arch</span>) {
                <span style="color:#66d9ef">continue</span> <span style="color:#a6e22e">Loop</span>
            }
        }
        <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Includes</span>.<span style="color:#a6e22e">Caps</span>) &gt; <span style="color:#ae81ff">0</span> {
            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Includes</span>.<span style="color:#a6e22e">Caps</span> {
                <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">inSlice</span>(<span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Capabilities</span>.<span style="color:#a6e22e">Bounding</span>, <span style="color:#a6e22e">c</span>) {
                    <span style="color:#66d9ef">continue</span> <span style="color:#a6e22e">Loop</span>
                }
            }
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Includes</span>.<span style="color:#a6e22e">MinKernel</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kernelGreaterEqualThan</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Includes</span>.<span style="color:#a6e22e">MinKernel</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
                <span style="color:#66d9ef">continue</span> <span style="color:#a6e22e">Loop</span>
            }
        }
        <span style="color:#f92672">...</span>
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>现在将docker软件的seccomp配置的每个syscall规则，转换成oci配置的格式，结构和转换过程如下：</p>
<p><a href="https://github.com/opencontainers/runc/blob/v1.0.3/vendor/github.com/opencontainers/runtime-spec/specs-go/config.go#L679">https://github.com/opencontainers/runc/blob/v1.0.3/vendor/github.com/opencontainers/runtime-spec/specs-go/config.go#L679</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">LinuxSyscall</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Names</span>    []<span style="color:#66d9ef">string</span>           <span style="color:#e6db74">`json:&#34;names&#34;`</span>
	<span style="color:#a6e22e">Action</span>   <span style="color:#a6e22e">LinuxSeccompAction</span> <span style="color:#e6db74">`json:&#34;action&#34;`</span>
	<span style="color:#a6e22e">ErrnoRet</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">uint</span>              <span style="color:#e6db74">`json:&#34;errnoRet,omitempty&#34;`</span>
	<span style="color:#a6e22e">Args</span>     []<span style="color:#a6e22e">LinuxSeccompArg</span>  <span style="color:#e6db74">`json:&#34;args,omitempty&#34;`</span>
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/profiles/seccomp/seccomp_linux.go#L153-L174">https://github.com/moby/moby/blob/v20.10.14/profiles/seccomp/seccomp_linux.go#L153-L174</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">setupSeccomp</span>(<span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Seccomp</span>, <span style="color:#a6e22e">rs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxSeccomp</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">Loop</span>:
    <span style="color:#75715e">// Loop through all syscall blocks and convert them to libcontainer format after filtering them
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">call</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Syscalls</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">newCall</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">LinuxSyscall</span>{
            <span style="color:#a6e22e">Action</span>:   <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Action</span>,
            <span style="color:#a6e22e">ErrnoRet</span>: <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">ErrnoRet</span>,
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Names</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;&#39;name&#39; and &#39;names&#39; were specified in the seccomp profile, use either &#39;name&#39; or &#39;names&#39;&#34;</span>)
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
            <span style="color:#a6e22e">newCall</span>.<span style="color:#a6e22e">Names</span> = []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Name</span>}
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">newCall</span>.<span style="color:#a6e22e">Names</span> = <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Names</span>
        }
        <span style="color:#75715e">// Loop through all the arguments of the syscall and convert them
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">arg</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Args</span> {
            <span style="color:#a6e22e">newCall</span>.<span style="color:#a6e22e">Args</span> = append(<span style="color:#a6e22e">newCall</span>.<span style="color:#a6e22e">Args</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">arg</span>)
        }

        <span style="color:#a6e22e">newConfig</span>.<span style="color:#a6e22e">Syscalls</span> = append(<span style="color:#a6e22e">newConfig</span>.<span style="color:#a6e22e">Syscalls</span>, <span style="color:#a6e22e">newCall</span>)
    }

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newConfig</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><hr>
<h3 id="411-withmounts">4.11 WithMounts</h3>
<h4 id="4111-创建工作目录mounts">4.11.1 创建工作目录：mounts</h4>
<p>在容器的工作目录创建mounts目录（形如<code>/var/lib/docker/containers/{CONTAINER_ID}/mounts</code>），后续部分文件会先挂载到该目录，再挂载到容器rootfs。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L486-L488">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L486-L488</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">setupContainerMountsRoot</span>(<span style="color:#a6e22e">c</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L455">https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L455</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">setupContainerMountsRoot</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">// get the root mount path so we can make it unbindable
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MountsResourcePath</span>(<span style="color:#e6db74">&#34;&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">idtools</span>.<span style="color:#a6e22e">MkdirAllAndChown</span>(<span style="color:#a6e22e">p</span>, <span style="color:#ae81ff">0710</span>, <span style="color:#a6e22e">idtools</span>.<span style="color:#a6e22e">Identity</span>{<span style="color:#a6e22e">UID</span>: <span style="color:#a6e22e">idtools</span>.<span style="color:#a6e22e">CurrentIdentity</span>().<span style="color:#a6e22e">UID</span>, <span style="color:#a6e22e">GID</span>: <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">IdentityMapping</span>().<span style="color:#a6e22e">RootPair</span>().<span style="color:#a6e22e">GID</span>})
}
</code></pre></div><hr>
<h4 id="4112-创建工作目录shm">4.11.2 创建工作目录：shm</h4>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L490-L492">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L490-L492</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">setupIpcDirs</span>(<span style="color:#a6e22e">c</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><p>docker在创建容器时，可以通过<code>--ipc</code>参数，指定容器使用私有或共享的ipc。</p>
<ul>
<li>如果共享其他容器或宿主机的IPC，在<code>setupIpcDirs</code>函数中，将容器的<code>ShmPath</code>属性更新为要共享的路径。</li>
<li>如果使用私有的IPC或不使用IPC，则将<code>ShmPath</code>置空。</li>
<li>如果IPC模式为<code>shareable</code>，则可以向其他容器共享IPC。创建shm工作目录，路径形如<code>/var/lib/docker/containers/{CONTAINER_ID}/mounts/shm</code>，然后将shm挂载至该路径，并将容器的<code>ShmPath</code>属性设置为该路径。后续该路径将以bind模式被挂载至容器rootfs。</li>
</ul>
<p>设置<code>ShmPath</code>属性，是为了其他容器在试图共享该容器的IPC时可以得知shm路径。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L106">https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L106</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">setupIpcDirs</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">ipcMode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">IpcMode</span>

    <span style="color:#66d9ef">switch</span> {
    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">IsContainer</span>():
        <span style="color:#a6e22e">ic</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">getIpcContainer</span>(<span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">Container</span>())
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ShmPath</span> = <span style="color:#a6e22e">ic</span>.<span style="color:#a6e22e">ShmPath</span>

    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">IsHost</span>():
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#e6db74">&#34;/dev/shm&#34;</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;/dev/shm is not mounted, but must be for --ipc=host&#34;</span>)
        }
        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ShmPath</span> = <span style="color:#e6db74">&#34;/dev/shm&#34;</span>

    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">IsPrivate</span>(), <span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">IsNone</span>():
        <span style="color:#75715e">// c.ShmPath will/should not be used, so make it empty.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Container&#39;s /dev/shm mount comes from OCI spec.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ShmPath</span> = <span style="color:#e6db74">&#34;&#34;</span>

    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">IsEmpty</span>():
        <span style="color:#75715e">// A container was created by an older version of the daemon.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// The default behavior used to be what is now called &#34;shareable&#34;.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">fallthrough</span>

    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ipcMode</span>.<span style="color:#a6e22e">IsShareable</span>():
        <span style="color:#a6e22e">rootIDs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">idMapping</span>.<span style="color:#a6e22e">RootPair</span>()
        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HasMountFor</span>(<span style="color:#e6db74">&#34;/dev/shm&#34;</span>) {
            <span style="color:#a6e22e">shmPath</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ShmResourcePath</span>()
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }

            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">idtools</span>.<span style="color:#a6e22e">MkdirAllAndChown</span>(<span style="color:#a6e22e">shmPath</span>, <span style="color:#ae81ff">0700</span>, <span style="color:#a6e22e">rootIDs</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }

            <span style="color:#a6e22e">shmproperty</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;mode=1777,size=&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">FormatInt</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">ShmSize</span>, <span style="color:#ae81ff">10</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">Mount</span>(<span style="color:#e6db74">&#34;shm&#34;</span>, <span style="color:#a6e22e">shmPath</span>, <span style="color:#e6db74">&#34;tmpfs&#34;</span>, uintptr(<span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">MS_NOEXEC</span>|<span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">MS_NOSUID</span>|<span style="color:#a6e22e">unix</span>.<span style="color:#a6e22e">MS_NODEV</span>), <span style="color:#a6e22e">label</span>.<span style="color:#a6e22e">FormatMountLabel</span>(<span style="color:#a6e22e">shmproperty</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetMountLabel</span>())); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;mounting shm tmpfs: %s&#34;</span>, <span style="color:#a6e22e">err</span>)
            }
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Chown</span>(<span style="color:#a6e22e">shmPath</span>, <span style="color:#a6e22e">rootIDs</span>.<span style="color:#a6e22e">UID</span>, <span style="color:#a6e22e">rootIDs</span>.<span style="color:#a6e22e">GID</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }
            <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ShmPath</span> = <span style="color:#a6e22e">shmPath</span>
        }

    <span style="color:#66d9ef">default</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;invalid IPC mode: %v&#34;</span>, <span style="color:#a6e22e">ipcMode</span>)
    }

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><hr>
<h4 id="4113-设置工作目录secret">4.11.3 设置工作目录：secret</h4>
<p>secret是swarm集群的功能，它将以文件形式被挂载至容器rootfs内。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L494-L502">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L494-L502</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">cleanupSecretDir</span>(<span style="color:#a6e22e">c</span>)
            }
        }()

        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">setupSecretDir</span>(<span style="color:#a6e22e">c</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>创建secret工作目录，路径形如<code>/var/lib/docker/containers/{CONTAINER_ID}/mounts/secrets</code>，并将tmpfs挂载至该路径。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L163-L174">https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L163-L174</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">setupSecretDir</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) (<span style="color:#a6e22e">setupErr</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SecretReferences</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConfigReferences</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">createSecretsDir</span>(<span style="color:#a6e22e">c</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
    <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">setupErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">cleanupSecretDir</span>(<span style="color:#a6e22e">c</span>)
        }
    }()
    <span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L285">https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L285</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">createSecretsDir</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// retrieve possible remapped range start for root UID, GID
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rootIDs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">idMapping</span>.<span style="color:#a6e22e">RootPair</span>()
    <span style="color:#a6e22e">dir</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SecretMountPath</span>()
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error getting container secrets dir&#34;</span>)
    }

    <span style="color:#75715e">// create tmpfs
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">idtools</span>.<span style="color:#a6e22e">MkdirAllAndChown</span>(<span style="color:#a6e22e">dir</span>, <span style="color:#ae81ff">0700</span>, <span style="color:#a6e22e">rootIDs</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error creating secret local mount path&#34;</span>)
    }

    <span style="color:#a6e22e">tmpfsOwnership</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;uid=%d,gid=%d&#34;</span>, <span style="color:#a6e22e">rootIDs</span>.<span style="color:#a6e22e">UID</span>, <span style="color:#a6e22e">rootIDs</span>.<span style="color:#a6e22e">GID</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">Mount</span>(<span style="color:#e6db74">&#34;tmpfs&#34;</span>, <span style="color:#a6e22e">dir</span>, <span style="color:#e6db74">&#34;tmpfs&#34;</span>, <span style="color:#e6db74">&#34;nodev,nosuid,noexec,&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">tmpfsOwnership</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to setup secret mount&#34;</span>)
    }
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><hr>
<p>将secret内容写入到<code>/var/lib/docker/containers/{CONTAINER_ID}/mounts/secrets/{SECRET_ID}</code></p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L183-L227">https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L183-L227</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">setupSecretDir</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) (<span style="color:#a6e22e">setupErr</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SecretReferences</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">fPath</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SecretFilePath</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>)
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">secret</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">DependencyStore</span>.<span style="color:#a6e22e">Secrets</span>().<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SecretID</span>)
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">WriteFile</span>(<span style="color:#a6e22e">fPath</span>, <span style="color:#a6e22e">secret</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Data</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">File</span>.<span style="color:#a6e22e">Mode</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Chown</span>(<span style="color:#a6e22e">fPath</span>, <span style="color:#a6e22e">rootIDs</span>.<span style="color:#a6e22e">UID</span><span style="color:#f92672">+</span><span style="color:#a6e22e">uid</span>, <span style="color:#a6e22e">rootIDs</span>.<span style="color:#a6e22e">GID</span><span style="color:#f92672">+</span><span style="color:#a6e22e">gid</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error setting ownership for secret&#34;</span>)
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Chmod</span>(<span style="color:#a6e22e">fPath</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">File</span>.<span style="color:#a6e22e">Mode</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error setting file mode for secret&#34;</span>)
        }
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>docker swarm另外还支持通过<code>--config</code>参数向容器注入config，因为其支持go语言的模板引擎，<a href="https://github.com/moby/moby/pull/33702">有可能在config中引入secret</a>, 因此，config文件也将写入secrets工作目录，具体路径形如<code>/var/lib/docker/containers/{CONTAINER_ID}/mounts/secrets/{CONFIG_ID}</code>。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L229-L278">https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L229-L278</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">setupSecretDir</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) (<span style="color:#a6e22e">setupErr</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">configRef</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConfigReferences</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">fPath</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConfigFilePath</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">configRef</span>)
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">idtools</span>.<span style="color:#a6e22e">MkdirAllAndChown</span>(<span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Dir</span>(<span style="color:#a6e22e">fPath</span>), <span style="color:#ae81ff">0700</span>, <span style="color:#a6e22e">rootIDs</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">config</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">DependencyStore</span>.<span style="color:#a6e22e">Configs</span>().<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">configRef</span>.<span style="color:#a6e22e">ConfigID</span>)
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">WriteFile</span>(<span style="color:#a6e22e">fPath</span>, <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Data</span>, <span style="color:#a6e22e">configRef</span>.<span style="color:#a6e22e">File</span>.<span style="color:#a6e22e">Mode</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error injecting config&#34;</span>)
        }

        <span style="color:#a6e22e">uid</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">configRef</span>.<span style="color:#a6e22e">File</span>.<span style="color:#a6e22e">UID</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">gid</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">configRef</span>.<span style="color:#a6e22e">File</span>.<span style="color:#a6e22e">GID</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }

        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Chown</span>(<span style="color:#a6e22e">fPath</span>, <span style="color:#a6e22e">rootIDs</span>.<span style="color:#a6e22e">UID</span><span style="color:#f92672">+</span><span style="color:#a6e22e">uid</span>, <span style="color:#a6e22e">rootIDs</span>.<span style="color:#a6e22e">GID</span><span style="color:#f92672">+</span><span style="color:#a6e22e">gid</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error setting ownership for config&#34;</span>)
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Chmod</span>(<span style="color:#a6e22e">fPath</span>, <span style="color:#a6e22e">configRef</span>.<span style="color:#a6e22e">File</span>.<span style="color:#a6e22e">Mode</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error setting file mode for config&#34;</span>)
        }
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>secret文件写入完毕，以只读方式重新挂载secrets工作目录。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L280">https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L280</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">setupSecretDir</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) (<span style="color:#a6e22e">setupErr</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">remountSecretDir</span>(<span style="color:#a6e22e">c</span>)
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L305">https://github.com/moby/moby/blob/v20.10.14/daemon/container_operations_unix.go#L305</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">remountSecretDir</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">dir</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SecretMountPath</span>()
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error getting container secrets path&#34;</span>)
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">label</span>.<span style="color:#a6e22e">Relabel</span>(<span style="color:#a6e22e">dir</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MountLabel</span>, <span style="color:#66d9ef">false</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">WithError</span>(<span style="color:#a6e22e">err</span>).<span style="color:#a6e22e">WithField</span>(<span style="color:#e6db74">&#34;dir&#34;</span>, <span style="color:#a6e22e">dir</span>).<span style="color:#a6e22e">Warn</span>(<span style="color:#e6db74">&#34;Error while attempting to set selinux label&#34;</span>)
    }
    <span style="color:#a6e22e">rootIDs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">idMapping</span>.<span style="color:#a6e22e">RootPair</span>()
    <span style="color:#a6e22e">tmpfsOwnership</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;uid=%d,gid=%d&#34;</span>, <span style="color:#a6e22e">rootIDs</span>.<span style="color:#a6e22e">UID</span>, <span style="color:#a6e22e">rootIDs</span>.<span style="color:#a6e22e">GID</span>)

    <span style="color:#75715e">// remount secrets ro
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">Mount</span>(<span style="color:#e6db74">&#34;tmpfs&#34;</span>, <span style="color:#a6e22e">dir</span>, <span style="color:#e6db74">&#34;tmpfs&#34;</span>, <span style="color:#e6db74">&#34;remount,ro,&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">tmpfsOwnership</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to remount dir as readonly&#34;</span>)
    }

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><hr>
<h4 id="4114-setupmounts">4.11.4 setupMounts</h4>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L504-L507">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L504-L507</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">setupMounts</span>(<span style="color:#a6e22e">c</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>遍历容器的挂载点，对每个挂载点调用<code>MountPoint.Setup()</code>方法。跳过tmpfs类型的挂载点，其中tmpfs从容器的HostConfig和MountPoints中收集而来。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/volumes_unix.go#L25-L36">https://github.com/moby/moby/blob/v20.10.14/daemon/volumes_unix.go#L25-L36</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">setupMounts</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) ([]<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Mount</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">mounts</span> []<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Mount</span>
    <span style="color:#75715e">// TODO: tmpfs mounts should be part of Mountpoints
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">tmpfsMounts</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">bool</span>)
    <span style="color:#a6e22e">tmpfsMountInfo</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">TmpfsMounts</span>()
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tmpfsMountInfo</span> {
        <span style="color:#a6e22e">tmpfsMounts</span>[<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span>] = <span style="color:#66d9ef">true</span>
    }
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MountPoints</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tmpfsMounts</span>[<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span>] {
            <span style="color:#66d9ef">continue</span>
        }
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">path</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Setup</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MountLabel</span>, <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">idMapping</span>.<span style="color:#a6e22e">RootPair</span>(), <span style="color:#a6e22e">checkfunc</span>)
        <span style="color:#f92672">...</span>
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L421">https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L421</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">container</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">TmpfsMounts</span>() ([]<span style="color:#a6e22e">Mount</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">parser</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">volumemounts</span>.<span style="color:#a6e22e">NewParser</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">OS</span>)
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">mounts</span> []<span style="color:#a6e22e">Mount</span>
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">dest</span>, <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Tmpfs</span> {
        <span style="color:#a6e22e">mounts</span> = append(<span style="color:#a6e22e">mounts</span>, <span style="color:#a6e22e">Mount</span>{
            <span style="color:#a6e22e">Source</span>:      <span style="color:#e6db74">&#34;tmpfs&#34;</span>,
            <span style="color:#a6e22e">Destination</span>: <span style="color:#a6e22e">dest</span>,
            <span style="color:#a6e22e">Data</span>:        <span style="color:#a6e22e">data</span>,
        })
    }
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">dest</span>, <span style="color:#a6e22e">mnt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">MountPoints</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mnt</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">mounttypes</span>.<span style="color:#a6e22e">TypeTmpfs</span> {
            <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ConvertTmpfsOptions</span>(<span style="color:#a6e22e">mnt</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">TmpfsOptions</span>, <span style="color:#a6e22e">mnt</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">ReadOnly</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
            }
            <span style="color:#a6e22e">mounts</span> = append(<span style="color:#a6e22e">mounts</span>, <span style="color:#a6e22e">Mount</span>{
                <span style="color:#a6e22e">Source</span>:      <span style="color:#e6db74">&#34;tmpfs&#34;</span>,
                <span style="color:#a6e22e">Destination</span>: <span style="color:#a6e22e">dest</span>,
                <span style="color:#a6e22e">Data</span>:        <span style="color:#a6e22e">data</span>,
            })
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mounts</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><hr>
<p><code>MountPoint.Setup()</code>方法用于准备挂载点的源路径。</p>
<p>如果挂载点是卷，则根据卷类型各自的方法挂载卷，返回卷路径。</p>
<p>如果挂载点不是卷类型，通过bind mount挂载（仅使用<code>-v</code>或<code>--volume</code>参数，不含使用<code>--mount</code>的情况），则创建并修改源路径。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/volume/mounts/mounts.go#L98">https://github.com/moby/moby/blob/v20.10.14/volume/mounts/mounts.go#L98</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MountPoint</span>) <span style="color:#a6e22e">Setup</span>(<span style="color:#a6e22e">mountLabel</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">rootIDs</span> <span style="color:#a6e22e">idtools</span>.<span style="color:#a6e22e">Identity</span>, <span style="color:#a6e22e">checkFun</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MountPoint</span>) <span style="color:#66d9ef">error</span>) (<span style="color:#a6e22e">path</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">SkipMountpointCreation</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#66d9ef">nil</span>
    }
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Volume</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">ID</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
            <span style="color:#a6e22e">id</span> = <span style="color:#a6e22e">stringid</span>.<span style="color:#a6e22e">GenerateRandomID</span>()
        }
        <span style="color:#a6e22e">path</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Volume</span>.<span style="color:#a6e22e">Mount</span>(<span style="color:#a6e22e">id</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrapf</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error while mounting volume &#39;%s&#39;&#34;</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Source</span>)
        }

        <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">ID</span> = <span style="color:#a6e22e">id</span>
        <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">active</span><span style="color:#f92672">++</span>
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">path</span>, <span style="color:#66d9ef">nil</span>
    }
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">mounttypes</span>.<span style="color:#a6e22e">TypeBind</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">idtools</span>.<span style="color:#a6e22e">MkdirAllAndChownNew</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#ae81ff">0755</span>, <span style="color:#a6e22e">rootIDs</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#f92672">...</span>
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><hr>
<p>将挂载点添加至mounts变量中。如果挂载点的目的路径是网络相关的文件，则暂不处理，仅设置对应的容器属性。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/volumes_unix.go#L55-L76">https://github.com/moby/moby/blob/v20.10.14/daemon/volumes_unix.go#L55-L76</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">setupMounts</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) ([]<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Mount</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MountPoints</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">TrySetNetworkMount</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span>, <span style="color:#a6e22e">path</span>) {
            <span style="color:#a6e22e">mnt</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Mount</span>{
                <span style="color:#a6e22e">Source</span>:      <span style="color:#a6e22e">path</span>,
                <span style="color:#a6e22e">Destination</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span>,
                <span style="color:#a6e22e">Writable</span>:    <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">RW</span>,
                <span style="color:#a6e22e">Propagation</span>: string(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Propagation</span>),
            }
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">mounttypes</span>.<span style="color:#a6e22e">TypeBind</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">BindOptions</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#a6e22e">mnt</span>.<span style="color:#a6e22e">NonRecursive</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">BindOptions</span>.<span style="color:#a6e22e">NonRecursive</span>
            }
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Volume</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#a6e22e">attributes</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
                    <span style="color:#e6db74">&#34;driver&#34;</span>:      <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Volume</span>.<span style="color:#a6e22e">DriverName</span>(),
                    <span style="color:#e6db74">&#34;container&#34;</span>:   <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ID</span>,
                    <span style="color:#e6db74">&#34;destination&#34;</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span>,
                    <span style="color:#e6db74">&#34;read/write&#34;</span>:  <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">FormatBool</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">RW</span>),
                    <span style="color:#e6db74">&#34;propagation&#34;</span>: string(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Propagation</span>),
                }
                <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">LogVolumeEvent</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Volume</span>.<span style="color:#a6e22e">Name</span>(), <span style="color:#e6db74">&#34;mount&#34;</span>, <span style="color:#a6e22e">attributes</span>)
            }
            <span style="color:#a6e22e">mounts</span> = append(<span style="color:#a6e22e">mounts</span>, <span style="color:#a6e22e">mnt</span>)
        }
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L36">https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L36</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">container</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">TrySetNetworkMount</span>(<span style="color:#a6e22e">destination</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">path</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">destination</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;/etc/resolv.conf&#34;</span> {
        <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">ResolvConfPath</span> = <span style="color:#a6e22e">path</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">destination</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;/etc/hostname&#34;</span> {
        <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostnamePath</span> = <span style="color:#a6e22e">path</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">destination</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;/etc/hosts&#34;</span> {
        <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostsPath</span> = <span style="color:#a6e22e">path</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
    }

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
}
</code></pre></div><hr>
<p>对mounts变量按照目录层级进行排序，避免出现子目录先于父级目录被挂载的情况。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/volumes_unix.go#L79">https://github.com/moby/moby/blob/v20.10.14/daemon/volumes_unix.go#L79</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">setupMounts</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) ([]<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Mount</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MountPoints</span> {
        <span style="color:#f92672">...</span>
    }
    <span style="color:#a6e22e">mounts</span> = <span style="color:#a6e22e">sortMounts</span>(<span style="color:#a6e22e">mounts</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/volumes_unix.go#L101">https://github.com/moby/moby/blob/v20.10.14/daemon/volumes_unix.go#L101</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">sortMounts</span>(<span style="color:#a6e22e">m</span> []<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Mount</span>) []<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Mount</span> {
    <span style="color:#a6e22e">sort</span>.<span style="color:#a6e22e">Sort</span>(<span style="color:#a6e22e">mounts</span>(<span style="color:#a6e22e">m</span>))
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>
}
</code></pre></div><hr>
<p>将<code>/etc/resolv.conf</code>,<code>/etc/hostname</code>,<code>/etc/hosts</code>添加到挂载列表中。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/volumes_unix.go#L80-L95">https://github.com/moby/moby/blob/v20.10.14/daemon/volumes_unix.go#L80-L95</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">setupMounts</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) ([]<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Mount</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">netMounts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">NetworkMounts</span>()
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">rootIDs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">idMapping</span>.<span style="color:#a6e22e">RootPair</span>()
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">mnt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">netMounts</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Index</span>(<span style="color:#a6e22e">mnt</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">repository</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Chown</span>(<span style="color:#a6e22e">mnt</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#a6e22e">rootIDs</span>.<span style="color:#a6e22e">UID</span>, <span style="color:#a6e22e">rootIDs</span>.<span style="color:#a6e22e">GID</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
            }
        }
    }
    <span style="color:#66d9ef">return</span> append(<span style="color:#a6e22e">mounts</span>, <span style="color:#a6e22e">netMounts</span><span style="color:#f92672">...</span>), <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L64">https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L64</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">container</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">NetworkMounts</span>() []<span style="color:#a6e22e">Mount</span> {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">mounts</span> []<span style="color:#a6e22e">Mount</span>
    <span style="color:#a6e22e">shared</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">NetworkMode</span>.<span style="color:#a6e22e">IsContainer</span>()
    <span style="color:#a6e22e">parser</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">volumemounts</span>.<span style="color:#a6e22e">NewParser</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">OS</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">ResolvConfPath</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">ResolvConfPath</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;ResolvConfPath set to %q, but can&#39;t stat this filename (err = %v); skipping&#34;</span>, <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">ResolvConfPath</span>, <span style="color:#a6e22e">err</span>)
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">writable</span> <span style="color:#f92672">:=</span> !<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">ReadonlyRootfs</span>
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">MountPoints</span>[<span style="color:#e6db74">&#34;/etc/resolv.conf&#34;</span>]; <span style="color:#a6e22e">exists</span> {
                <span style="color:#a6e22e">writable</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">RW</span>
            } <span style="color:#66d9ef">else</span> {
                <span style="color:#a6e22e">label</span>.<span style="color:#a6e22e">Relabel</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">ResolvConfPath</span>, <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">MountLabel</span>, <span style="color:#a6e22e">shared</span>)
            }
            <span style="color:#a6e22e">mounts</span> = append(<span style="color:#a6e22e">mounts</span>, <span style="color:#a6e22e">Mount</span>{
                <span style="color:#a6e22e">Source</span>:      <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">ResolvConfPath</span>,
                <span style="color:#a6e22e">Destination</span>: <span style="color:#e6db74">&#34;/etc/resolv.conf&#34;</span>,
                <span style="color:#a6e22e">Writable</span>:    <span style="color:#a6e22e">writable</span>,
                <span style="color:#a6e22e">Propagation</span>: string(<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">DefaultPropagationMode</span>()),
            })
        }
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostnamePath</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostnamePath</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;HostnamePath set to %q, but can&#39;t stat this filename (err = %v); skipping&#34;</span>, <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostnamePath</span>, <span style="color:#a6e22e">err</span>)
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">writable</span> <span style="color:#f92672">:=</span> !<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">ReadonlyRootfs</span>
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">MountPoints</span>[<span style="color:#e6db74">&#34;/etc/hostname&#34;</span>]; <span style="color:#a6e22e">exists</span> {
                <span style="color:#a6e22e">writable</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">RW</span>
            } <span style="color:#66d9ef">else</span> {
                <span style="color:#a6e22e">label</span>.<span style="color:#a6e22e">Relabel</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostnamePath</span>, <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">MountLabel</span>, <span style="color:#a6e22e">shared</span>)
            }
            <span style="color:#a6e22e">mounts</span> = append(<span style="color:#a6e22e">mounts</span>, <span style="color:#a6e22e">Mount</span>{
                <span style="color:#a6e22e">Source</span>:      <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostnamePath</span>,
                <span style="color:#a6e22e">Destination</span>: <span style="color:#e6db74">&#34;/etc/hostname&#34;</span>,
                <span style="color:#a6e22e">Writable</span>:    <span style="color:#a6e22e">writable</span>,
                <span style="color:#a6e22e">Propagation</span>: string(<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">DefaultPropagationMode</span>()),
            })
        }
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostsPath</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostsPath</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;HostsPath set to %q, but can&#39;t stat this filename (err = %v); skipping&#34;</span>, <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostsPath</span>, <span style="color:#a6e22e">err</span>)
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">writable</span> <span style="color:#f92672">:=</span> !<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">ReadonlyRootfs</span>
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">MountPoints</span>[<span style="color:#e6db74">&#34;/etc/hosts&#34;</span>]; <span style="color:#a6e22e">exists</span> {
                <span style="color:#a6e22e">writable</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">RW</span>
            } <span style="color:#66d9ef">else</span> {
                <span style="color:#a6e22e">label</span>.<span style="color:#a6e22e">Relabel</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostsPath</span>, <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">MountLabel</span>, <span style="color:#a6e22e">shared</span>)
            }
            <span style="color:#a6e22e">mounts</span> = append(<span style="color:#a6e22e">mounts</span>, <span style="color:#a6e22e">Mount</span>{
                <span style="color:#a6e22e">Source</span>:      <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostsPath</span>,
                <span style="color:#a6e22e">Destination</span>: <span style="color:#e6db74">&#34;/etc/hosts&#34;</span>,
                <span style="color:#a6e22e">Writable</span>:    <span style="color:#a6e22e">writable</span>,
                <span style="color:#a6e22e">Propagation</span>: string(<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">DefaultPropagationMode</span>()),
            })
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mounts</span>
}
</code></pre></div><hr>
<h4 id="4115-添加ipc挂载点">4.11.5 添加IPC挂载点</h4>
<p>将IPC挂载点添加到mount列表中。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L509-L511">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L509-L511</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">IpcMode</span>.<span style="color:#a6e22e">IsPrivate</span>() <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">IpcMode</span>.<span style="color:#a6e22e">IsEmpty</span>() {
            <span style="color:#a6e22e">ms</span> = append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">IpcMounts</span>()<span style="color:#f92672">...</span>)
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L200">https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L200</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">container</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">IpcMounts</span>() []<span style="color:#a6e22e">Mount</span> {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">mounts</span> []<span style="color:#a6e22e">Mount</span>
    <span style="color:#a6e22e">parser</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">volumemounts</span>.<span style="color:#a6e22e">NewParser</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">OS</span>)

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HasMountFor</span>(<span style="color:#e6db74">&#34;/dev/shm&#34;</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mounts</span>
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">ShmPath</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mounts</span>
    }

    <span style="color:#a6e22e">label</span>.<span style="color:#a6e22e">SetFileLabel</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">ShmPath</span>, <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">MountLabel</span>)
    <span style="color:#a6e22e">mounts</span> = append(<span style="color:#a6e22e">mounts</span>, <span style="color:#a6e22e">Mount</span>{
        <span style="color:#a6e22e">Source</span>:      <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">ShmPath</span>,
        <span style="color:#a6e22e">Destination</span>: <span style="color:#e6db74">&#34;/dev/shm&#34;</span>,
        <span style="color:#a6e22e">Writable</span>:    <span style="color:#66d9ef">true</span>,
        <span style="color:#a6e22e">Propagation</span>: string(<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">DefaultPropagationMode</span>()),
    })

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mounts</span>
}
</code></pre></div><hr>
<h4 id="4116-tmpfsmounts-添加用户设置的tmpfs挂载点">4.11.6 TmpfsMounts(): 添加用户设置的tmpfs挂载点</h4>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L513-L517">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L513-L517</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">tmpfsMounts</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">TmpfsMounts</span>()
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">ms</span> = append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">tmpfsMounts</span><span style="color:#f92672">...</span>)
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>参考<a href="https://docs.docker.com/storage/tmpfs/#use-a-tmpfs-mount-in-a-container">docker官方文档</a>，用户可以通过<code>--tmpfs</code>或<code>--mount type=tmpfs,destination=</code>参数指定要挂载的tmpfs。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L421">https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L421</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">container</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">TmpfsMounts</span>() ([]<span style="color:#a6e22e">Mount</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">parser</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">volumemounts</span>.<span style="color:#a6e22e">NewParser</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">OS</span>)
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">mounts</span> []<span style="color:#a6e22e">Mount</span>
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">dest</span>, <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Tmpfs</span> {
        <span style="color:#a6e22e">mounts</span> = append(<span style="color:#a6e22e">mounts</span>, <span style="color:#a6e22e">Mount</span>{
            <span style="color:#a6e22e">Source</span>:      <span style="color:#e6db74">&#34;tmpfs&#34;</span>,
            <span style="color:#a6e22e">Destination</span>: <span style="color:#a6e22e">dest</span>,
            <span style="color:#a6e22e">Data</span>:        <span style="color:#a6e22e">data</span>,
        })
    }
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">dest</span>, <span style="color:#a6e22e">mnt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">MountPoints</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mnt</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">mounttypes</span>.<span style="color:#a6e22e">TypeTmpfs</span> {
            <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ConvertTmpfsOptions</span>(<span style="color:#a6e22e">mnt</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">TmpfsOptions</span>, <span style="color:#a6e22e">mnt</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">ReadOnly</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
            }
            <span style="color:#a6e22e">mounts</span> = append(<span style="color:#a6e22e">mounts</span>, <span style="color:#a6e22e">Mount</span>{
                <span style="color:#a6e22e">Source</span>:      <span style="color:#e6db74">&#34;tmpfs&#34;</span>,
                <span style="color:#a6e22e">Destination</span>: <span style="color:#a6e22e">dest</span>,
                <span style="color:#a6e22e">Data</span>:        <span style="color:#a6e22e">data</span>,
            })
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mounts</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h4 id="4117-添加secret挂载点">4.11.7 添加secret挂载点</h4>
<p>在4.11.3节中，已完成对secret工作目录的设置，现将secret挂载点添加至mount列表中。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L519-L523">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L519-L523</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">secretMounts</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SecretMounts</span>()
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">ms</span> = append(<span style="color:#a6e22e">ms</span>, <span style="color:#a6e22e">secretMounts</span><span style="color:#f92672">...</span>)
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L223">https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L223</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">container</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">SecretMounts</span>() ([]<span style="color:#a6e22e">Mount</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">mounts</span> []<span style="color:#a6e22e">Mount</span>
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">SecretReferences</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">File</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">continue</span>
        }
        <span style="color:#a6e22e">src</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">SecretFilePath</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">r</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">mounts</span> = append(<span style="color:#a6e22e">mounts</span>, <span style="color:#a6e22e">Mount</span>{
            <span style="color:#a6e22e">Source</span>:      <span style="color:#a6e22e">src</span>,
            <span style="color:#a6e22e">Destination</span>: <span style="color:#a6e22e">getSecretTargetPath</span>(<span style="color:#a6e22e">r</span>),
            <span style="color:#a6e22e">Writable</span>:    <span style="color:#66d9ef">false</span>,
        })
    }
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">ConfigReferences</span> {
        <span style="color:#a6e22e">fPath</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">ConfigFilePath</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">r</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">mounts</span> = append(<span style="color:#a6e22e">mounts</span>, <span style="color:#a6e22e">Mount</span>{
            <span style="color:#a6e22e">Source</span>:      <span style="color:#a6e22e">fPath</span>,
            <span style="color:#a6e22e">Destination</span>: <span style="color:#a6e22e">getConfigTargetPath</span>(<span style="color:#a6e22e">r</span>),
            <span style="color:#a6e22e">Writable</span>:    <span style="color:#66d9ef">false</span>,
        })
    }

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mounts</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><hr>
<p>其中secret,config的目的路径分别为<code>/run/secrets</code>，<code>/</code>。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L30-L31">https://github.com/moby/moby/blob/v20.10.14/container/container_unix.go#L30-L31</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">const</span> (
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">containerConfigMountPath</span> = <span style="color:#e6db74">&#34;/&#34;</span>
    <span style="color:#a6e22e">containerSecretMountPath</span> = <span style="color:#e6db74">&#34;/run/secrets&#34;</span>
)
</code></pre></div><h4 id="4118-合并用户指定的挂载点和默认挂载点">4.11.8 合并用户指定的挂载点和默认挂载点</h4>
<p>首先对挂载点排序，避免出现子目录先于父级目录被挂载的情况。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L525">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L525</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">sort</span>.<span style="color:#a6e22e">Sort</span>(<span style="color:#a6e22e">mounts</span>(<span style="color:#a6e22e">ms</span>))
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>更新已有的oci配置中的mount列表，移除以下挂载点：</p>
<ul>
<li>用户指定的相同路径的挂载点</li>
<li>用户挂载了dev目录，则移除dev目录下所有的挂载点</li>
<li>如果用户设置IpcMode为空，则移除<code>/dev/shm</code></li>
</ul>
<p>另外设置了<code>/dev/shm</code>挂载选项中的size选项。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L527-L565">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L527-L565</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">mounts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ms</span>

        <span style="color:#a6e22e">userMounts</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">struct</span>{})
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">mounts</span> {
            <span style="color:#a6e22e">userMounts</span>[<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span>] = <span style="color:#66d9ef">struct</span>{}{}
        }

        <span style="color:#a6e22e">defaultMounts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span>[:<span style="color:#ae81ff">0</span>]
        <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">mountDev</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userMounts</span>[<span style="color:#e6db74">&#34;/dev&#34;</span>]
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userMounts</span>[<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span>]; <span style="color:#a6e22e">ok</span> {
                <span style="color:#75715e">// filter out mount overridden by a user supplied mount
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">continue</span>
            }
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mountDev</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span>, <span style="color:#e6db74">&#34;/dev/&#34;</span>) {
                <span style="color:#75715e">// filter out everything under /dev if /dev is user-mounted
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">continue</span>
            }

            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;/dev/shm&#34;</span> {
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">IpcMode</span>.<span style="color:#a6e22e">IsNone</span>() {
                    <span style="color:#75715e">// filter out /dev/shm for &#34;none&#34; IpcMode
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">continue</span>
                }
                <span style="color:#75715e">// set size for /dev/shm mount from spec
</span><span style="color:#75715e"></span>                <span style="color:#a6e22e">sizeOpt</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;size=&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">FormatInt</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">ShmSize</span>, <span style="color:#ae81ff">10</span>)
                <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Options</span> = append(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Options</span>, <span style="color:#a6e22e">sizeOpt</span>)
            }

            <span style="color:#a6e22e">defaultMounts</span> = append(<span style="color:#a6e22e">defaultMounts</span>, <span style="color:#a6e22e">m</span>)
        }

        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span> = <span style="color:#a6e22e">defaultMounts</span>
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>再遍历用户指定的挂载点，合并到oci配置中。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L566">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L566</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">mounts</span> {
            <span style="color:#f92672">...</span>
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>如果挂载源是tmpfs，需要额外添加一些挂载选项。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L567-L582">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L567-L582</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">mounts</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Source</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;tmpfs&#34;</span> {
                <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Data</span>
                <span style="color:#a6e22e">parser</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">volumemounts</span>.<span style="color:#a6e22e">NewParser</span>(<span style="color:#e6db74">&#34;linux&#34;</span>)
                <span style="color:#a6e22e">options</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;noexec&#34;</span>, <span style="color:#e6db74">&#34;nosuid&#34;</span>, <span style="color:#e6db74">&#34;nodev&#34;</span>, string(<span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">DefaultPropagationMode</span>())}
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
                    <span style="color:#a6e22e">options</span> = append(<span style="color:#a6e22e">options</span>, <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">data</span>, <span style="color:#e6db74">&#34;,&#34;</span>)<span style="color:#f92672">...</span>)
                }

                <span style="color:#a6e22e">merged</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">MergeTmpfsOptions</span>(<span style="color:#a6e22e">options</span>)
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
                }

                <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span> = append(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span>, <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Mount</span>{<span style="color:#a6e22e">Destination</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span>, <span style="color:#a6e22e">Source</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;tmpfs&#34;</span>, <span style="color:#a6e22e">Options</span>: <span style="color:#a6e22e">merged</span>})
                <span style="color:#66d9ef">continue</span>
            }
            <span style="color:#f92672">...</span>
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>对其他类型挂载源，使用<code>bind mount</code>，并设置rootfs的传播模式。</p>
<ul>
<li>如果挂载点为<code>SHARED</code>或<code>RSHARED</code>模式，则将rootfs的传播模式也设置为<code>SHARED</code>。</li>
<li>如果挂载点为<code>SLAVE</code>或<code>RSLAVE</code>模式，则将rootfs的传播模式设置为<code>RSLAVE</code>。</li>
</ul>
<p>如果开启了userns, 还要另外保留一些挂载选项。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L584-L660">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L584-L660</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">mounts</span> {
            <span style="color:#f92672">...</span>
            <span style="color:#a6e22e">mt</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Mount</span>{<span style="color:#a6e22e">Destination</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span>, <span style="color:#a6e22e">Source</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#a6e22e">Type</span>: <span style="color:#e6db74">&#34;bind&#34;</span>}
            <span style="color:#f92672">...</span>
            <span style="color:#a6e22e">pFlag</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mountPropagationMap</span>[<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Propagation</span>]
            <span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">pFlag</span> {
            <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">SHARED</span>, <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">RSHARED</span>:
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ensureShared</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Source</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
                }
                <span style="color:#a6e22e">rootpg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mountPropagationMap</span>[<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">RootfsPropagation</span>]
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rootpg</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">SHARED</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">rootpg</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">RSHARED</span> {
                    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">RootfsPropagation</span> = <span style="color:#a6e22e">mountPropagationReverseMap</span>[<span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">SHARED</span>]
                }
            <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">SLAVE</span>, <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">RSLAVE</span>:
                <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fallback</span> <span style="color:#66d9ef">bool</span>
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ensureSharedOrSlave</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Source</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#f92672">...</span>
                    <span style="color:#a6e22e">fallback</span> = <span style="color:#66d9ef">true</span>
                    <span style="color:#f92672">...</span>
                }
                <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">fallback</span> {
                    <span style="color:#a6e22e">rootpg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mountPropagationMap</span>[<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">RootfsPropagation</span>]
                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rootpg</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">SHARED</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">rootpg</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">RSHARED</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">rootpg</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">SLAVE</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">rootpg</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">RSLAVE</span> {
                        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">RootfsPropagation</span> = <span style="color:#a6e22e">mountPropagationReverseMap</span>[<span style="color:#a6e22e">mount</span>.<span style="color:#a6e22e">RSLAVE</span>]
                    }
                }
            }

            <span style="color:#a6e22e">bindMode</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;rbind&#34;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">NonRecursive</span> {
                <span style="color:#a6e22e">bindMode</span> = <span style="color:#e6db74">&#34;bind&#34;</span>
            }
            <span style="color:#a6e22e">opts</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">bindMode</span>}
            <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Writable</span> {
                <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>, <span style="color:#e6db74">&#34;ro&#34;</span>)
            }
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pFlag</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
                <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">mountPropagationReverseMap</span>[<span style="color:#a6e22e">pFlag</span>])
            }
            <span style="color:#f92672">...</span>
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">RemappedRoot</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">RunningInUserNS</span>() {
                <span style="color:#a6e22e">unprivOpts</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getUnprivilegedMountFlags</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Source</span>)
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
                }
                <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">unprivOpts</span><span style="color:#f92672">...</span>)
            }

            <span style="color:#a6e22e">mt</span>.<span style="color:#a6e22e">Options</span> = <span style="color:#a6e22e">opts</span>
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span> = append(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span>, <span style="color:#a6e22e">mt</span>)
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<h4 id="4119-只读挂载选项">4.11.9 只读挂载选项</h4>
<p>用户可使用<code>docker run --read-only</code>选项，设置容器的rootfs为只读。如果配置了该选项，除了部分挂载点及用户指定的挂载点，docker默认的挂载点都将被设置只读选项。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L663-L675">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L663-L675</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>        
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Root</span>.<span style="color:#a6e22e">Readonly</span> {
            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span> {
                <span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span> {
                <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;/proc&#34;</span>, <span style="color:#e6db74">&#34;/dev/pts&#34;</span>, <span style="color:#e6db74">&#34;/dev/shm&#34;</span>, <span style="color:#e6db74">&#34;/dev/mqueue&#34;</span>, <span style="color:#e6db74">&#34;/dev&#34;</span>:
                    <span style="color:#66d9ef">continue</span>
                }
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userMounts</span>[<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Destination</span>]; !<span style="color:#a6e22e">ok</span> {
                    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">inSlice</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Options</span>, <span style="color:#e6db74">&#34;ro&#34;</span>) {
                        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Options</span> = append(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Options</span>, <span style="color:#e6db74">&#34;ro&#34;</span>)
                    }
                }
            }
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>如果用户设置了特权选项<code>--privileged</code>, 则移除对<code>/sys</code>挂载点的只读选项。</p>
<p>因为<code>/proc</code>和<code>/sys</code>目录下有一些敏感的文件，docker默认通过oci的<code>Linux.ReadonlyPaths</code>和<code>Linux.MaskedPaths</code>配置对相关路径进行了保护。如果开启了特权选项，也一并移除。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L677-L686">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L677-L686</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>  
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Privileged</span> {
            <span style="color:#75715e">// clear readonly for /sys
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span> {
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Destination</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;/sys&#34;</span> {
                    <span style="color:#a6e22e">clearReadOnly</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span>[<span style="color:#a6e22e">i</span>])
                }
            }
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">ReadonlyPaths</span> = <span style="color:#66d9ef">nil</span>
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">MaskedPaths</span> = <span style="color:#66d9ef">nil</span>
        }
        <span style="color:#f92672">...</span>
    }
}
</code></pre></div><hr>
<p>如果用户开启了user namespace, 或特权选项，移除cgroup的只读保护。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L690-L696">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L690-L696</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithMounts</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>  
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">uidMap</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">idMapping</span>.<span style="color:#a6e22e">UIDs</span>(); <span style="color:#a6e22e">uidMap</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Privileged</span> {
            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span> {
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;cgroup&#34;</span> {
                    <span style="color:#a6e22e">clearReadOnly</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Mounts</span>[<span style="color:#a6e22e">i</span>])
                }
            }
        }

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>

    }
}
</code></pre></div><h2 id="412-设置libnetwork-hook-withlibnetwork">4.12 设置libnetwork hook: WithLibnetwork</h2>
<p>向runc的prestart hook中添加libnetwork-setkey命令。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L64">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L64</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithLibnetwork</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Hooks</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Hooks</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Hooks</span>{}
        }
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Namespaces</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;network&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">Path</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">NetworkDisabled</span> {
                <span style="color:#a6e22e">target</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#e6db74">&#34;/proc&#34;</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getpid</span>()), <span style="color:#e6db74">&#34;exe&#34;</span>)
                <span style="color:#a6e22e">shortNetCtlrID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">stringid</span>.<span style="color:#a6e22e">TruncateID</span>(<span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">netController</span>.<span style="color:#a6e22e">ID</span>())
                <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Hooks</span>.<span style="color:#a6e22e">Prestart</span> = append(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Hooks</span>.<span style="color:#a6e22e">Prestart</span>, <span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Hook</span>{
                    <span style="color:#a6e22e">Path</span>: <span style="color:#a6e22e">target</span>,
                    <span style="color:#a6e22e">Args</span>: []<span style="color:#66d9ef">string</span>{
                        <span style="color:#e6db74">&#34;libnetwork-setkey&#34;</span>,
                        <span style="color:#e6db74">&#34;-exec-root=&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">GetExecRoot</span>(),
                        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ID</span>,
                        <span style="color:#a6e22e">shortNetCtlrID</span>,
                    },
                })
            }
        }
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
}
</code></pre></div><hr>
<p>其中libnetwork-setkey是以reexec模式实现的docker子命令，关于该命令实现的源码分析，我们在<a href="">TODO: docker reexec libnetwork-setkey子命令源码分析</a>一文中详细展开。</p>
<h2 id="413-设置oci配置中的apparmor规则withapparmor">4.13 设置oci配置中的apparmor规则：WithApparmor</h2>
<p>将容器的apparmor规则传递至oci配置中。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L129">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L129</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithApparmor</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">apparmor</span>.<span style="color:#a6e22e">IsEnabled</span>() {
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">appArmorProfile</span> <span style="color:#66d9ef">string</span>
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AppArmorProfile</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
                <span style="color:#a6e22e">appArmorProfile</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">AppArmorProfile</span>
            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">Privileged</span> {
                <span style="color:#a6e22e">appArmorProfile</span> = <span style="color:#a6e22e">unconfinedAppArmorProfile</span>
            } <span style="color:#66d9ef">else</span> {
                <span style="color:#a6e22e">appArmorProfile</span> = <span style="color:#a6e22e">defaultAppArmorProfile</span>
            }

            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">appArmorProfile</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">defaultAppArmorProfile</span> {
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ensureDefaultAppArmorProfile</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
                }
            }
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">ApparmorProfile</span> = <span style="color:#a6e22e">appArmorProfile</span>
        }
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
}
</code></pre></div><h2 id="414-设置oci配置中的selinux标签withselinux">4.14 设置oci配置中的selinux标签：WithSelinux</h2>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L120">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L120</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithSelinux</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">SelinuxLabel</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetProcessLabel</span>()
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">MountLabel</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MountLabel</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
}
</code></pre></div><h2 id="415-设置oom优先级-withoomscore">4.15 设置OOM优先级: WithOOMScore</h2>
<p>为了便于控制，内核引入了<code>/proc/&lt;pid&gt;/oom_adj</code>，以避免系统中的重要进程被杀死，并定义了进程被杀死的顺序。</p>
<p>docker可以通过<code>--oom-score-adj</code>选项设置该参数。此处，将该配置传递给oci配置。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1031">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1031</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">createSpec</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) (<span style="color:#a6e22e">retSpec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>,
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">WithOOMScore</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">OomScoreAdj</span>),
    )
</code></pre></div><p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L112">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L112</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithOOMScore</span>(<span style="color:#a6e22e">score</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">int</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">OOMScoreAdj</span> = <span style="color:#a6e22e">score</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
}
</code></pre></div><h2 id="416-nonewprivileges">4.16 NoNewPrivileges</h2>
<p>如果通过dockerd的<code>--no-new-privileges</code>参数，或容器创建时的<code>--security-opt=no-new-privileges</code>参数，可以使容器内普通进程无法通过suid/sgid，文件capability等方式获得父进程没有的权限。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1033-L1035">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1033-L1035</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">createSpec</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) (<span style="color:#a6e22e">retSpec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">NoNewPrivileges</span> {
        <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">WithNoNewPrivileges</span>)
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>此处将该选项传递给oci配置。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/vendor/github.com/containerd/containerd/oci/spec_opts.go#L416">https://github.com/moby/moby/blob/v20.10.14/vendor/github.com/containerd/containerd/oci/spec_opts.go#L416</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithNoNewPrivileges</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">setProcess</span>(<span style="color:#a6e22e">s</span>)
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">NoNewPrivileges</span> = <span style="color:#66d9ef">true</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h2 id="417-设置保护路径">4.17 设置保护路径</h2>
<p>将受保护的系统路径传递至oci配置。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1038-L1043">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1038-L1043</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">createSpec</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) (<span style="color:#a6e22e">retSpec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">MaskedPaths</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">WithMaskedPaths</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">MaskedPaths</span>))
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">ReadonlyPaths</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">WithReadonlyPaths</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HostConfig</span>.<span style="color:#a6e22e">ReadonlyPaths</span>))
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><h2 id="418-rootless-cgroup">4.18 rootless cgroup</h2>
<p>如果dockerd运行在rootless模式, 更新cgroup规则。</p>
<p>目前，<a href="https://docs.docker.com/engine/security/rootless/#limiting-resources">在rootless模式下，cgroup相关的资源限制选项仅支持cgroup v2和systemd</a>。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1044-L1046">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L1044-L1046</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">createSpec</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>) (<span style="color:#a6e22e">retSpec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">configStore</span>.<span style="color:#a6e22e">Rootless</span> {
        <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">WithRootless</span>(<span style="color:#a6e22e">daemon</span>))
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>根据rootless运行的用户支持的controller，更新oci中的配置。其中，可用的controller，从文件<code>/sys/fs/cgroup/user.slice/user-$(id -u).slice/user@$(id -u).service/cgroup.controllers</code>中读取，默认仅支持memory, pids。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L89">https://github.com/moby/moby/blob/v20.10.14/daemon/oci_linux.go#L89</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithRootless</span>(<span style="color:#a6e22e">daemon</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Daemon</span>) <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">SpecOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">coci</span>.<span style="color:#a6e22e">Spec</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">v2Controllers</span> []<span style="color:#66d9ef">string</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">getCgroupDriver</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">cgroupSystemdDriver</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cdcgroups</span>.<span style="color:#a6e22e">Mode</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">cdcgroups</span>.<span style="color:#a6e22e">Unified</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;rootless systemd driver doesn&#39;t support cgroup v1&#34;</span>)
            }
            <span style="color:#a6e22e">rootlesskitParentEUID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;ROOTLESSKIT_PARENT_EUID&#34;</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rootlesskitParentEUID</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;$ROOTLESSKIT_PARENT_EUID is not set (requires RootlessKit v0.8.0)&#34;</span>)
            }
            <span style="color:#a6e22e">controllersPath</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;/sys/fs/cgroup/user.slice/user-%s.slice/cgroup.controllers&#34;</span>, <span style="color:#a6e22e">rootlesskitParentEUID</span>)
            <span style="color:#a6e22e">controllersFile</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#a6e22e">controllersPath</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }
            <span style="color:#a6e22e">v2Controllers</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Fields</span>(string(<span style="color:#a6e22e">controllersFile</span>))
        }
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">specconv</span>.<span style="color:#a6e22e">ToRootless</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">v2Controllers</span>)
    }
}
</code></pre></div><hr>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/rootless/specconv/specconv_linux.go#L17">https://github.com/moby/moby/blob/v20.10.14/rootless/specconv/specconv_linux.go#L17</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ToRootless</span>(<span style="color:#a6e22e">spec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>, <span style="color:#a6e22e">v2Controllers</span> []<span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">toRootless</span>(<span style="color:#a6e22e">spec</span>, <span style="color:#a6e22e">v2Controllers</span>, <span style="color:#a6e22e">getCurrentOOMScoreAdj</span>())
}
</code></pre></div><hr>
<p>在oci配置中移除不支持的资源限制策略。</p>
<p><a href="https://github.com/moby/moby/blob/v20.10.14/rootless/specconv/specconv_linux.go#L36">https://github.com/moby/moby/blob/v20.10.14/rootless/specconv/specconv_linux.go#L36</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">toRootless</span>(<span style="color:#a6e22e">spec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Spec</span>, <span style="color:#a6e22e">v2Controllers</span> []<span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">currentOOMScoreAdj</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">v2Controllers</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
        <span style="color:#75715e">// Remove cgroup settings.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span> = <span style="color:#66d9ef">nil</span>
        <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">CgroupsPath</span> = <span style="color:#e6db74">&#34;&#34;</span>
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">struct</span>{})
            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">v2Controllers</span> {
                <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">s</span>] = <span style="color:#66d9ef">struct</span>{}{}
            }
            <span style="color:#75715e">// Remove devices: https://github.com/containers/crun/issues/255
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">Devices</span> = <span style="color:#66d9ef">nil</span>
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>[<span style="color:#e6db74">&#34;memory&#34;</span>]; !<span style="color:#a6e22e">ok</span> {
                <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">Memory</span> = <span style="color:#66d9ef">nil</span>
            }
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>[<span style="color:#e6db74">&#34;cpu&#34;</span>]; !<span style="color:#a6e22e">ok</span> {
                <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">CPU</span> = <span style="color:#66d9ef">nil</span>
            }
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>[<span style="color:#e6db74">&#34;cpuset&#34;</span>]; !<span style="color:#a6e22e">ok</span> {
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">CPU</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">CPU</span>.<span style="color:#a6e22e">Cpus</span> = <span style="color:#e6db74">&#34;&#34;</span>
                    <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">CPU</span>.<span style="color:#a6e22e">Mems</span> = <span style="color:#e6db74">&#34;&#34;</span>
                }
            }
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>[<span style="color:#e6db74">&#34;pids&#34;</span>]; !<span style="color:#a6e22e">ok</span> {
                <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">Pids</span> = <span style="color:#66d9ef">nil</span>
            }
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>[<span style="color:#e6db74">&#34;io&#34;</span>]; !<span style="color:#a6e22e">ok</span> {
                <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">BlockIO</span> = <span style="color:#66d9ef">nil</span>
            }
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>[<span style="color:#e6db74">&#34;rdma&#34;</span>]; !<span style="color:#a6e22e">ok</span> {
                <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">Rdma</span> = <span style="color:#66d9ef">nil</span>
            }
            <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">HugepageLimits</span> = <span style="color:#66d9ef">nil</span>
            <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Linux</span>.<span style="color:#a6e22e">Resources</span>.<span style="color:#a6e22e">Network</span> = <span style="color:#66d9ef">nil</span>
        }
    }

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">OOMScoreAdj</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">OOMScoreAdj</span> &lt; <span style="color:#a6e22e">currentOOMScoreAdj</span> {
        <span style="color:#f92672">*</span><span style="color:#a6e22e">spec</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">OOMScoreAdj</span> = <span style="color:#a6e22e">currentOOMScoreAdj</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div>
            </div>
        </article>

        <hr />

        <div class="post-info">
  			</div>

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2022</span>
            
            <span></span>
            <span> <a href="/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/st0n3">st0n3</a></span>
            <span>Based on <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      extensions: ["tex2jax.js"],
      
      jax: ["input/TeX", "output/CommonHTML"],
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
      },
      "HTML-CSS": { fonts: ["TeX"] },
      displayAlign: "left"
    });
  </script>

<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_CHTML"></script>


</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.4c3fb12a087ceed4a52cb5d57068a9795c7069617a01ca70f788052ad66e1791779e6c72686e1dc0ca13dc03b0203204b6566bb0dd1ee80de2b7ff4d8fe53db2.js" integrity="sha512-TD&#43;xKgh87tSlLLXVcGipeVxwaWF6Acpw94gFKtZuF5F3nmxyaG4dwMoT3AOwIDIEtlZrsN0e6A3it/9Nj&#43;U9sg=="></script>



    </body>
</html>
