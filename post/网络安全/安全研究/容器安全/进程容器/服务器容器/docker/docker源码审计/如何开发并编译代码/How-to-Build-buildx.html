<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="">
<meta name="description"
    content="tags: container,buildx How to Build buildx 1. Buildx buildx 是 docker 的一个插件，docker buildx 子命令会执行 buildx 二进制文件。本文分析如何自己编译 buildx 。
2. Standard Build 官方文档提供了标准的编译方法：https://github.com/docker/buildx#building
# Buildx 0.6&#43; $ docker buildx bake &amp;#34;https://github.com/docker/buildx.git&amp;#34; $ mkdir -p ~/.docker/cli-plugins $ mv ./bin/build/buildx ~/.docker/cli-plugins/docker-buildx # Docker 19.03&#43; $ DOCKER_BUILDKIT=1 docker build --platform=local -o . &amp;#34;https://github.com/docker/buildx.git&amp;#34; $ mkdir -p ~/.docker/cli-plugins $ mv buildx ~/.docker/cli-plugins/docker-buildx # Local $ git clone https://github.com/docker/buildx.git &amp;amp;&amp;amp; cd buildx $ make install 3." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/docker%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1/%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E5%B9%B6%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81/How-to-Build-buildx.html" />


<title>
    
    How to Build buildx :: welcome to st0n3&#39;s blog 
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.de959d61dd13c2cd41136acd491ffb0749779e1afe37b1fed6d5cba0b7e1938d.css">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#252627"><meta itemprop="name" content="How to Build buildx">
<meta itemprop="description" content="tags: container,buildx How to Build buildx 1. Buildx buildx 是 docker 的一个插件，docker buildx 子命令会执行 buildx 二进制文件。本文分析如何自己编译 buildx 。
2. Standard Build 官方文档提供了标准的编译方法：https://github.com/docker/buildx#building
# Buildx 0.6&#43; $ docker buildx bake &#34;https://github.com/docker/buildx.git&#34; $ mkdir -p ~/.docker/cli-plugins $ mv ./bin/build/buildx ~/.docker/cli-plugins/docker-buildx # Docker 19.03&#43; $ DOCKER_BUILDKIT=1 docker build --platform=local -o . &#34;https://github.com/docker/buildx.git&#34; $ mkdir -p ~/.docker/cli-plugins $ mv buildx ~/.docker/cli-plugins/docker-buildx # Local $ git clone https://github.com/docker/buildx.git &amp;&amp; cd buildx $ make install 3.">
<meta itemprop="datePublished" content="2023-02-14T05:22:28+00:00" />
<meta itemprop="dateModified" content="2023-02-14T05:22:28+00:00" />
<meta itemprop="wordCount" content="369">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to Build buildx"/>
<meta name="twitter:description" content="tags: container,buildx How to Build buildx 1. Buildx buildx 是 docker 的一个插件，docker buildx 子命令会执行 buildx 二进制文件。本文分析如何自己编译 buildx 。
2. Standard Build 官方文档提供了标准的编译方法：https://github.com/docker/buildx#building
# Buildx 0.6&#43; $ docker buildx bake &#34;https://github.com/docker/buildx.git&#34; $ mkdir -p ~/.docker/cli-plugins $ mv ./bin/build/buildx ~/.docker/cli-plugins/docker-buildx # Docker 19.03&#43; $ DOCKER_BUILDKIT=1 docker build --platform=local -o . &#34;https://github.com/docker/buildx.git&#34; $ mkdir -p ~/.docker/cli-plugins $ mv buildx ~/.docker/cli-plugins/docker-buildx # Local $ git clone https://github.com/docker/buildx.git &amp;&amp; cd buildx $ make install 3."/>




<meta property="article:published_time" content="2023-02-14 05:22:28 &#43;0000 UTC" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/st0n3</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/aboutme.html">About</a></li><li><a href="/post.html">Blog</a></li><li><a href="/hackerbot">Hackerbot</a></li><li><a href="/skill_tree/">SkillTree</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/docker%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1/%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E5%B9%B6%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81/How-to-Build-buildx.html">How to Build buildx</a></h2>

            

            <div class="post-content">
                <hr>
<h2 id="tags-containerbuildx">tags: container,buildx</h2>
<h1 id="how-to-build-buildx">How to Build buildx</h1>
<h2 id="1-buildx">1. Buildx</h2>
<p>buildx 是  docker 的一个插件，docker buildx 子命令会执行 buildx 二进制文件。本文分析如何自己编译 buildx 。</p>
<h2 id="2-standard-build">2. Standard Build</h2>
<p>官方文档提供了标准的编译方法：https://github.com/docker/buildx#building</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">Buildx</span> <span style="color:#ae81ff">0.6</span><span style="color:#f92672">+</span>
<span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">docker</span> <span style="color:#a6e22e">buildx</span> <span style="color:#a6e22e">bake</span> <span style="color:#e6db74">&#34;https://github.com/docker/buildx.git&#34;</span>
<span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">mkdir</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">p</span> <span style="color:#960050;background-color:#1e0010">~</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">docker</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cli</span><span style="color:#f92672">-</span><span style="color:#a6e22e">plugins</span>
<span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">mv</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">build</span><span style="color:#f92672">/</span><span style="color:#a6e22e">buildx</span> <span style="color:#960050;background-color:#1e0010">~</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">docker</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cli</span><span style="color:#f92672">-</span><span style="color:#a6e22e">plugins</span><span style="color:#f92672">/</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">-</span><span style="color:#a6e22e">buildx</span>

<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">Docker</span> <span style="color:#ae81ff">19.03</span><span style="color:#f92672">+</span>
<span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">DOCKER_BUILDKIT</span>=<span style="color:#ae81ff">1</span> <span style="color:#a6e22e">docker</span> <span style="color:#a6e22e">build</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">platform</span>=<span style="color:#a6e22e">local</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> . <span style="color:#e6db74">&#34;https://github.com/docker/buildx.git&#34;</span>
<span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">mkdir</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">p</span> <span style="color:#960050;background-color:#1e0010">~</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">docker</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cli</span><span style="color:#f92672">-</span><span style="color:#a6e22e">plugins</span>
<span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">mv</span> <span style="color:#a6e22e">buildx</span> <span style="color:#960050;background-color:#1e0010">~</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">docker</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cli</span><span style="color:#f92672">-</span><span style="color:#a6e22e">plugins</span><span style="color:#f92672">/</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">-</span><span style="color:#a6e22e">buildx</span>

<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">Local</span> 
<span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">git</span> <span style="color:#a6e22e">clone</span> <span style="color:#a6e22e">https</span>:<span style="color:#75715e">//github.com/docker/buildx.git &amp;&amp; cd buildx
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">make</span> <span style="color:#a6e22e">install</span>
</code></pre></div><h2 id="3-编译流程分析">3. 编译流程分析</h2>
<p>下面以 <code>make binaries</code>命令为入口，分析编译流程。</p>
<p>执行 docker buildx bake binaries 编译。</p>
<p><a href="https://github.com/docker/buildx/blob/v0.10.2/Makefile#L22-L24">https://github.com/docker/buildx/blob/v0.10.2/Makefile#L22-L24</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile"><span style="color:#960050;background-color:#1e0010">...</span>
<span style="color:#66d9ef">export </span>BUILDX_CMD <span style="color:#f92672">?=</span> docker buildx
<span style="color:#960050;background-color:#1e0010">...</span>
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> binaries
<span style="color:#a6e22e">binaries</span><span style="color:#f92672">:</span>
	<span style="color:#66d9ef">$(</span>BUILDX_CMD<span style="color:#66d9ef">)</span> bake binaries
<span style="color:#960050;background-color:#1e0010">...</span>
</code></pre></div><hr>
<p>bake的配置如下，设置目标为binaries阶段，编译后输出到 <code>./bin/build</code>目录。</p>
<p><a href="https://github.com/docker/buildx/blob/v0.10.2/docker-bake.hcl#L101-L106">https://github.com/docker/buildx/blob/v0.10.2/docker-bake.hcl#L101-L106</a></p>
<pre><code>...
variable &quot;DESTDIR&quot; {
  default = &quot;./bin&quot;
}
...
target &quot;binaries&quot; {
  inherits = [&quot;_common&quot;]
  target = &quot;binaries&quot;
  output = [&quot;${DESTDIR}/build&quot;]
  platforms = [&quot;local&quot;]
}
...
</code></pre><hr>
<p>在 buildx-build 阶段调用 <code>hack/build</code> 编译。</p>
<p><a href="https://github.com/docker/buildx/blob/v0.10.2/Dockerfile#L60">https://github.com/docker/buildx/blob/v0.10.2/Dockerfile#L60</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># syntax=docker/dockerfile-upstream:1.5.0</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> GO_VERSION<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>.19<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> XX_VERSION<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>.1.2<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> DOCKERD_VERSION<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>.10.14<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> docker:$DOCKERD_VERSION AS dockerd-release</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># xx is a helper for cross-compilation</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> --platform=$BUILDPLATFORM tonistiigi/xx:${XX_VERSION} AS xx</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> --platform=$BUILDPLATFORM golang:${GO_VERSION}-alpine AS golatest</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> golatest AS gobase</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>xx / /<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk add --no-cache file git<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> GOFLAGS<span style="color:#f92672">=</span>-mod<span style="color:#f92672">=</span>vendor<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> gobase AS buildx-version</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>bind,target<span style="color:#f92672">=</span>. &lt;&lt;EOT<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  set -e<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  mkdir /buildx-version<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  echo -n <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>./hack/git-meta version<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> | tee /buildx-version/version<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  echo -n <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>./hack/git-meta revision<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> | tee /buildx-version/revision<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>EOT<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> gobase AS buildx-build</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> TARGETPLATFORM<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>bind,target<span style="color:#f92672">=</span>. <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>cache,target<span style="color:#f92672">=</span>/root/.cache <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>cache,target<span style="color:#f92672">=</span>/go/pkg/mod <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --mount<span style="color:#f92672">=</span>type<span style="color:#f92672">=</span>bind,from<span style="color:#f92672">=</span>buildx-version,source<span style="color:#f92672">=</span>/buildx-version,target<span style="color:#f92672">=</span>/buildx-version &lt;&lt;EOT<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  set -e<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  xx-go --wrap<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  DESTDIR<span style="color:#f92672">=</span>/usr/bin VERSION<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cat /buildx-version/version<span style="color:#66d9ef">)</span> REVISION<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cat /buildx-version/revision<span style="color:#66d9ef">)</span> GO_EXTRA_LDFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-s -w&#34;</span> ./hack/build<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  xx-verify --static /usr/bin/docker-buildx<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>EOT<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>...<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> scratch AS binaries-unix</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --link --from<span style="color:#f92672">=</span>buildx-build /usr/bin/docker-buildx /buildx<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>...<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> binaries-unix AS binaries-linux</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>...<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> binaries-$TARGETOS AS binaries</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># enable scanning for this stage</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> BUILDKIT_SBOM_SCAN_STAGE<span style="color:#f92672">=</span>true

...<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><hr>
<p>hack/build 调用 <code>go build</code>。</p>
<p><a href="https://github.com/docker/buildx/blob/v0.10.2/hack/build">https://github.com/docker/buildx/blob/v0.10.2/hack/build</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#!/usr/bin/env sh
</span><span style="color:#75715e"></span>
set -e

: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DESTDIR=./bin/build<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PACKAGE=github.com/docker/buildx<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>VERSION=<span style="color:#66d9ef">$(</span>./hack/git-meta version<span style="color:#66d9ef">)</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>REVISION=<span style="color:#66d9ef">$(</span>./hack/git-meta revision<span style="color:#66d9ef">)</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CGO_ENABLED=0<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GO_PKG=github.com/docker/buildx<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GO_LDFLAGS=-X <span style="color:#e6db74">${</span>GO_PKG<span style="color:#e6db74">}</span>/version.Version=<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span> -X <span style="color:#e6db74">${</span>GO_PKG<span style="color:#e6db74">}</span>/version.Revision=<span style="color:#e6db74">${</span>REVISION<span style="color:#e6db74">}</span> -X <span style="color:#e6db74">${</span>GO_PKG<span style="color:#e6db74">}</span>/version.Package=<span style="color:#e6db74">${</span>PACKAGE<span style="color:#e6db74">}}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GO_EXTRA_LDFLAGS=<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

set -x
CGO_ENABLED<span style="color:#f92672">=</span>$CGO_ENABLED go build -mod vendor -trimpath -ldflags <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GO_LDFLAGS<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>GO_EXTRA_LDFLAGS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -o <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DESTDIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/docker-buildx&#34;</span> ./cmd/buildx
</code></pre></div><h2 id="4-custom">4. Custom</h2>
<p>最终的编译命令位于<code>hack/build</code>文件</p>
<p><a href="https://github.com/docker/buildx/blob/v0.10.2/hack/build#L16">https://github.com/docker/buildx/blob/v0.10.2/hack/build#L16</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#!/usr/bin/env sh
</span><span style="color:#75715e"></span>
set -e

: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DESTDIR=./bin/build<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PACKAGE=github.com/docker/buildx<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>VERSION=<span style="color:#66d9ef">$(</span>./hack/git-meta version<span style="color:#66d9ef">)</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>REVISION=<span style="color:#66d9ef">$(</span>./hack/git-meta revision<span style="color:#66d9ef">)</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CGO_ENABLED=0<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GO_PKG=github.com/docker/buildx<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GO_LDFLAGS=-X <span style="color:#e6db74">${</span>GO_PKG<span style="color:#e6db74">}</span>/version.Version=<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span> -X <span style="color:#e6db74">${</span>GO_PKG<span style="color:#e6db74">}</span>/version.Revision=<span style="color:#e6db74">${</span>REVISION<span style="color:#e6db74">}</span> -X <span style="color:#e6db74">${</span>GO_PKG<span style="color:#e6db74">}</span>/version.Package=<span style="color:#e6db74">${</span>PACKAGE<span style="color:#e6db74">}}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GO_EXTRA_LDFLAGS=<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

set -x
CGO_ENABLED<span style="color:#f92672">=</span>$CGO_ENABLED go build -mod vendor -trimpath -ldflags <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GO_LDFLAGS<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>GO_EXTRA_LDFLAGS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -o <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DESTDIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/docker-buildx&#34;</span> ./cmd/buildx
</code></pre></div><h2 id="5-远程调试">5. 远程调试</h2>
<p>关闭编译优化，内联，trimpath</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sed -i <span style="color:#e6db74">&#39;s/go build/go build -gcflags=&#34;all=-N -l&#34;/g&#39;</span> hack/build
$ sed -i <span style="color:#e6db74">&#39;s/${GO_EXTRA_LDFLAGS}//g&#39;</span> hack/build
$ sed -i <span style="color:#e6db74">&#39;s/-trimpath//g&#39;</span> hack/build
$ make binaries
docker buildx bake binaries
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Building 7.3s <span style="color:#f92672">(</span>21/21<span style="color:#f92672">)</span> FINISHED
...
 <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">=</span>&gt; copying files 76.04MB
$ ls -lah bin/build/buildx 
-rwxr-xr-x <span style="color:#ae81ff">1</span> root root 73M Feb <span style="color:#ae81ff">14</span> 12:52 bin/build/buildx
</code></pre></div>
            </div>
        </article>

        <hr />

        <div class="post-info">
  			</div>

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2023</span>
            
            <span></span>
            <span> <a href="/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/st0n3">st0n3</a></span>
            <span>Based on <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      extensions: ["tex2jax.js"],
      
      jax: ["input/TeX", "output/CommonHTML"],
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
      },
      "HTML-CSS": { fonts: ["TeX"] },
      displayAlign: "left"
    });
  </script>

<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_CHTML"></script>


</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.4c3fb12a087ceed4a52cb5d57068a9795c7069617a01ca70f788052ad66e1791779e6c72686e1dc0ca13dc03b0203204b6566bb0dd1ee80de2b7ff4d8fe53db2.js" integrity="sha512-TD&#43;xKgh87tSlLLXVcGipeVxwaWF6Acpw94gFKtZuF5F3nmxyaG4dwMoT3AOwIDIEtlZrsN0e6A3it/9Nj&#43;U9sg=="></script>



    </body>
</html>
