<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="">
<meta name="description"
    content="一、kube-proxy kube-proxy 是集群中每个节点上运行的网络代理,实现 Kubernetes Service 概念的一部分。kube-proxy 维护节点上的网络规则。这些网络规则允许从集群内部或外部的网络会话与 Pod 进行网络通信。如果操作系统提供了数据包过滤层并可用的话，kube-proxy会通过它来实现网络规则。否则，kube-proxy 仅转发流量本身。1
二、漏洞简介 1. 简介 2020年6月20日，kubernetes在issue2中公布了一个漏洞——CVE-2020-8558。kube-proxy默认设置net.ipv4.conf.all.route_localnet=1，这允许局域网内的主机或容器绕过localhost边界，访问其他主机或容器绑定在127网段(本地回还接口)的TCP/UDP服务。如果绑定在本地的服务无认证和流量加密机制，则会受本漏洞影响。特别的，如果开启了kubernetes的不安全(http,未启用证书)端口8080，则可能直接调用kubernetes的api。
2. 影响 2.1 CVSS评分 本漏洞官方给出了两个评分：
对于开启了kubernetes 8080端口的情况，CVSS3.1打分为8.8分，CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H。2
   维度 级别 理由     Attack Vector Adjacent 此漏洞由局域网发起，攻击其他主机   Attack Complexity Low 攻击复杂度低   Privileges Required None 此漏洞的必要条件是攻击者已在局域网内，因此不需要额外权限   User Interaction None 无需用户交互   Scope Unchanged 未更改权限体系   Confidentiality High 可以通过k8s api获取宿主机root权限，影响机密性高   Integrity High 可以通过k8s api获取宿主机root权限，影响机密性高   Availability High 可以通过k8s api获取宿主机root权限，影响可用性高    对于典型场景(未开启8080端口，不考虑宿主机其他绑定在本地的服务)，CVSS3." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E5%AE%B9%E5%99%A8%E9%9B%86%E7%BE%A4%E5%AE%89%E5%85%A8/k8s/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/kube-proxy_cve-2020-8558_%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AEroute_localnet%E5%85%81%E8%AE%B8%E9%82%BB%E8%BF%91%E4%B8%BB%E6%9C%BA%E7%BB%95%E8%BF%87localhost%E8%BE%B9%E7%95%8C.html" />


<title>
    
    kube-proxy CVE-2020-8558 默认设置route_localnet允许邻近主机绕过localhost边界 :: welcome to st0n3&#39;s blog 
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.de959d61dd13c2cd41136acd491ffb0749779e1afe37b1fed6d5cba0b7e1938d.css">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#252627"><meta itemprop="name" content="kube-proxy CVE-2020-8558 默认设置route_localnet允许邻近主机绕过localhost边界">
<meta itemprop="description" content="一、kube-proxy kube-proxy 是集群中每个节点上运行的网络代理,实现 Kubernetes Service 概念的一部分。kube-proxy 维护节点上的网络规则。这些网络规则允许从集群内部或外部的网络会话与 Pod 进行网络通信。如果操作系统提供了数据包过滤层并可用的话，kube-proxy会通过它来实现网络规则。否则，kube-proxy 仅转发流量本身。1
二、漏洞简介 1. 简介 2020年6月20日，kubernetes在issue2中公布了一个漏洞——CVE-2020-8558。kube-proxy默认设置net.ipv4.conf.all.route_localnet=1，这允许局域网内的主机或容器绕过localhost边界，访问其他主机或容器绑定在127网段(本地回还接口)的TCP/UDP服务。如果绑定在本地的服务无认证和流量加密机制，则会受本漏洞影响。特别的，如果开启了kubernetes的不安全(http,未启用证书)端口8080，则可能直接调用kubernetes的api。
2. 影响 2.1 CVSS评分 本漏洞官方给出了两个评分：
对于开启了kubernetes 8080端口的情况，CVSS3.1打分为8.8分，CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H。2
   维度 级别 理由     Attack Vector Adjacent 此漏洞由局域网发起，攻击其他主机   Attack Complexity Low 攻击复杂度低   Privileges Required None 此漏洞的必要条件是攻击者已在局域网内，因此不需要额外权限   User Interaction None 无需用户交互   Scope Unchanged 未更改权限体系   Confidentiality High 可以通过k8s api获取宿主机root权限，影响机密性高   Integrity High 可以通过k8s api获取宿主机root权限，影响机密性高   Availability High 可以通过k8s api获取宿主机root权限，影响可用性高    对于典型场景(未开启8080端口，不考虑宿主机其他绑定在本地的服务)，CVSS3.">
<meta itemprop="datePublished" content="2020-07-14T14:53:00&#43;08:00" />
<meta itemprop="dateModified" content="2020-07-14T14:53:00&#43;08:00" />
<meta itemprop="wordCount" content="195">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="kube-proxy CVE-2020-8558 默认设置route_localnet允许邻近主机绕过localhost边界"/>
<meta name="twitter:description" content="一、kube-proxy kube-proxy 是集群中每个节点上运行的网络代理,实现 Kubernetes Service 概念的一部分。kube-proxy 维护节点上的网络规则。这些网络规则允许从集群内部或外部的网络会话与 Pod 进行网络通信。如果操作系统提供了数据包过滤层并可用的话，kube-proxy会通过它来实现网络规则。否则，kube-proxy 仅转发流量本身。1
二、漏洞简介 1. 简介 2020年6月20日，kubernetes在issue2中公布了一个漏洞——CVE-2020-8558。kube-proxy默认设置net.ipv4.conf.all.route_localnet=1，这允许局域网内的主机或容器绕过localhost边界，访问其他主机或容器绑定在127网段(本地回还接口)的TCP/UDP服务。如果绑定在本地的服务无认证和流量加密机制，则会受本漏洞影响。特别的，如果开启了kubernetes的不安全(http,未启用证书)端口8080，则可能直接调用kubernetes的api。
2. 影响 2.1 CVSS评分 本漏洞官方给出了两个评分：
对于开启了kubernetes 8080端口的情况，CVSS3.1打分为8.8分，CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H。2
   维度 级别 理由     Attack Vector Adjacent 此漏洞由局域网发起，攻击其他主机   Attack Complexity Low 攻击复杂度低   Privileges Required None 此漏洞的必要条件是攻击者已在局域网内，因此不需要额外权限   User Interaction None 无需用户交互   Scope Unchanged 未更改权限体系   Confidentiality High 可以通过k8s api获取宿主机root权限，影响机密性高   Integrity High 可以通过k8s api获取宿主机root权限，影响机密性高   Availability High 可以通过k8s api获取宿主机root权限，影响可用性高    对于典型场景(未开启8080端口，不考虑宿主机其他绑定在本地的服务)，CVSS3."/>




<meta property="article:published_time" content="2020-07-14 14:53:00 &#43;0800 CST" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/st0n3</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/aboutme.html">About</a></li><li><a href="/post.html">Blog</a></li><li><a href="/hackerbot">Hackerbot</a></li><li><a href="/skill_tree">SkillTree</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E5%AE%B9%E5%99%A8%E9%9B%86%E7%BE%A4%E5%AE%89%E5%85%A8/k8s/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/kube-proxy_cve-2020-8558_%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AEroute_localnet%E5%85%81%E8%AE%B8%E9%82%BB%E8%BF%91%E4%B8%BB%E6%9C%BA%E7%BB%95%E8%BF%87localhost%E8%BE%B9%E7%95%8C.html">kube-proxy CVE-2020-8558 默认设置route_localnet允许邻近主机绕过localhost边界</a></h2>

            

            <div class="post-content">
                <h2 id="一kube-proxy">一、kube-proxy</h2>
<p>kube-proxy 是集群中每个节点上运行的网络代理,实现 Kubernetes <a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/" title="将运行在一组 Pods 上的应用程序公开为网络服务的抽象方法">Service</a> 概念的一部分。kube-proxy 维护节点上的网络规则。这些网络规则允许从集群内部或外部的网络会话与 Pod 进行网络通信。如果操作系统提供了数据包过滤层并可用的话，kube-proxy会通过它来实现网络规则。否则，kube-proxy 仅转发流量本身。<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<h2 id="二漏洞简介">二、漏洞简介</h2>
<h3 id="1-简介">1. 简介</h3>
<p>2020年6月20日，kubernetes在issue<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>中公布了一个漏洞——CVE-2020-8558。kube-proxy默认设置<code>net.ipv4.conf.all.route_localnet=1</code>，这允许局域网内的主机或容器绕过localhost边界，访问其他主机或容器绑定在127网段(本地回还接口)的TCP/UDP服务。如果绑定在本地的服务无认证和流量加密机制，则会受本漏洞影响。特别的，如果开启了kubernetes的不安全(http,未启用证书)端口8080，则可能直接调用kubernetes的api。</p>
<h3 id="2-影响">2. 影响</h3>
<h4 id="21-cvss评分">2.1 CVSS评分</h4>
<p>本漏洞官方给出了两个评分：</p>
<p>对于开启了kubernetes 8080端口的情况，CVSS3.1打分为8.8分，<a href="https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H">CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H</a>。<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
<table>
<thead>
<tr>
<th>维度</th>
<th>级别</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr>
<td>Attack Vector</td>
<td>Adjacent</td>
<td>此漏洞由局域网发起，攻击其他主机</td>
</tr>
<tr>
<td>Attack Complexity</td>
<td>Low</td>
<td>攻击复杂度低</td>
</tr>
<tr>
<td>Privileges Required</td>
<td>None</td>
<td>此漏洞的必要条件是攻击者已在局域网内，因此不需要额外权限</td>
</tr>
<tr>
<td>User Interaction</td>
<td>None</td>
<td>无需用户交互</td>
</tr>
<tr>
<td>Scope</td>
<td>Unchanged</td>
<td>未更改权限体系</td>
</tr>
<tr>
<td>Confidentiality</td>
<td>High</td>
<td>可以通过k8s api获取宿主机root权限，影响机密性高</td>
</tr>
<tr>
<td>Integrity</td>
<td>High</td>
<td>可以通过k8s api获取宿主机root权限，影响机密性高</td>
</tr>
<tr>
<td>Availability</td>
<td>High</td>
<td>可以通过k8s api获取宿主机root权限，影响可用性高</td>
</tr>
</tbody>
</table>
<p>对于典型场景(未开启8080端口，不考虑宿主机其他绑定在本地的服务)，CVSS3.1打分为5.4分，<a href="https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N">CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N</a>。<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
<p>对于对外提供服务的产品，Attack Vector可能提升至Network，影响性可能因本地开启的服务是否启用安全端口(ssl)而变化。</p>
<h4 id="22-受影响版本2">2.2 受影响版本<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></h4>
<ul>
<li>kubelet/kube-proxy v1.18.0-1.18.3</li>
<li>kubelet/kube-proxy v1.17.0-1.17.6</li>
<li>kubelet/kube-proxy &lt;=1.16.10</li>
</ul>
<h4 id="23-修复版本2">2.3 修复版本<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></h4>
<p>虽然这个问题是由 kube-proxy 引起的，但是当前的修复是在 kubelet 中(未来的版本可能会在 kube-proxy 中进行修复)。官方建议同时更新 kubelet 和 kube-proxy，以确保问题得到解决。</p>
<p>下面的版本包含了这个补丁:</p>
<ul>
<li>kubelet/kube-proxy master - 由 <a href="https://github.com/kubernetes/kubernetes/pull/91569">#91569</a> 修复</li>
<li>kubelet/kube-proxy v1.18.4+ - 由 <a href="https://github.com/kubernetes/kubernetes/pull/92038">#92038</a> 修复</li>
<li>kubelet/kube-proxy v1.17.7+ - 由 <a href="https://github.com/kubernetes/kubernetes/pull/92039">#92039</a> 修复</li>
<li>kubelet/kube-proxy v1.16.11+ - 由 <a href="https://github.com/kubernetes/kubernetes/pull/92040">#92040</a> 修复</li>
</ul>
<p>升级kubernetes可以参考: <a href="https://kubernetes.io/docs/tasks/administer-cluster/cluster-management/#upgrading-a-cluster">https://kubernetes.io/docs/tasks/administer-cluster/cluster-management/#upgrading-a-cluster</a></p>
<h3 id="3-应急措施">3. 应急措施</h3>
<h4 id="31-是否受影响">3.1 是否受影响</h4>
<ol>
<li>kubernetes或kube-proxy版本是否属于受影响版本</li>
<li>集群内存在不受信任的主机</li>
<li>集群内存在不受信任的且拥有CAP_NET_RAW权限(docker默认授予容器该权限)的容器</li>
<li>集群内主机或使用主机网络的pod或[容器(本文作者添加)]上监听在本地的端口无认证机制，[无流量加密机制(本文作者添加)]</li>
</ol>
<p>以上条件可以快速判断自己是否受影响。<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
<p>满足条件1则漏洞存在，满足条件2,3则可能被攻击，满足条件4则受攻击影响最大。</p>
<p>关于条件4,可以使用以下命令列出<strong>仅</strong>监听在本地的端口。<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
<ul>
<li>lsof +c 15 -P -n -i4TCP@127.0.0.1 -sTCP:LISTEN</li>
<li>lsof +c 15 -P -n -i4UDP@127.0.0.1</li>
</ul>
<p>因为通常大家认为绑定在127.0.0.1上的服务是无法被主机外设备访问的，因此该类服务未做认证和流量加密的可能性大，所以可以重点排查。（当然如果绑定在外部网卡或绑定在0.0.0.0上的服务也需要认证、加密，但是与此漏洞无关）。</p>
<p>严谨的说，绑定在127整个网段上的服务也是可能被攻击的，可以使用类似<code>lsof +c 15 -P -n -i4TCP -sTCP:LISTEN | grep 127</code>的命令列出。但这不是生产中的常见操作，可以忽略不计这种情况。</p>
<h4 id="32-消减措施2">3.2 消减措施<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></h4>
<p>如果无法及时升级，可以执行以下命令缓解。此规则将拒绝目的地址是本地地址但来源非本地地址的流量。</p>
<pre><code>iptables -I INPUT --dst 127.0.0.0/8 ! --src 127.0.0.0/8 -m conntrack ! --ctstate RELATED,ESTABLISHED,DNAT -j DROP
</code></pre><p>此外，官方也强烈建议在kubernetes api 服务的启动参数中建议增加&ndash;insecure-port=0，从而禁止不安全端口。</p>
<h2 id="三漏洞复现">三、漏洞复现</h2>
<h3 id="31-漏洞复现环境搭建">3.1 漏洞复现环境搭建</h3>
<p>本文使用vagrant管理环境，具体会使用到以下环境：</p>
<ul>
<li>debian10 with k8s1.18.3 <a href="https://app.vagrantup.com/fondement/boxes/k8s">https://app.vagrantup.com/fondement/boxes/k8s</a></li>
<li>纯净ubuntu18.04: <a href="https://app.vagrantup.com/hashicorp/boxes/bionic64">https://app.vagrantup.com/hashicorp/boxes/bionic64</a></li>
</ul>
<h3 id="32-典型场景复现">3.2 典型场景复现</h3>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a>
<a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">https://kubernetes.io/docs/tasks/tools/install-minikube/</a></p>
<h3 id="33-纯净操作系统未安装过k8s环境复现">3.3 纯净操作系统(未安装过k8s)环境复现</h3>
<ul>
<li>攻击路径
<ul>
<li>主机-&gt;容器</li>
</ul>
</li>
</ul>
<h2 id="todo">TODO</h2>
<h3 id="1-集群节点所在局域网内存在不受信任的主机">1. 集群节点所在局域网内存在不受信任的主机</h3>
<p>是否一定需要从集群内才能发起攻击</p>
<h3 id="2-从主机能否攻击容器">2. 从主机能否攻击容器</h3>
<h3 id="3-未加密流量嗅探">3. 未加密流量嗅探</h3>
<h3 id="4-是否需要认为127不再安全了">4. 是否需要认为127不再安全了</h3>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/issues/90259">关于kube-proxy设置route_localnet=1的issue</a></li>
</ul>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://kubernetes.io/zh/docs/concepts/overview/components/#kube-proxy">https://kubernetes.io/zh/docs/concepts/overview/components/#kube-proxy</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p><a href="https://github.com/kubernetes/kubernetes/issues/92315">https://github.com/kubernetes/kubernetes/issues/92315</a> <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

            </div>
        </article>

        <hr />

        <div class="post-info">
  			</div>

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
            <span></span>
            <span> <a href="/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/st0n3">st0n3</a></span>
            <span>Based on <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>

</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.4c3fb12a087ceed4a52cb5d57068a9795c7069617a01ca70f788052ad66e1791779e6c72686e1dc0ca13dc03b0203204b6566bb0dd1ee80de2b7ff4d8fe53db2.js" integrity="sha512-TD&#43;xKgh87tSlLLXVcGipeVxwaWF6Acpw94gFKtZuF5F3nmxyaG4dwMoT3AOwIDIEtlZrsN0e6A3it/9Nj&#43;U9sg=="></script>



    </body>
</html>
